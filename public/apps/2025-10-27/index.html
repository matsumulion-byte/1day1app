<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>松村ブックメーカー</title>
<style>
  :root{ --bg:#f5f2ea; --ink:#222; --acc:#b48b6a; --card:#fff; --bar:#111 }
  *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent }
  html,body{ height:100%; margin:0; background:var(--bg); color:var(--ink);
    font-family:"Yu Mincho","Hiragino Mincho ProN",serif; }
  .wrap{ min-height:100dvh; display:flex; flex-direction:column; }
  header{ padding:14px 16px; }
  h1{ margin:0; font-size:clamp(18px,4.8vw,26px); display:flex; align-items:center; gap:8px }
  .tag{ font-size:11px; padding:4px 8px; border-radius:999px; background:#eee; font-family:ui-sans-serif,system-ui,Roboto,sans-serif }

  .panel{ background:var(--card); border-radius:16px; box-shadow:0 6px 18px rgba(0,0,0,.08);
    padding:12px; margin:0 12px; }
  .fields{ display:grid; grid-template-columns:1fr; gap:10px }
  .field input{
    width:100%; font:inherit; font-size:16px; padding:12px 14px;
    border:1px solid #d8d8d8; border-radius:12px; background:#fff; color:#111;
  }
  .canvas-wrap{ flex:1; display:flex; align-items:center; justify-content:center; padding:10px 12px 92px }
  canvas{ width:min(92vw,520px); height:auto; border:1px solid #ddd; border-radius:12px; background:#fff; }

  /* 下部操作バー（SP用） */
  .dock{
    position:fixed; left:0; right:0; bottom:0; z-index:10;
    background:linear-gradient(180deg, rgba(245,242,234,0.0), rgba(245,242,234,1) 16px) , var(--bg);
    padding:10px 12px 12px; border-top:1px solid #e6e1d9;
  }
  .btns{ display:grid; grid-template-columns:1fr 1fr; gap:10px }
  .btn{
    appearance:none; border:none; border-radius:14px; padding:14px 16px; font-weight:800; font-size:16px; cursor:pointer;
    font-family:ui-sans-serif,system-ui,Roboto,"Hiragino Kaku Gothic ProN","Yu Gothic",sans-serif;
  }
  .btn.primary{ background:var(--acc); color:#fff }
  .btn.ghost{ background:#111; color:#fff; opacity:.9 }
  .note{ text-align:center; font-size:12px; color:#666; padding:6px 0 0 }

  /* PCでは横並びで少し余白広め */
  @media (min-width:900px){
    .panel{ max-width:980px; margin:0 auto 8px; }
    .canvas-wrap{ padding-bottom:110px }
    .btns{ max-width:980px; margin:0 auto; grid-template-columns:2fr 1fr }
  }

  /* クロスフェード用 */
  .fade-layer{ position:absolute; inset:0; pointer-events:none; opacity:0; transition:opacity .35s ease }
  .fade-layer.show{ opacity:1 }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>松村ブックメーカー</h1>
  </header>

  <div class="panel">
    <div class="fields">
      <label class="field"><input id="titleInput" placeholder="タイトル（空欄OK）"></label>
      <label class="field"><input id="authorInput" placeholder="著者名（空欄OK）"></label>
    </div>
    <div class="note" id="status">松村画像はプロジェクト内 assets から読み込みます（AI未使用）</div>
  </div>

  <div class="canvas-wrap">
    <div style="position:relative">
      <canvas id="bookCanvas" width="1024" height="1536" aria-label="book cover"></canvas>
      <canvas id="fadeCanvas" width="1024" height="1536" class="fade-layer"></canvas>
    </div>
  </div>

  <div class="dock">
    <div class="btns">
      <button id="btnGenerate" class="btn primary">ランダム生成</button>
      <button id="btnSave" class="btn ghost">保存</button>
    </div>
  </div>
</div>

<script type="module">
/* ============ セットアップ ============ */
const asset = (p)=> new URL(p, import.meta.url).toString();
const IMAGES = [
  './apps/2025-10-27/assets/matsu_01.jpg','./apps/2025-10-27/assets/matsu_02.jpg','./apps/2025-10-27/assets/matsu_03.jpg','./apps/2025-10-27/assets/matsu_04.jpg',
  './apps/2025-10-27/assets/matsu_05.jpg','./apps/2025-10-27/assets/matsu_06.jpg','./apps/2025-10-27/assets/matsu_07.jpg'
].map(src => asset(src));

const $ = (id)=>document.getElementById(id);
const canvas = $('bookCanvas'), ctx = canvas.getContext('2d', {alpha:false});
const fadeCanvas = $('fadeCanvas'), fctx = fadeCanvas.getContext('2d', {alpha:false});
const titleInput=$('titleInput'), authorInput=$('authorInput'), statusEl=$('status');
const btnGenerate=$('btnGenerate'), btnSave=$('btnSave');

const fontSerif = `"Yu Mincho","Hiragino Mincho ProN",serif`;
const fontSans = `ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Yu Gothic",sans-serif`;
const styles = ["literary","vintage","photo","modern"];

function setStatus(t){ statusEl.textContent = t; }
function pick(a){ return a[(Math.random()*a.length)|0]; }
function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

/* ============ 背景描画（cover） ============ */
function drawCoverImage(img, toCtx=ctx){
  const cw=toCtx.canvas.width, ch=toCtx.canvas.height;
  const iw=img.naturalWidth||img.width, ih=img.naturalHeight||img.height;
  const s=Math.max(cw/iw, ch/ih), sw=cw/s, sh=ch/s, sx=(iw-sw)/2, sy=(ih-sh)/2;
  toCtx.drawImage(img, sx, sy, sw, sh, 0, 0, cw, ch);
}

/* ============ 万華鏡エフェクト ============ */
/* 画像を正方形サンプルに整えてから、扇形スライスを交互反転で放射配置 */
function kaleidoscope(img, options={}){
  const k = options.sectors ?? (6 + (Math.random()*6|0));   // 6〜11枚あたり
  const rot = (Math.random()*Math.PI*2);                    // ランダム回転
  const zoom = 1.0 + Math.random()*0.35;                    // ちょいズーム

  const size = Math.max(canvas.width, canvas.height);
  const off = document.createElement('canvas'); off.width = off.height = size;
  const ox = off.getContext('2d');
  // 背景をまず敷く（cover）
  const iw=img.naturalWidth||img.width, ih=img.naturalHeight||img.height;
  const s=Math.max(size/iw, size/ih)*zoom, sw=size/s, sh=size/s, sx=(iw-sw)/2, sy=(ih-sh)/2;

  // 1) 基本スライスを用意（中心から扇形でクリップ）
  const slice = document.createElement('canvas'); slice.width = slice.height = size;
  const sxctx = slice.getContext('2d');
  const cx=size/2, cy=size/2;
  const sliceAngle = Math.PI*2 / k;

  // 基本スライスを描画（扇形クリップ）
  sxctx.save();
  sxctx.translate(cx, cy);
  sxctx.rotate(rot);
  sxctx.beginPath();
  sxctx.moveTo(0,0);
  sxctx.arc(0,0, size/2, -sliceAngle/2, sliceAngle/2);
  sxctx.closePath();
  sxctx.clip();
  // 画像を貼る
  sxctx.drawImage(img, sx, sy, sw, sh, -size/2, -size/2, size, size);
  sxctx.restore();

  // 2) スライスを放射状に敷き詰め。奇数スライスはミラーに。
  for(let i=0;i<k;i++){
    ox.save();
    ox.translate(cx, cy);
    ox.rotate(i*sliceAngle);
    if(i%2===1){ // ミラー
      ox.scale(1,-1);
    }
    ox.drawImage(slice, -cx, -cy);
    ox.restore();
  }

  // 3) 出力キャンバスにフィット（縦長へcover）
  ctx.drawImage(off, 0, 0, size, size, 0, 0, canvas.width, canvas.height);
}

/* ============ その他の“味付け”エフェクト ============ */
function effectGrain(amount=0.12, toCtx=ctx){
  const w=toCtx.canvas.width,h=toCtx.canvas.height;
  const id=toCtx.getImageData(0,0,w,h), d=id.data;
  for(let i=0;i<d.length;i+=4){
    const n=(Math.random()*2-1)*255*amount;
    d[i]=clamp(d[i]+n,0,255); d[i+1]=clamp(d[i+1]+n,0,255); d[i+2]=clamp(d[i+2]+n,0,255);
  }
  toCtx.putImageData(id,0,0);
}
function effectVignette(str=0.35, toCtx=ctx){
  const w=toCtx.canvas.width,h=toCtx.canvas.height,cx=w/2,cy=h/2,max=Math.hypot(cx,cy);
  const id=toCtx.getImageData(0,0,w,h), d=id.data;
  for(let y=0;y<h;y++){
    for(let x=0;x<w;x++){
      const i=(y*w+x)*4, v=1 - Math.pow(Math.hypot(x-cx,y-cy)/max, 1.8)*str;
      d[i]*=v; d[i+1]*=v; d[i+2]*=v;
    }
  }
  toCtx.putImageData(id,0,0);
}
function effectPaperFade(fade=0.12, toCtx=ctx){
  const w=toCtx.canvas.width,h=toCtx.canvas.height,id=toCtx.getImageData(0,0,w,h), d=id.data;
  for(let i=0;i<d.length;i+=4){
    d[i]=clamp(d[i]* (1 - fade*0.05) + 240*fade*0.05, 0,255);
    d[i+1]=clamp(d[i+1]*(1 - fade*0.05) + 240*fade*0.05, 0,255);
    d[i+2]=clamp(d[i+2]*(1 - fade*0.09) + 235*fade*0.09, 0,255);
  }
  toCtx.putImageData(id,0,0);
}

/* ============ タイポ（4スタイルからランダム） ============ */
function wrapCenter(text, x, y, maxW, lh, size, font, color="#111", toCtx=ctx){
  toCtx.font = `700 ${size}px ${font}`;
  toCtx.fillStyle = color; toCtx.textAlign="center";
  const chars=[...text]; let line="", lines=[];
  for(const ch of chars){
    const test=line+ch;
    if(toCtx.measureText(test).width>maxW && line!==""){ lines.push(line); line=ch; }
    else line=test;
  }
  if(line) lines.push(line);
  let yy=y;
  for(const L of lines){ toCtx.fillText(L, x, yy); yy+=lh; }
}
function typoset({title, author, style}, toCtx=ctx){
  const W=toCtx.canvas.width, H=toCtx.canvas.height;
  if(style==='literary'){
    toCtx.fillStyle="rgba(255,255,255,.22)"; toCtx.fillRect(20,20,W-40,H-40);
    wrapCenter(title||"無題", W/2, 540, W-200, 88, 78, fontSerif, "#111", toCtx);
    toCtx.font=`500 30px ${fontSerif}`; toCtx.fillStyle="#111"; toCtx.textAlign="center";
    toCtx.fillText(author||"", W/2, H-120);
  }else if(style==='vintage'){
    const h=220; toCtx.fillStyle="rgba(0,0,0,.28)"; toCtx.fillRect(0, H-h, W, h);
    wrapCenter(title||"無題", W/2, 520, W-180, 82, 72, fontSerif, "#fff", toCtx);
    toCtx.font=`600 30px ${fontSerif}`; toCtx.fillStyle="#fff"; toCtx.textAlign="center";
    toCtx.fillText(author||"", W/2, H-60);
  }else if(style==='photo'){
    toCtx.fillStyle="rgba(255,255,255,.6)"; toCtx.fillRect(80, 200, W-160, 140);
    wrapCenter(title||"無題", W/2, 300, W-160, 70, 62, fontSans, "#111", toCtx);
    toCtx.font=`500 28px ${fontSans}`; toCtx.fillStyle="#111"; toCtx.textAlign="center";
    toCtx.fillText(author||"", W/2, 420);
  }else{ // modern
    toCtx.fillStyle="rgba(255,255,255,.18)"; toCtx.fillRect(60, 460, W-120, 180);
    wrapCenter((title||"無題").toUpperCase(), W/2, 560, W-160, 80, 68, fontSans, "#111", toCtx);
    toCtx.font=`600 28px ${fontSans}`; toCtx.fillStyle="#111"; toCtx.textAlign="center";
    toCtx.fillText(author||"", W/2, H-64);
  }
  toCtx.strokeStyle="#0006"; toCtx.lineWidth=2; toCtx.strokeRect(24,24,W-48,H-48);
}

/* ============ 生成ルーチン ============ */
function crossfadeFrom(bufferDrawer){
  // 今の絵をfadeCanvasへコピーしてフェードさせる
  fctx.drawImage(canvas, 0,0);
  fadeCanvas.classList.remove('show'); // reset
  void fadeCanvas.offsetWidth; // reflow
  fadeCanvas.classList.add('show');    // fade in old
  // 新規描画（メインに先に描く）
  bufferDrawer();
  // 少し待ってからフェードアウト
  setTimeout(()=> fadeCanvas.classList.remove('show'), 350);
}

function generate(){
  const title = titleInput.value.trim();
  const author = authorInput.value.trim();
  const style = pick(styles);
  const src = pick(IMAGES);
  const img = new Image(); img.src = src;

  img.onload = ()=>{
    crossfadeFrom(()=>{
      // 背景（万華鏡 or 通常+味付け）をランダム選択
      ctx.fillStyle="#fff"; ctx.fillRect(0,0,canvas.width,canvas.height);
      const useKaleido = Math.random() < 0.7; // 7割くらいで万華鏡
      if(useKaleido){
        kaleidoscope(img);
        // 万華鏡は少し紙感＆周辺減光で締める
        effectPaperFade(0.08);
        effectVignette(0.28);
      }else{
        drawCoverImage(img);
        // ライトな味付けを2つくらいランダム適用
        const fx = [()=>effectGrain(0.08), ()=>effectVignette(0.25), ()=>effectPaperFade(0.12)];
        pick(fx)(); pick(fx)();
      }

      // タイポ
      typoset({ title, author, style });

      setStatus(`画像:${src.split('/').pop()} / スタイル:${style} / 万華鏡:${useKaleido?"ON":"OFF"}`);
    });
  };
  img.onerror = ()=>{
    ctx.fillStyle="#ece7dc"; ctx.fillRect(0,0,canvas.width,canvas.height);
    typoset({ title, author, style:"literary" });
    setStatus("画像読み込み失敗：/assets の配置を確認してください");
  };
}

/* ============ ボタン類 ============ */
btnGenerate.addEventListener('click', generate);
btnSave.addEventListener('click', ()=>{
  const a=document.createElement('a'); a.download='matsumura_cover.png';
  a.href = canvas.toDataURL('image/png'); a.click();
});

/* 初期生成 */
generate();
</script>
</body>
</html>
