<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>松村ブックメーカー｜AI表紙版</title>
<style>
  :root{ --bg:#f4efe6; --ink:#222; --acc:#b48b6a; --card:#fff }
  *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent }
  html,body{ height:100%; margin:0; background:var(--bg); color:var(--ink);
    font-family:"Yu Mincho","Hiragino Mincho ProN",serif; }
  .wrap{ min-height:100%; display:flex; flex-direction:column; gap:14px; padding:14px }
  h1{ margin:0; font-size:clamp(18px,3.6vw,26px) }
  .panel{ width:100%; max-width:920px; margin:0 auto; background:var(--card);
    border:1px solid #e2e2e2; border-radius:14px; padding:14px; box-shadow:0 6px 18px rgba(0,0,0,.06) }
  .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:14px }
  @media (max-width:860px){ .grid{ grid-template-columns:1fr } }
  .controls{ display:grid; gap:10px }
  input, select{
    width:100%; font:inherit; font-size:16px; padding:10px 12px;
    border:1px solid #cfcfcf; border-radius:10px; background:#fff; color:#111;
  }
  .row{ display:flex; gap:8px; flex-wrap:wrap }
  button{
    font:inherit; font-weight:700; font-size:15px; border:none; border-radius:10px;
    background:var(--acc); color:#fff; padding:11px 14px; cursor:pointer;
  }
  .ghost{ background:#eee; color:#222; font-weight:600 }
  .canvas-wrap{ display:flex; justify-content:center; align-items:center }
  canvas{ width:min(92vw,520px); height:auto; border:1px solid #ddd; border-radius:12px; background:#fff; touch-action:manipulation }
  .note{ font-size:12px; color:#666; white-space:pre-wrap }
</style>
</head>
<body>
<div class="wrap">
  <h1>松村ブックメーカー <small style="font-size:.8em; color:#666">AI表紙</small></h1>

  <div class="panel">
    <div class="grid">
      <div class="controls">
        <input id="titleInput" placeholder="タイトル（例：走れ松村）" autocomplete="off" />
        <input id="authorInput" placeholder="著者名（例：松村ひろのり）" value="松村ひろのり" />
        <div class="row">
          <select id="styleSel" title="装丁スタイル">
            <option value="literary">文学ミニマル</option>
            <option value="vintage">ビンテージ質感</option>
            <option value="photo">写真エッセイ</option>
            <option value="modern">モダングラフィック</option>
          </select>
          <button id="btnGenerate">生成</button>
          <button id="btnSave" class="ghost">PNG保存</button>
          <button id="btnShare" class="ghost">この設定のURLをコピー</button>
        </div>
        <div class="note">※ 背景は生成AIで作成。文字はCanvasで高解像度組版します。</div>
        <div id="status" class="note"></div>
      </div>

      <div class="canvas-wrap">
        <canvas id="bookCanvas" width="1024" height="1536" aria-label="book cover"></canvas>
      </div>
    </div>
  </div>
</div>

<script type="module">
  const $ = (id)=>document.getElementById(id);
  const canvas = $('bookCanvas'); const ctx = canvas.getContext('2d', { alpha:false });
  const titleInput=$('titleInput'), authorInput=$('authorInput'), styleSel=$('styleSel');
  const btnGenerate=$('btnGenerate'), btnSave=$('btnSave'), btnShare=$('btnShare'), statusEl=$('status');

  const fontSerif = `"Yu Mincho","Hiragino Mincho ProN",serif`;
  const fontSans = `ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Yu Gothic",sans-serif`;

  function setStatus(msg){ statusEl.textContent = msg||""; }
  function drawBase(bgImg){
    ctx.fillStyle="#fff"; ctx.fillRect(0,0,canvas.width,canvas.height);
    if(bgImg){ ctx.drawImage(bgImg,0,0,canvas.width,canvas.height); }
    ctx.strokeStyle="#0006"; ctx.lineWidth=2;
    ctx.strokeRect(24,24,canvas.width-48,canvas.height-48);
  }
  function wrapCenter(text, x, y, maxW, lh, size, font, color="#111"){
    ctx.font = `700 ${size}px ${font}`;
    ctx.fillStyle = color; ctx.textAlign="center";
    const chars = [...text];
    let line="", lines=[];
    for(const ch of chars){
      const test=line+ch;
      if(ctx.measureText(test).width>maxW && line!==""){ lines.push(line); line=ch; }
      else line=test;
    }
    if(line) lines.push(line);
    let yy=y;
    for(const L of lines){ ctx.fillText(L, x, yy); yy+=lh; }
  }
  function typoset({title, author, style}){
    if(style==='literary'){
      wrapCenter(title, canvas.width/2, 540, canvas.width-200, 88, 78, fontSerif, "#111");
      ctx.font=`500 30px ${fontSerif}`; ctx.fillStyle="#111"; ctx.textAlign="center";
      ctx.fillText(author, canvas.width/2, canvas.height-120);
    } else if(style==='vintage'){
      const h=220; ctx.fillStyle="rgba(0,0,0,.22)"; ctx.fillRect(0, canvas.height-h, canvas.width, h);
      wrapCenter(title, canvas.width/2, 520, canvas.width-180, 82, 72, fontSerif, "#111");
      ctx.font=`600 30px ${fontSerif}`; ctx.fillStyle="#fff"; ctx.textAlign="center";
      ctx.fillText(author, canvas.width/2, canvas.height-60);
    } else if(style==='photo'){
      wrapCenter(title, canvas.width/2, 300, canvas.width-160, 70, 62, fontSans, "#111");
      ctx.font=`500 28px ${fontSans}`; ctx.fillStyle="#111"; ctx.textAlign="center";
      ctx.fillText(author, canvas.width/2, 420);
    } else { // modern
      wrapCenter(title.toUpperCase(), canvas.width/2, 560, canvas.width-160, 80, 68, fontSans, "#111");
      ctx.font=`600 28px ${fontSans}`; ctx.fillStyle="#111"; ctx.textAlign="center";
      ctx.fillText(author, canvas.width/2, canvas.height-64);
    }
  }

  async function generate(){
    const title = titleInput.value.trim() || "無題";
    const author = authorInput.value.trim() || "作者不詳";
    const style = styleSel.value;

    setStatus("生成中…");
    btnGenerate.disabled = true;

    try{
      const res = await fetch("/api/cover", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ title, author, style })
      });

      const raw = await res.text();
      if(!res.ok){
        setStatus("APIエラー: " + raw.slice(0,160));
        btnGenerate.disabled = false;
        drawBase(null); typoset({ title, author, style });
        return;
      }

      let data;
      try { data = JSON.parse(raw); }
      catch(e){ setStatus("API応答の解析に失敗"); btnGenerate.disabled=false; drawBase(null); typoset({ title, author, style }); return; }

      const img = new Image();
      img.crossOrigin = "anonymous";
      img.onload = ()=>{
        drawBase(img);
        typoset({ title, author, style });
        setStatus("生成完了");
        btnGenerate.disabled = false;
      };
      img.onerror = ()=>{
        drawBase(null);
        typoset({ title, author, style });
        setStatus("画像読み込みに失敗。背景なしで組版しました。");
        btnGenerate.disabled = false;
      };
      // ★ b64が返ればb64優先（CORS汚染を避けPNG保存安定）／無ければURL使用
      img.src = data.b64 ? `data:image/png;base64,${data.b64}` : data.url;

    }catch(e){
      drawBase(null);
      typoset({ title, author, style });
      setStatus("通信に失敗しました。背景なしで組版しました。");
      btnGenerate.disabled = false;
    }
  }

  btnGenerate.addEventListener('click', generate);
  btnSave.addEventListener('click', ()=>{
    const a=document.createElement('a'); a.download='book_cover.png';
    a.href=canvas.toDataURL('image/png');
    a.click();
  });
  btnShare.addEventListener('click', ()=>{
    const u = new URL(location.href);
    u.searchParams.set('title', titleInput.value.trim());
    u.searchParams.set('author', authorInput.value.trim());
    u.searchParams.set('style', styleSel.value);
    navigator.clipboard.writeText(u.toString()).then(()=> alert("URLをコピーしました"));
  });

  // URL復元
  const params = new URLSearchParams(location.search);
  if(params.get('title')) titleInput.value = params.get('title');
  if(params.get('author')) authorInput.value = params.get('author');
  if(params.get('style')) styleSel.value = params.get('style');

  // 初期プレビュー（背景なし）
  (function(){ drawBase(null); typoset({ title:titleInput.value||"無題", author:authorInput.value||"作者不詳", style:styleSel.value }); })();
</script>
</body>
</html>
