<!doctype html>
<html lang="ja">
<head>
  <!-- OGP AUTO-GENERATED START (do not edit by hand) -->
  <meta property="og:title" content="å‰²ã‚Šå‹˜å¥‰è¡Œ">
  <meta name="twitter:title" content="å‰²ã‚Šå‹˜å¥‰è¡Œ">
  <meta property="og:description" content="å‰²ã‚Šå‹˜å¥‰è¡Œ ç·é¡ã¨äººæ•°ã‚’å…¥ã‚Œã‚‹ã ã‘ã€‚æ°—ã¾ãšã•ã¯å¥‰è¡ŒãŒè£ãã€‚ ç«¯æ•°å‡¦ç†: å‰ã„äººã«å¯„ã›ã‚‹ å…¥åŠ› åˆè¨ˆäººæ•°: 0äºº ç·é¡ Â¥ å‰²ã‚Šæ–¹ ä¸Šå¸ãƒ»éƒ¨ä¸‹ ç”·å¥³ ã‚«ã‚¹ã‚¿ãƒ  ãƒ•ãƒ©ãƒƒãƒˆ ç«¯æ•°ã®å¯„ã›å…ˆ å‰ã„äººã«å¯„ã›ã‚‹ è‹¥è€…ã«å„ªã—ã å¹¹äº‹ãŒèƒŒè² ã† å››æ¨äº”å…¥ ğŸ§® å¥‰è¡Œã«è£ã‹ã›ã‚‹ â†º ãƒªã‚»ãƒƒãƒˆ â€» äººæ•°">
  <meta name="twitter:description" content="å‰²ã‚Šå‹˜å¥‰è¡Œ ç·é¡ã¨äººæ•°ã‚’å…¥ã‚Œã‚‹ã ã‘ã€‚æ°—ã¾ãšã•ã¯å¥‰è¡ŒãŒè£ãã€‚ ç«¯æ•°å‡¦ç†: å‰ã„äººã«å¯„ã›ã‚‹ å…¥åŠ› åˆè¨ˆäººæ•°: 0äºº ç·é¡ Â¥ å‰²ã‚Šæ–¹ ä¸Šå¸ãƒ»éƒ¨ä¸‹ ç”·å¥³ ã‚«ã‚¹ã‚¿ãƒ  ãƒ•ãƒ©ãƒƒãƒˆ ç«¯æ•°ã®å¯„ã›å…ˆ å‰ã„äººã«å¯„ã›ã‚‹ è‹¥è€…ã«å„ªã—ã å¹¹äº‹ãŒèƒŒè² ã† å››æ¨äº”å…¥ ğŸ§® å¥‰è¡Œã«è£ã‹ã›ã‚‹ â†º ãƒªã‚»ãƒƒãƒˆ â€» äººæ•°">
  <meta property="og:image" content="/2025-12-19/assets/bugyo.png">
  <meta name="twitter:image" content="/2025-12-19/assets/bugyo.png">
  <meta property="og:url" content="/2025-12-19/">
  <meta property="og:type" content="website">
  <meta name="twitter:card" content="summary_large_image">
  <!-- OGP AUTO-GENERATED END -->

<meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
  <title>å‰²ã‚Šå‹˜å¥‰è¡Œ</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.09);
      --line: rgba(255,255,255,.14);
      --ink:#f3f6ff;
      --muted: rgba(243,246,255,.72);
      --accent:#7dd3fc;
      --good:#86efac;
      --warn:#fbbf24;
      --danger:#fb7185;
      --shadow: 0 18px 55px rgba(0,0,0,.45);
      --r: 18px;
    }

    *{ box-sizing:border-box; margin:0; padding:0; }
    html,body{ height:100%; }
    body{
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--ink);
      background:
        radial-gradient(1100px 700px at 20% -10%, rgba(125,211,252,.22), transparent 55%),
        radial-gradient(900px 700px at 110% 30%, rgba(251,113,133,.16), transparent 55%),
        radial-gradient(900px 600px at 40% 120%, rgba(134,239,172,.14), transparent 60%),
        linear-gradient(180deg, #050816, var(--bg));
      min-height: 100vh;
      display:flex;
      align-items:stretch;
      justify-content:center;
      padding: 16px 12px 22px;
    }

    .app{
      width:min(980px, 100%);
      display:flex;
      flex-direction:column;
      gap: 12px;
    }

    header{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap: 12px;
      padding: 6px 2px 0;
    }
    h1{
      font-size: 18px;
      letter-spacing:.02em;
      line-height:1.2;
    }
    .sub{
      font-size: 12px;
      color: var(--muted);
      margin-top: 6px;
    }
    .pill{
      display:flex;
      gap:8px;
      align-items:center;
      padding: 8px 10px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.04);
      border-radius: 999px;
      font-size: 12px;
      color: var(--muted);
      white-space:nowrap;
    }
    .pill b{ color: var(--ink); font-weight:700; }

    .grid{
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap: 12px;
      align-items: start;
    }

    .card{
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding: 12px 14px;
      background: rgba(255,255,255,.03);
      border-bottom: 1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }
    .card .hd h2{
      font-size: 13px;
      letter-spacing:.03em;
      color: var(--muted);
      font-weight: 700;
    }
    .card .bd{ padding: 14px; }

    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 12px;
    }
    label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    .field{
      border: 1px solid var(--line);
      background: rgba(255,255,255,.05);
      border-radius: 12px;
      padding: 10px 10px;
      display:flex;
      gap: 8px;
      align-items:center;
    }
    .field span{
      color: rgba(243,246,255,.55);
      font-size: 12px;
      min-width: 14px;
      text-align:center;
    }
    input, select{
      width:100%;
      border:0;
      outline:0;
      background: transparent;
      color: var(--ink);
      font-size: 16px;
    }
    input::placeholder{ color: rgba(243,246,255,.35); }

    .small{
      font-size: 12px;
      color: var(--muted);
      line-height:1.6;
    }

    .modes{
      display:flex;
      gap: 8px;
      flex-wrap:wrap;
      margin-top: 6px;
    }
    .chip{
      cursor:pointer;
      user-select:none;
      display:flex;
      align-items:center;
      gap: 8px;
      padding: 10px 12px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.04);
      border-radius: 999px;
      font-size: 13px;
      color: var(--muted);
      transition: .15s ease;
    }
    .chip[aria-checked="true"]{
      border-color: rgba(125,211,252,.65);
      background: rgba(125,211,252,.12);
      color: var(--ink);
    }

    .counts{
      display:flex;
      flex-direction:column;
      gap: 10px;
      margin-top: 12px;
    }

    .counter{
      border: 1px solid var(--line);
      background: rgba(255,255,255,.04);
      border-radius: 14px;
      padding: 10px 10px;
      display:grid;
      grid-template-columns: 1fr auto;
      gap: 8px;
      align-items:center;
    }
    .counter .meta{
      display:flex;
      flex-direction:column;
      gap: 2px;
      min-width:0;
    }
    .counter .name{
      display:flex;
      align-items:center;
      gap:8px;
      font-size: 14px;
      color: var(--ink);
      font-weight: 700;
    }
    .counter .hint{
      font-size: 12px;
      color: var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .ctrl{
      display:flex;
      align-items:center;
      gap: 8px;
    }
    .btnMini{
      width: 36px;
      height: 36px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--ink);
      font-size: 18px;
      display:grid;
      place-items:center;
      cursor:pointer;
      transition:.12s ease;
    }
    .btnMini:active{ transform: translateY(1px); }
    .num{
      min-width: 40px;
      text-align:center;
      font-variant-numeric: tabular-nums;
      font-size: 16px;
      color: var(--ink);
      opacity:.95;
    }

    .footerActions{
      display:flex;
      gap: 10px;
      margin-top: 14px;
      flex-wrap:wrap;
    }
    .btn{
      flex: 1 1 160px;
      border-radius: 14px;
      padding: 12px 12px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--ink);
      font-weight: 800;
      font-size: 14px;
      letter-spacing:.03em;
      cursor:pointer;
      transition:.15s ease;
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 8px;
      min-height: 44px;
    }
    .btn.primary{
      border-color: rgba(125,211,252,.6);
      background: rgba(125,211,252,.16);
    }
    .btn:active{ transform: translateY(1px); }
    .btn[disabled]{
      opacity:.55;
      cursor:not-allowed;
    }

    .resultTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      flex-wrap:wrap;
      margin-bottom: 10px;
    }
    .badge{
      border: 1px solid var(--line);
      background: rgba(255,255,255,.04);
      border-radius: 999px;
      padding: 8px 10px;
      font-size: 12px;
      color: var(--muted);
      display:flex;
      gap: 8px;
      align-items:center;
    }
    .badge b{ color: var(--ink); }

    .list{
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .item{
      border: 1px solid var(--line);
      background: rgba(255,255,255,.04);
      border-radius: 14px;
      padding: 10px 10px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
    }
    .item .left{
      display:flex;
      flex-direction:column;
      gap: 3px;
      min-width:0;
    }
    .item .role{
      font-size: 14px;
      font-weight: 900;
      color: var(--ink);
    }
    .item .desc{
      font-size: 12px;
      color: var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .yen{
      font-size: 16px;
      font-weight: 900;
      font-variant-numeric: tabular-nums;
      white-space:nowrap;
    }

    .note{
      margin-top: 10px;
      padding: 10px 10px;
      border-radius: 14px;
      background: rgba(255,255,255,.03);
      border: 1px dashed rgba(255,255,255,.18);
      color: var(--muted);
      font-size: 12px;
      line-height:1.6;
    }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 16px;
      transform: translateX(-50%);
      background: rgba(15, 23, 42, .92);
      color: var(--ink);
      border: 1px solid rgba(255,255,255,.14);
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 13px;
      box-shadow: 0 20px 60px rgba(0,0,0,.45);
      opacity: 0;
      pointer-events:none;
      transition: .2s ease;
      max-width: min(520px, calc(100% - 24px));
      text-align:center;
      z-index: 60;
    }
    .toast.show{ opacity: 1; }

    /* SP */
    @media (max-width: 860px){
      .grid{ grid-template-columns: 1fr; }
      header{ align-items:flex-start; flex-direction:column; }
      h1{ font-size: 17px; }
    }

    /* === Bugyo Modal (FIXED: no overlap, single scroll area) === */
    .modal{
      position: fixed;
      inset: 0;
      z-index: 50;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px 12px;
    }
    .modal.show{ display:flex; }

    .modal .backdrop{
      position:absolute;
      inset:0;
      background: rgba(0,0,0,.62);
      backdrop-filter: blur(8px);
    }

    .modal .panel{
      position: relative;
      width: min(680px, 100%);
      max-height: calc(100vh - 36px);
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.18);
      background:
        radial-gradient(900px 500px at 20% 0%, rgba(125,211,252,.18), transparent 60%),
        radial-gradient(800px 500px at 110% 30%, rgba(251,113,133,.14), transparent 60%),
        rgba(10, 14, 28, .78);
      box-shadow: 0 30px 120px rgba(0,0,0,.6);
      overflow: hidden;
      transform: translateY(10px) scale(.98);
      opacity: 0;
      transition: .18s ease;

      display:flex;
      flex-direction:column;
      min-height: 0;
    }
    .modal.show .panel{
      transform: translateY(0) scale(1);
      opacity: 1;
    }

    .modal .panelHd{
      flex: 0 0 auto;
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255,255,255,.12);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .modal .panelHd .ttl{
      font-size: 13px;
      color: rgba(243,246,255,.78);
      font-weight: 800;
      letter-spacing:.03em;
    }
    .modal .close{
      width: 40px;
      height: 40px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--ink);
      font-size: 18px;
      cursor:pointer;
    }
    .modal .close:active{ transform: translateY(1px); }

    /* scroll area */
    .modal .panelBd{
      flex: 1 1 auto;
      min-height: 0;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;

      padding: 16px;
      display:flex;
      flex-direction:column;
      gap: 12px;
    }

    /* footer (sticky) */
    .modal .panelFt{
      flex: 0 0 auto;
      border-top: 1px solid rgba(255,255,255,.12);
      padding: 12px 12px calc(12px + env(safe-area-inset-bottom));
      background: rgba(10, 14, 28, .72);
      backdrop-filter: blur(10px);
    }
    .modal .actions{
      display:flex;
      gap: 10px;
    }
    .modal .actions .btn{ flex: 1 1 auto; }

    .modal .bugyoBig{
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 8px 8px 2px;
    }
    .modal .bugyoBig img{
      width: min(320px, 70vw);
      max-height: 42vh;
      height: auto;
      filter: drop-shadow(0 24px 28px rgba(0,0,0,.45));
      object-fit: contain;
    }

    .modal .speech{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      border-radius: 18px;
      padding: 14px 14px;
    }
    .modal .speech .who{
      font-size: 12px;
      color: rgba(243,246,255,.7);
      margin-bottom: 6px;
      font-weight: 800;
    }
    .modal .speech .line{
      font-size: 16px;
      line-height: 1.6;
      font-weight: 900;
      white-space: pre-line;
    }

    .modalSummary{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }

    .modalList{
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>å‰²ã‚Šå‹˜å¥‰è¡Œ</h1>
        <div class="sub">ç·é¡ã¨äººæ•°ã‚’å…¥ã‚Œã‚‹ã ã‘ã€‚æ°—ã¾ãšã•ã¯å¥‰è¡ŒãŒè£ãã€‚</div>
      </div>
      <div class="pill"><span>ç«¯æ•°å‡¦ç†:</span> <b id="roundingLabel">å‰ã„äººã«å¯„ã›ã‚‹</b></div>
    </header>

    <div class="grid">
      <!-- INPUT -->
      <section class="card">
        <div class="hd">
          <h2>å…¥åŠ›</h2>
          <div class="small" id="totalCountHint">åˆè¨ˆäººæ•°: 0äºº</div>
        </div>
        <div class="bd">
          <div class="row">
            <div>
              <label for="total">ç·é¡</label>
              <div class="field">
                <span>Â¥</span>
                <input id="total" inputmode="numeric" placeholder="120000" />
              </div>
            </div>
            <div>
              <label for="mode">å‰²ã‚Šæ–¹</label>
              <div class="field">
                <select id="mode">
                  <option value="boss">ä¸Šå¸ãƒ»éƒ¨ä¸‹</option>
                  <option value="gender">ç”·å¥³</option>
                  <option value="custom">ã‚«ã‚¹ã‚¿ãƒ </option>
                  <option value="flat">ãƒ•ãƒ©ãƒƒãƒˆ</option>
                </select>
              </div>
            </div>
          </div>

          <label>ç«¯æ•°ã®å¯„ã›å…ˆ</label>
          <div class="modes" id="roundingGroup" role="radiogroup" aria-label="ç«¯æ•°ã®å¯„ã›å…ˆ">
            <div class="chip" data-round="high" role="radio" aria-checked="true">å‰ã„äººã«å¯„ã›ã‚‹</div>
            <div class="chip" data-round="low" role="radio" aria-checked="false">è‹¥è€…ã«å„ªã—ã</div>
            <div class="chip" data-round="host" role="radio" aria-checked="false">å¹¹äº‹ãŒèƒŒè² ã†</div>
            <div class="chip" data-round="none" role="radio" aria-checked="false">å››æ¨äº”å…¥</div>
          </div>

          <div class="counts" id="countsArea"></div>

          <div class="footerActions">
            <button class="btn primary" id="calcBtn">ğŸ§® å¥‰è¡Œã«è£ã‹ã›ã‚‹</button>
            <button class="btn" id="resetBtn">â†º ãƒªã‚»ãƒƒãƒˆ</button>
          </div>

          <div class="note">
            â€» äººæ•°ã¯ã€Œï¼‹/âˆ’ã€ã§èª¿æ•´ã€‚<br>
            â€» çµæœã¯100å††å˜ä½ã«ä¸¸ã‚ã¾ã™ï¼ˆå¿˜å¹´ä¼šä»•æ§˜ï¼‰ã€‚<br>
            â€» ç«¯æ•°ã¯å¥‰è¡Œã®è£å®šã«ã‚ˆã‚Šå¯„ã›ã‚‰ã‚Œã¾ã™ã€‚
          </div>
        </div>
      </section>

      <!-- RESULT -->
      <section class="card" id="resultCard">
        <div class="hd">
          <h2>çµæœ</h2>
          <div class="small" id="statusText">ã¾ã è£å®šã¯ä¸‹ã£ã¦ã„ã¾ã›ã‚“</div>
        </div>
        <div class="bd">
          <div class="resultTop">
            <!-- â˜…ç·é¡ãƒãƒƒã‚¸ã¯æ¶ˆã—ãŸã€‚åˆè¨ˆæ”¯æ‰•ã ã‘ -->
            <div class="badge">åˆè¨ˆæ”¯æ‰•: <b id="sumOut">â€”</b></div>
          </div>

          <div class="list" id="resultList"></div>

          <div class="footerActions" style="margin-top:12px">
            <button class="btn" id="copyBtn" disabled>ğŸ“‹ çµæœã‚’ã‚³ãƒ”ãƒ¼</button>
            <button class="btn" id="shareBtn" disabled>ğŸ“¨ å…±æœ‰ï¼ˆå¯¾å¿œç«¯æœ«ï¼‰</button>
          </div>

          <div class="note" id="detailNote">
            ã“ã“ã«ç«¯æ•°å‡¦ç†ã®èª¬æ˜ãŒå‡ºã¾ã™ã€‚
          </div>
        </div>
      </section>
    </div>
  </div>

  <div class="toast" id="toast">ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ</div>

  <!-- Bugyo Modal -->
  <div class="modal" id="bugyoModal" aria-hidden="true">
    <div class="backdrop" data-close></div>

    <div class="panel" role="dialog" aria-modal="true" aria-label="å‰²ã‚Šå‹˜å¥‰è¡Œã®è£å®š">
      <div class="panelHd">
        <div class="ttl">å‰²ã‚Šå‹˜å¥‰è¡Œã®è£å®š</div>
        <button class="close" type="button" id="bugyoClose" aria-label="é–‰ã˜ã‚‹">Ã—</button>
      </div>

      <!-- â˜…ã“ã“ã ã‘ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã™ã‚‹ -->
      <div class="panelBd">
        <div class="bugyoBig">
          <img id="bugyoModalImg" alt="å‰²ã‚Šå‹˜å¥‰è¡Œ" />
        </div>

        <div class="speech">
          <div class="who">å‰²ã‚Šå‹˜å¥‰è¡Œ</div>
          <div class="line" id="bugyoModalLine">â€¦</div>
        </div>

        <!-- â˜…ç·é¡ãƒãƒƒã‚¸ã¯æ¶ˆã™ã€‚åˆè¨ˆæ”¯æ‰•ã ã‘ -->
        <div class="modalSummary">
          <div class="badge">åˆè¨ˆæ”¯æ‰•: <b id="mSum">â€”</b></div>
        </div>

        <div class="modalList" id="mList"></div>

        <div class="note" id="mNote">â€”</div>
      </div>

      <!-- â˜…ãƒœã‚¿ãƒ³ã¯ä¸‹ã«å›ºå®šï¼ˆè¢«ã‚‰ãªã„ï¼‰ -->
      <div class="panelFt">
        <div class="actions">
          <button class="btn primary" type="button" id="bugyoOk">ã‚ˆã</button>
          <button class="btn" type="button" id="bugyoAgain">ã‚‚ã†ä¸€å›è¨€ã£ã¦</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    // Vercelç”¨ã®ãƒ‘ã‚¹è§£æ±ºï¼ˆ/YYYY-MM-DD/ ã‚’è‡ªå‹•èªè­˜ï¼‰
    const DATE_SEGMENT = (location.pathname.match(/\d{4}-\d{2}-\d{2}/) || [""])[0];
    const DATE_BASE = DATE_SEGMENT ? `/${DATE_SEGMENT}/` : "/";
    const asset = (p) => {
      const clean = String(p || "").replace(/^\.?\//, "");
      return `${DATE_BASE}${clean}`;
    };

    // === ASSET ===
    const BUGYO_SRC = asset("./assets/bugyo.png");

    // === STATE ===
    const state = {
      mode: "boss",
      rounding: "high", // high | low | host | none
      stepYen: 100,
    };

    // === PRESETS ===
    const presets = {
      boss: [
        { key: "boss",   label: "ä¸Šå¸",   weight: 1.5, hint: "å¤šã‚ã«å‡ºã—ãŒã¡" },
        { key: "senior", label: "å…ˆè¼©",   weight: 1.2, hint: "ã¡ã‚‡ã„å¤šã‚" },
        { key: "peer",   label: "åŒæœŸ",   weight: 1.0, hint: "åŸºæº–" },
        { key: "junior", label: "å¾Œè¼©",   weight: 0.8, hint: "å„ªã—ã•" },
      ],
      gender: [
        { key: "male",   label: "ç”·æ€§",   weight: 1.2, hint: "å¤šã‚" },
        { key: "female", label: "å¥³æ€§",   weight: 1.0, hint: "åŸºæº–" },
      ],
      custom: [
        { key: "host", label: "å¹¹äº‹",   weight: 1.3, hint: "èƒŒè² ã„ãŒã¡" },
        { key: "vip",  label: "VIP",    weight: 1.6, hint: "å‰ãã†" },
        { key: "norm", label: "ãµã¤ã†", weight: 1.0, hint: "åŸºæº–" },
        { key: "soft", label: "ãŠè²¡å¸ƒã‚„ã•ã—ã‚", weight: 0.7, hint: "å„ªé‡" },
      ],
      flat: [
        { key: "all", label: "äººæ•°", weight: 1.0, hint: "å…¨å“¡åŒé¡" },
      ],
    };

    // counts åˆæœŸ
    const counts = {};
    Object.keys(presets).forEach(m=>{
      counts[m] = {};
      presets[m].forEach(r => counts[m][r.key] = 0);
    });

    // åˆæœŸå€¤
    counts.boss.boss = 1; counts.boss.senior = 2; counts.boss.peer = 3; counts.boss.junior = 1;
    counts.gender.male = 3; counts.gender.female = 2;
    counts.custom.host = 1; counts.custom.vip = 1; counts.custom.norm = 3; counts.custom.soft = 1;
    counts.flat.all = 4;

    // === ELEMENTS ===
    const totalEl = document.getElementById("total");
    const modeEl = document.getElementById("mode");
    const countsArea = document.getElementById("countsArea");
    const totalCountHint = document.getElementById("totalCountHint");

    const roundingGroup = document.getElementById("roundingGroup");
    const roundingLabel = document.getElementById("roundingLabel");

    const calcBtn = document.getElementById("calcBtn");
    const resetBtn = document.getElementById("resetBtn");

    const statusText = document.getElementById("statusText");
    const sumOut = document.getElementById("sumOut");
    const resultList = document.getElementById("resultList");
    const detailNote = document.getElementById("detailNote");

    const copyBtn = document.getElementById("copyBtn");
    const shareBtn = document.getElementById("shareBtn");
    const toast = document.getElementById("toast");

    // Modal
    const bugyoModal = document.getElementById("bugyoModal");
    const bugyoModalImg = document.getElementById("bugyoModalImg");
    const bugyoModalLine = document.getElementById("bugyoModalLine");
    const bugyoClose = document.getElementById("bugyoClose");
    const bugyoOk = document.getElementById("bugyoOk");
    const bugyoAgain = document.getElementById("bugyoAgain");
    const mSum = document.getElementById("mSum");
    const mList = document.getElementById("mList");
    const mNote = document.getElementById("mNote");

    bugyoModalImg.src = BUGYO_SRC;

    // === UTILS ===
    const fmtYen = (n) => "Â¥" + Math.round(n).toLocaleString("ja-JP");
    const clamp = (v, a, b) => Math.max(a, Math.min(b, v));

    function parseYen(s){
      if(!s) return 0;
      const n = Number(String(s).replace(/[^\d]/g,""));
      return Number.isFinite(n) ? n : 0;
    }

    function showToast(msg){
      toast.textContent = msg;
      toast.classList.add("show");
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=>toast.classList.remove("show"), 1200);
    }

    function updateRoundingUI(){
      const map = { high:"å‰ã„äººã«å¯„ã›ã‚‹", low:"è‹¥è€…ã«å„ªã—ã", host:"å¹¹äº‹ãŒèƒŒè² ã†", none:"å››æ¨äº”å…¥" };
      roundingLabel.textContent = map[state.rounding] || "å‰ã„äººã«å¯„ã›ã‚‹";
      [...roundingGroup.querySelectorAll(".chip")].forEach(ch=>{
        const on = ch.dataset.round === state.rounding;
        ch.setAttribute("aria-checked", on ? "true" : "false");
      });
    }

    function totalPeople(mode){
      return presets[mode].reduce((sum,r)=> sum + (counts[mode][r.key]||0), 0);
    }

    function updateTotalCountHint(){
      const n = totalPeople(state.mode);
      totalCountHint.textContent = `åˆè¨ˆäººæ•°: ${n}äºº`;
    }

    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function ensureNonZeroCounts(mode){
      const roles = presets[mode];
      const sum = roles.reduce((s,r)=> s + (counts[mode]?.[r.key] || 0), 0);
      if (sum > 0) return;

      if(mode === "flat") counts.flat.all = 4;
      else if(mode === "gender"){ counts.gender.male = 3; counts.gender.female = 2; }
      else if(mode === "boss"){ counts.boss.boss = 1; counts.boss.senior = 2; counts.boss.peer = 3; counts.boss.junior = 1; }
      else if(mode === "custom"){ counts.custom.host = 1; counts.custom.vip = 1; counts.custom.norm = 3; counts.custom.soft = 1; }
    }

    function renderCounters(){
      countsArea.innerHTML = "";
      const mode = state.mode;
      const roles = presets[mode];

      roles.forEach(r=>{
        const wrap = document.createElement("div");
        wrap.className = "counter";
        wrap.innerHTML = `
          <div class="meta">
            <div class="name">${escapeHtml(r.label)} <span style="font-size:12px;color:rgba(243,246,255,.6);font-weight:800">Ã—${r.weight.toFixed(1)}</span></div>
            <div class="hint">${escapeHtml(r.hint)}</div>
          </div>
          <div class="ctrl">
            <button class="btnMini" type="button" data-act="dec" aria-label="${escapeHtml(r.label)} æ¸›ã‚‰ã™">âˆ’</button>
            <div class="num" data-num>${counts[mode][r.key]||0}</div>
            <button class="btnMini" type="button" data-act="inc" aria-label="${escapeHtml(r.label)} å¢—ã‚„ã™">ï¼‹</button>
          </div>
        `;
        const numEl = wrap.querySelector("[data-num]");
        const dec = wrap.querySelector('[data-act="dec"]');
        const inc = wrap.querySelector('[data-act="inc"]');

        dec.addEventListener("click", ()=>{
          counts[mode][r.key] = clamp((counts[mode][r.key]||0)-1, 0, 999);
          numEl.textContent = counts[mode][r.key];
          updateTotalCountHint();
        });
        inc.addEventListener("click", ()=>{
          counts[mode][r.key] = clamp((counts[mode][r.key]||0)+1, 0, 999);
          numEl.textContent = counts[mode][r.key];
          updateTotalCountHint();
        });

        countsArea.appendChild(wrap);
      });

      updateTotalCountHint();
    }

    // === BUGYO LINES ===
    function bugyoLineFor(mode, rounding){
      const base = [
        "æ­¤åº¦ã®å‹˜å®šã€ã—ã‹ã¨è¦‹å±Šã‘ãŸ",
        "ä¸æº€ã¯é…’ã§æµã™ãŒã‚ˆã„",
        "å¹´æœ«ã«ã¤ãã€æƒ…ã‘ã‚’åŠ å‘³ã—ãŸ",
        "è²¡å¸ƒã®åšã¿ã€è€ƒæ…®æ¸ˆã¿ã§ã‚ã‚‹",
        "ç•°è­°ã¯äºŒæ¬¡ä¼šã§å—ã‘ä»˜ã‘ã‚‹",
        "å®´ã®ç§©åºã¯ã€å‹˜å®šã‚ˆã‚Šå§‹ã¾ã‚‹",
        "ã“ã®å‰²ã‚Šæ–¹ã€ç©ºæ°—ã¯èª­ã‚ã¦ãŠã‚‹",
      ];

      const byMode = {
        boss: [
          "ä¸Šå¸ã¯å¤šã‚ã«ã€å¾Œè¼©ã¯æ§ãˆã‚ã§ã‚ã‚‹",
          "å…ˆè¼©ã¯å°‘ã—å¼µã‚Šåˆ‡ã‚‹ãŒã‚ˆã„",
          "åŒæœŸã¯å¹³ç­‰ã€å¾Œè¼©ã¯å®ˆã‚‹ã®ã ",
        ],
        gender: [
          "æ­¤åº¦ã¯ç”·å¥³ã®æŒ‰åˆ†ã€æ…é‡ã«è¡Œã£ãŸ",
          "å·®ã‚’ã¤ã‘ã‚‹ã‚‚ã‚ˆã—ã€è©±ã—åˆã„ã‚‚ã‚ˆã—",
          "ç¤¼ç¯€ã‚ã‚‹å‰²ã‚Šå‹˜ã€è¦‹äº‹ã§ã‚ã‚‹",
        ],
        custom: [
          "ã‚«ã‚¹ã‚¿ãƒ ã¯è‡ªç”±ã€‚ã‚†ãˆã«è²¬ä»»ã‚‚è‡ªç”±",
          "å¹¹äº‹ã®é­‚ã€ã—ã‹ã¨è¦‹ãˆãŸ",
          "VIPã®å­˜åœ¨æ„Ÿã€å‹˜å®šã«ã‚‚åæ˜ ã—ãŸ",
        ],
        flat: [
          "å…¨å“¡åŒé¡ã€æœ€ã‚‚æ‰ã‚ã¬é“ã§ã‚ã‚‹",
          "å¹³ç­‰ã¯æ­£ç¾©ã€‚ä»Šæ—¥ã¯ãã†ã„ã†æ—¥ã ",
        ],
      };

      const byRound = {
        high: "ç«¯æ•°ã¯ã€ã‚‚ã£ã¨ã‚‚ç«‹æ´¾ãã†ãªè€…ã«å¯„ã›ãŸ",
        low:  "ç«¯æ•°ã¯ã€è‹¥è€…ã®æœªæ¥ã®ãŸã‚ã«è»½ãã—ãŸ",
        host: "ç«¯æ•°ã¯ã€å¹¹äº‹ãŒèƒŒè² ã£ãŸï¼ˆå¼·ã„ï¼‰",
        none: "ç«¯æ•°ã¯ã€å››æ¨äº”å…¥ã§ç©ä¾¿ã«ã—ãŸ",
      };

      const pick = (arr)=> arr[Math.floor(Math.random()*arr.length)];
      const modeLines = byMode[mode] || [];
      const l1 = pick([...base, ...modeLines]);
      const l2 = byRound[rounding] || byRound.high;
      return `${l1}\n${l2}`;
    }

    // === MODAL OPEN/CLOSE ===
    function openBugyoModal(line){
      bugyoModalLine.textContent = line;
      bugyoModal.classList.add("show");
      bugyoModal.setAttribute("aria-hidden","false");
      document.body.style.overflow = "hidden";
    }
    function closeBugyoModal(){
      bugyoModal.classList.remove("show");
      bugyoModal.setAttribute("aria-hidden","true");
      document.body.style.overflow = "";
    }

    bugyoModal.addEventListener("click", (e)=>{
      if(e.target && e.target.hasAttribute("data-close")) closeBugyoModal();
    });
    bugyoClose.addEventListener("click", closeBugyoModal);
    bugyoOk.addEventListener("click", closeBugyoModal);
    window.addEventListener("keydown", (e)=>{
      if(e.key === "Escape" && bugyoModal.classList.contains("show")) closeBugyoModal();
    });

    // === CALC ===
    function pickAdjustTargetIndex(items, mode, rounding){
      const findKey = (key)=> items.findIndex(it=> it.key === key);
      if(rounding === "high"){
        if(mode === "boss") return Math.max(0, findKey("boss"));
        if(mode === "gender") return Math.max(0, findKey("male") >= 0 ? findKey("male") : 0);
        if(mode === "custom") return Math.max(0, findKey("vip") >= 0 ? findKey("vip") : 0);
        return 0;
      }
      if(rounding === "low"){
        if(mode === "boss") return Math.max(0, findKey("junior") >= 0 ? findKey("junior") : items.length-1);
        if(mode === "gender") return Math.max(0, findKey("female") >= 0 ? findKey("female") : items.length-1);
        if(mode === "custom") return Math.max(0, findKey("soft") >= 0 ? findKey("soft") : items.length-1);
        return items.length-1;
      }
      if(rounding === "host"){
        if(mode === "custom") return Math.max(0, findKey("host") >= 0 ? findKey("host") : 0);
        return 0;
      }
      return 0;
    }

    function applyDiffByStep(items, total, step, mode, rounding){
      let sum = items.reduce((s,it)=> s + it.total, 0);
      let diff = total - sum;

      const targetIdx = pickAdjustTargetIndex(items, mode, rounding);
      const order = [];

      items.forEach((it, idx)=> { if(it.count === 1) order.push(idx); });
      items.forEach((it, idx)=>{
        if(order.includes(idx)) return;
        if(step % it.count === 0) order.push(idx);
      });
      if(!order.includes(targetIdx)) order.push(targetIdx);
      items.forEach((_, idx)=>{ if(!order.includes(idx)) order.push(idx); });

      let guard = 9999;
      while(diff !== 0 && guard-- > 0){
        const sign = diff > 0 ? 1 : -1;
        let progressed = false;
        for(const idx of order){
          const it = items[idx];
          if(step % it.count !== 0) continue;
          const perDelta = (step / it.count) * sign;
          const newPer = it.per + perDelta;
          if(newPer < 0) continue;

          it.per = newPer;
          it.total = it.per * it.count;
          progressed = true;
          break;
        }
        if(!progressed) break;

        sum = items.reduce((s,it)=> s + it.total, 0);
        diff = total - sum;
        if(Math.abs(diff) < step) break;
      }
    }

    function buildRoundingNote(mode, rounding, total, sum){
      const mapMode = { boss:"ä¸Šå¸ãƒ»éƒ¨ä¸‹å‰²ã‚Š", gender:"ç”·å¥³å‰²ã‚Š", custom:"ã‚«ã‚¹ã‚¿ãƒ å‰²ã‚Š", flat:"ãƒ•ãƒ©ãƒƒãƒˆå‰²ã‚Š" };
      const mapRound = {
        high:"ç«¯æ•°ã¯ã€Œå‰ã„äººã€å´ã¸å¯„ã›ã¾ã—ãŸã€‚",
        low:"ç«¯æ•°ã¯ã€Œè‹¥è€…ã«å„ªã—ãã€å¯„ã›ã¾ã—ãŸã€‚",
        host:"ç«¯æ•°ã¯ã€Œå¹¹äº‹ãŒèƒŒè² ã†ã€è£å®šã¨ã—ã¾ã—ãŸã€‚",
        none:"ç«¯æ•°ã¯å››æ¨äº”å…¥ï¼ˆå…¨ä½“ã®ä¸¸ã‚ï¼‰ã¨ã—ã¾ã—ãŸã€‚"
      };
      const diff = total - sum;
      const diffText = diff === 0
        ? "åˆè¨ˆã¯ç·é¡ã¨ä¸€è‡´ã—ã¦ã„ã¾ã™ã€‚"
        : `åˆè¨ˆãŒç·é¡ã¨ ${Math.abs(diff).toLocaleString("ja-JP")}å†† ${diff>0?"ä¸è¶³":"è¶…é"}ã—ã¦ã„ã¾ã™ï¼ˆæœ€å¾Œã«å¥‰è¡ŒãŒèª¿æ•´ï¼‰ã€‚`;
      return `ã€${mapMode[mode]||""}ã€‘${mapRound[rounding]||""}\n${diffText}`;
    }

    function calc(){
      const total = parseYen(totalEl.value);
      const mode = state.mode;
      const roles = presets[mode];

      const people = totalPeople(mode);
      if(total <= 0){
        showToast("ç·é¡ã‚’å…¥åŠ›ã—ã¦ã­");
        return null;
      }
      if(people <= 0){
        showToast("äººæ•°ãŒ0äººã§ã™");
        return null;
      }

      let weightSum = 0;
      roles.forEach(r=>{
        const c = counts[mode][r.key]||0;
        weightSum += c * r.weight;
      });
      if(weightSum <= 0){
        showToast("é‡ã¿ãŒ0ã§ã™");
        return null;
      }

      const perPoint = total / weightSum;

      const items = [];
      roles.forEach(r=>{
        const c = counts[mode][r.key]||0;
        if(c <= 0) return;
        const raw = perPoint * r.weight;
        items.push({
          key: r.key,
          label: r.label,
          count: c,
          weight: r.weight,
          rawPer: raw,
          rawTotal: raw * c,
          per: 0,
          total: 0,
          hint: r.hint
        });
      });

      const step = state.stepYen;
      items.forEach(it=>{
        it.per = Math.round(it.rawPer / step) * step;
        it.total = it.per * it.count;
      });

      let sum = items.reduce((s,it)=> s + it.total, 0);
      let diff = total - sum;

      if(state.rounding !== "none"){
        if(Math.abs(diff) >= step){
          applyDiffByStep(items, total, step, mode, state.rounding);
        }
      }

      sum = items.reduce((s,it)=> s + it.total, 0);
      diff = total - sum;
      if(diff !== 0){
        const oneIdx = items.findIndex(it=> it.count === 1);
        const t = (oneIdx >= 0) ? oneIdx : pickAdjustTargetIndex(items, mode, state.rounding);
        items[t].total += diff;
        items[t].per = Math.round(items[t].total / items[t].count);
        sum = items.reduce((s,it)=> s + it.total, 0);
      }

      const note = buildRoundingNote(mode, state.rounding, total, sum);
      return { total, sum, mode, items, note };
    }

    function buildShareText(res){
      const lines = [];
      lines.push("ã€å‰²ã‚Šå‹˜å¥‰è¡Œã€‘");
      lines.push(`ç·é¡ ${fmtYen(res.total)}`);
      lines.push("");
      res.items.forEach(it=>{
        lines.push(`${it.label}ï¼ˆ${it.count}äººï¼‰: 1äºº ${fmtYen(it.per)} / åˆè¨ˆ ${fmtYen(it.total)}`);
      });
      lines.push("");
      lines.push(`åˆè¨ˆæ”¯æ‰• ${fmtYen(res.sum)}`);
      lines.push("");
      lines.push(res.note);
      return lines.join("\n");
    }

    function renderResult(res){
      statusText.textContent = "å¥‰è¡Œã®è£å®šãŒä¸‹ã‚Šã¾ã—ãŸ";
      sumOut.textContent = fmtYen(res.sum);

      resultList.innerHTML = "";
      res.items.forEach(it=>{
        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `
          <div class="left">
            <div class="role">${escapeHtml(it.label)} <span style="font-size:12px;color:rgba(243,246,255,.55);font-weight:900">Ã—${it.weight.toFixed(1)}</span></div>
            <div class="desc">${escapeHtml(it.hint)} / ${it.count}äºº / 1äººã‚ãŸã‚Š</div>
          </div>
          <div style="text-align:right">
            <div class="yen">${fmtYen(it.per)}</div>
            <div style="font-size:12px;color:rgba(243,246,255,.6);margin-top:2px">åˆè¨ˆ ${fmtYen(it.total)}</div>
          </div>
        `;
        resultList.appendChild(el);
      });

      detailNote.textContent = res.note;

      const shareText = buildShareText(res);
      copyBtn.disabled = false;
      shareBtn.disabled = false;
      copyBtn._shareText = shareText;
      shareBtn._shareText = shareText;
    }

    function renderModalResult(res){
      // â˜…ãƒ¢ãƒ¼ãƒ€ãƒ«ã¯åˆè¨ˆæ”¯æ‰•ã ã‘
      mSum.textContent = fmtYen(res.sum);
      mNote.textContent = res.note;

      mList.innerHTML = "";
      res.items.forEach(it=>{
        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `
          <div class="left">
            <div class="role">${escapeHtml(it.label)} <span style="font-size:12px;color:rgba(243,246,255,.55);font-weight:900">Ã—${it.weight.toFixed(1)}</span></div>
            <div class="desc">${escapeHtml(it.hint)} / ${it.count}äºº / 1äººã‚ãŸã‚Š</div>
          </div>
          <div style="text-align:right">
            <div class="yen">${fmtYen(it.per)}</div>
            <div style="font-size:12px;color:rgba(243,246,255,.6);margin-top:2px">åˆè¨ˆ ${fmtYen(it.total)}</div>
          </div>
        `;
        mList.appendChild(el);
      });
    }

    // === EVENTS ===
    modeEl.addEventListener("change", ()=>{
      state.mode = modeEl.value;
      ensureNonZeroCounts(state.mode);
      renderCounters();

      statusText.textContent = "ã¾ã è£å®šã¯ä¸‹ã£ã¦ã„ã¾ã›ã‚“";
      resultList.innerHTML = "";
      sumOut.textContent = "â€”";
      copyBtn.disabled = true;
      shareBtn.disabled = true;
      detailNote.textContent = "ã“ã“ã«ç«¯æ•°å‡¦ç†ã®èª¬æ˜ãŒå‡ºã¾ã™ã€‚";
    });

    roundingGroup.addEventListener("click", (e)=>{
      const chip = e.target.closest(".chip");
      if(!chip) return;
      state.rounding = chip.dataset.round;
      updateRoundingUI();
    });

    calcBtn.addEventListener("click", ()=>{
      const res = calc();
      if(!res) return;

      statusText.textContent = "å¥‰è¡Œã€ç®—ç›¤ã‚’ã¯ã˜ã„ã¦ãŠã‚Šã¾ã™â€¦";
      resultList.innerHTML = "";
      copyBtn.disabled = true;
      shareBtn.disabled = true;

      setTimeout(()=>{
        renderResult(res);

        const line = bugyoLineFor(res.mode, state.rounding);
        renderModalResult(res);
        openBugyoModal(line);
      }, 350);
    });

    resetBtn.addEventListener("click", ()=>{
      totalEl.value = "";
      Object.keys(presets).forEach(m=>{
        presets[m].forEach(r => counts[m][r.key] = 0);
      });

      counts.boss.boss = 1; counts.boss.senior = 2; counts.boss.peer = 3; counts.boss.junior = 1;
      counts.gender.male = 3; counts.gender.female = 2;
      counts.custom.host = 1; counts.custom.vip = 1; counts.custom.norm = 3; counts.custom.soft = 1;
      counts.flat.all = 4;

      state.mode = "boss";
      state.rounding = "high";
      modeEl.value = state.mode;
      updateRoundingUI();
      renderCounters();

      statusText.textContent = "ã¾ã è£å®šã¯ä¸‹ã£ã¦ã„ã¾ã›ã‚“";
      resultList.innerHTML = "";
      sumOut.textContent = "â€”";
      copyBtn.disabled = true;
      shareBtn.disabled = true;
      detailNote.textContent = "ã“ã“ã«ç«¯æ•°å‡¦ç†ã®èª¬æ˜ãŒå‡ºã¾ã™ã€‚";
      showToast("ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ");
    });

    copyBtn.addEventListener("click", async ()=>{
      try{
        await navigator.clipboard.writeText(copyBtn._shareText || "");
        showToast("çµæœã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
      }catch{
        const ta = document.createElement("textarea");
        ta.value = copyBtn._shareText || "";
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        ta.remove();
        showToast("çµæœã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
      }
    });

    shareBtn.addEventListener("click", async ()=>{
      const text = shareBtn._shareText || "";
      if(navigator.share){
        try{
          await navigator.share({ text });
        }catch{}
      }else{
        showToast("ã“ã®ç«¯æœ«ã¯å…±æœ‰ã«æœªå¯¾å¿œï¼ˆã‚³ãƒ”ãƒ¼ã—ã¦ã­ï¼‰");
      }
    });

    // Enterã§è¨ˆç®—
    totalEl.addEventListener("keydown", (e)=>{
      if(e.key === "Enter") calcBtn.click();
    });

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šã‚‚ã†ä¸€å›
    bugyoAgain.addEventListener("click", ()=>{
      const line = bugyoLineFor(state.mode, state.rounding);
      openBugyoModal(line);
    });

    // INIT
    state.mode = modeEl.value;
    ensureNonZeroCounts(state.mode);
    updateRoundingUI();
    renderCounters();
  </script>
</body>
</html>
