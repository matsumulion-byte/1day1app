<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no"
  />
  <title>ã‚¹ãƒšãƒ¼ã‚¹ãƒ‡ãƒ–ãƒªå›é¿ æ¾æ‘</title>

  <style>
    :root {
      --bg: #020617;
      --bg-soft: #020817;
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.16);
      --danger: #fb7185;
      --ink: #e5e7eb;
      --muted: #9ca3af;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont,
        "Segoe UI", sans-serif;
      background:
        radial-gradient(circle at 20% 0%, #0f172a 0, transparent 55%),
        radial-gradient(circle at 80% 100%, #020617 0, #000 65%);
      color: var(--ink);
      display: flex;
      align-items: stretch;
      justify-content: center;
      padding: 8px;
    }

    .app {
      width: 100%;
      max-width: 480px;
      margin: auto;
      background: linear-gradient(180deg, #020617, #020617 40%, #020617);
      border-radius: 24px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      box-shadow:
        0 18px 45px rgba(15, 23, 42, 0.9),
        0 0 0 1px rgba(15, 23, 42, 0.9);
        padding: 12px 12px 14px;
        position: relative;
      overflow: hidden;
    }

    .starfield {
      position: absolute;
      inset: 0;
      background-image:
        radial-gradient(1px 1px at 10% 20%, rgba(248, 250, 252, 0.7), transparent),
        radial-gradient(1px 1px at 80% 10%, rgba(248, 250, 252, 0.4), transparent),
        radial-gradient(1px 1px at 30% 70%, rgba(248, 250, 252, 0.6), transparent),
        radial-gradient(1.5px 1.5px at 60% 40%, rgba(248, 250, 252, 0.5), transparent),
        radial-gradient(1px 1px at 90% 80%, rgba(248, 250, 252, 0.5), transparent);
      opacity: 0.45;
      pointer-events: none;
      z-index: 0;
    }

    .chrome {
      position: relative;
      z-index: 1;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 12px;
    }

    .title-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .title-main {
      font-size: 16px;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--accent);
    }

    .title-sub {
      font-size: 11px;
      color: var(--muted);
    }

    .badge {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: radial-gradient(circle at 0 0, rgba(56, 189, 248, 0.3), transparent);
      display: flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }

    .badge-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 8px rgba(34, 197, 94, 0.9);
    }

    .panel {
      background: radial-gradient(circle at 50% 0%, #0b1120 0, #020617 60%);
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      padding: 8px 8px 10px;
      position: relative;
      overflow: hidden;
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 6px;
    }

    .panel-header span {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .panel-header strong {
      font-size: 12px;
      color: var(--ink);
    }

    .game-shell {
  position: relative;
  border-radius: 14px;
  overflow: hidden;
  border: 1px solid rgba(148, 163, 184, 0.7);
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
}


    canvas {
      display: block;
      width: 100%;
      height: auto;
      background: transparent;
    }

    .hud {
      position: absolute;
      inset: 8px 10px auto 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      color: var(--muted);
      pointer-events: none;
    }

    .hud-item {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 3px 6px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.75);
      backdrop-filter: blur(10px);
    }

    .hud-item strong {
      color: var(--ink);
      font-size: 11px;
    }

    .hud-separator {
      flex: 1;
    }

    .message {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 16px;
      pointer-events: none;
    }

    .message-inner {
      pointer-events: auto;
      max-width: 85%;
      margin: 0 auto;
      padding: 10px 12px;
      border-radius: 12px;
      background: radial-gradient(circle at 50% 0%, rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.96));
      border: 1px solid rgba(148, 163, 184, 0.8);
      box-shadow: 0 14px 30px rgba(15, 23, 42, 0.9);
    }

    .message-title {
      font-size: 15px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .message-text {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 10px;
    }

    .message-text strong {
      color: var(--ink);
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 7px 16px;
      border-radius: 999px;
      border: 0;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      cursor: pointer;
      background: radial-gradient(circle at 0 0, #38bdf8, #0369a1);
      color: #0b1120;
      box-shadow:
        0 0 0 1px rgba(8, 47, 73, 0.8),
        0 10px 18px rgba(15, 23, 42, 0.9);
      transition: transform 0.1s ease, box-shadow 0.1s ease, filter 0.1s ease;
    }

    .btn span.icon {
      font-size: 13px;
    }

    .btn:active {
      transform: translateY(1px);
      box-shadow:
        0 0 0 1px rgba(8, 47, 73, 0.8),
        0 5px 10px rgba(15, 23, 42, 0.8);
      filter: brightness(0.96);
    }

    .btn-subtle {
      background: rgba(15, 23, 42, 0.9);
      color: var(--muted);
      box-shadow:
        0 0 0 1px rgba(148, 163, 184, 0.6),
        0 10px 18px rgba(15, 23, 42, 0.9);
    }

    .btn-subtle:active {
      filter: brightness(1.1);
    }

    .controls {
      margin-top: 6px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      font-size: 11px;
      color: var(--muted);
    }

    .controls-kb {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }

    .keycap {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 18px;
      padding: 2px 4px;
      border-radius: 6px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: radial-gradient(circle at 50% 0%, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.9));
      font-size: 10px;
      color: var(--ink);
    }

    .controls-touch-label {
      font-size: 11px;
    }

    .thrust-controls {
      position: absolute;
      inset: auto 0 8px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 26px;
      pointer-events: none;
    }

    .thrust-btn {
      pointer-events: auto;
      width: 72px;
      height: 72px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.8);
      background:
        radial-gradient(circle at 30% 0%, rgba(56, 189, 248, 0.45), transparent 55%),
        radial-gradient(circle at 50% 80%, rgba(15, 23, 42, 1), #020617);
      box-shadow:
        0 0 0 1px rgba(15, 23, 42, 1),
        0 14px 30px rgba(15, 23, 42, 1);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--ink);
      font-size: 22px;
      opacity: 0.9;
      transition: transform 0.08s ease, box-shadow 0.08s ease, opacity 0.08s ease;
      user-select: none;
      -webkit-user-select: none;
      touch-action: none;
    }

    .thrust-btn span {
      transform: translateY(1px);
    }

    .thrust-btn.active {
      transform: translateY(2px);
      opacity: 1;
      box-shadow:
        0 0 0 1px rgba(56, 189, 248, 0.9),
        0 8px 18px rgba(15, 23, 42, 0.9),
        0 0 18px rgba(56, 189, 248, 0.7);
    }

    .thrust-label {
      pointer-events: none;
      font-size: 10px;
      color: var(--muted);
      text-align: center;
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      margin-bottom: 4px;
    }

    @media (min-width: 640px) {
      .app {
        padding: 20px;
      }
      .panel {
        padding: 12px 12px 14px;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="starfield"></div>

    <div class="chrome">
      <header>
        <div class="title-block">
          <div class="title-main">SPACE DEBRIS AVOIDANCE</div>
          <div class="title-sub">12/2 æ—¥æœ¬äººå®‡å®™é£›è¡Œè¨˜å¿µæ—¥ã‚¹ãƒšã‚·ãƒ£ãƒ«</div>
        </div>
        <div class="badge">
          <span class="badge-dot"></span>
          EVA MODE
        </div>
      </header>

      <div class="panel">
        <div class="panel-header">
          <span>è¨“ç·´ä»»å‹™ï¼š<strong>ã‚¹ãƒšãƒ¼ã‚¹ãƒ‡ãƒ–ãƒªã‚’å›é¿ã›ã‚ˆ</strong></span>
          <span>ARRIVAL IN <strong id="hud-time">27.0</strong>s</span>
        </div>

        <div class="game-shell">
          <div class="hud">
            <div class="hud-item">
              DEBRIS
              <strong id="hud-debris">0</strong>
            </div>
            <div class="hud-separator"></div>
            <div class="hud-item">
              STATUS
              <strong id="hud-status">OK</strong>
            </div>
          </div>

          <canvas id="game" width="360" height="560"></canvas>

          <div class="message" id="message-layer">
            <div class="message-inner" id="message-inner">
              <div class="message-title" id="message-title">ã‚¹ãƒšãƒ¼ã‚¹ãƒ‡ãƒ–ãƒªå›é¿è¨“ç·´</div>
              <div class="message-text" id="message-text">
                æ¾æ‘å®‡å®™é£›è¡Œå£«ã¯èˆ¹å¤–æ´»å‹•ï¼ˆEVAï¼‰ä¸­ã€‚<br />
                ä¸Šã‹ã‚‰é™ã£ã¦ãã‚‹<strong>ã‚¹ãƒšãƒ¼ã‚¹ãƒ‡ãƒ–ãƒª</strong>ã‚’é¿ã‘ãªãŒã‚‰ã€<br />
                <strong>åˆ°ç€ã¾ã§ç”Ÿãæ®‹ã‚Œ</strong>ã€‚<br /><br />
                ä¸€åº¦ã§ã‚‚ã¶ã¤ã‹ã‚‹ã¨ã‚¢ã‚¦ãƒˆã ã€‚
              </div>
              <button class="btn" id="btn-start">
                <span class="icon">ğŸš€</span>
                START
              </button>
            </div>
          </div>

          <div class="thrust-controls">
            <button class="thrust-btn" id="btn-left">
              <span>âŸµ</span>
            </button>
            <button class="thrust-btn" id="btn-right">
              <span>âŸ¶</span>
            </button>
            <div class="thrust-label">
              å·¦å³ã«å›é¿ï¼ˆã‚¿ãƒƒãƒ—ï¼‰ / PCã¯ â† â†’ ã‚­ãƒ¼
            </div>
          </div>
        </div>

        <div class="controls">
          <div class="controls-kb">
            <span>PCï¼š</span>
            <span class="keycap">â†</span>
            <span>ãƒ»</span>
            <span class="keycap">â†’</span>
            <span>ã§å·¦å³ã«å›é¿</span>
          </div>
          <div class="controls-touch-label">
            ã‚¹ãƒãƒ›ï¼šç”»é¢ä¸‹ã®å·¦å³ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã£ã±ãªã—ã§ç§»å‹•
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    // ============================
    // ã‚¢ã‚»ãƒƒãƒˆãƒ˜ãƒ«ãƒ‘ãƒ¼ï¼ˆVercelå¯¾å¿œï¼‰
    // ============================
    const DATE_SEGMENT = (location.pathname.match(/\d{4}-\d{2}-\d{2}/) || [""])[0];
    const DATE_BASE = DATE_SEGMENT ? `/${DATE_SEGMENT}/` : "/";
    const asset = (p = "") => {
      const clean = String(p).replace(/^\.?\//, "");
      return `${DATE_BASE}${clean}`;
    };

    // ç”»åƒãƒ»éŸ³å£°ã‚’è¶³ã™å ´åˆã¯ã“ã“ã«
    const ASSETS = {
      astronaut: asset("./assets/astronaut.png"), // ä½œã£ãŸå®‡å®™é£›è¡Œå£«ç”»åƒ
      bgm: asset("./assets/bgm.mp3"), 
      space: asset("./assets/space_bg.png"),
    };
    // BGM
const bgm = new Audio(ASSETS.bgm);
bgm.loop = true;
bgm.volume = 0.4; // å¥½ã¿ã§èª¿æ•´ï¼ˆ0ã€œ1ï¼‰


    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");

    // èƒŒæ™¯ç”»åƒã‚’å‹•çš„ã«è¨­å®š
    const gameShell = document.querySelector(".game-shell");
    if (gameShell) {
      gameShell.style.backgroundImage = `url("${ASSETS.space}")`;
    }

    const hudTime = document.getElementById("hud-time");
    const hudDebris = document.getElementById("hud-debris");
    const hudStatus = document.getElementById("hud-status");

    const messageLayer = document.getElementById("message-layer");
    const messageInner = document.getElementById("message-inner");
    const messageTitle = document.getElementById("message-title");
    const messageText = document.getElementById("message-text");
    const btnStart = document.getElementById("btn-start");

    const btnLeft = document.getElementById("btn-left");
    const btnRight = document.getElementById("btn-right");

    const WIDTH = canvas.width;
    const HEIGHT = canvas.height;

    // ã‚²ãƒ¼ãƒ è¨­å®š
    const GAME_DURATION = 27;      // ç”Ÿãæ®‹ã‚‹ç§’æ•°
    const ASTRO_RADIUS = 22;       // å½“ãŸã‚Šåˆ¤å®š
    const MOVE_ACCEL = 140;        // æ¨ªåŠ é€Ÿ
    const MAX_VX = 180;            // æœ€å¤§æ¨ªé€Ÿåº¦
    const FRICTION = 0.9;          // æ¸›é€Ÿ
    const SPAWN_INTERVAL = 0.85;   // ãƒ‡ãƒ–ãƒªå‡ºç¾é–“éš”ï¼ˆç§’ï¼‰

    let state = "ready";           // "ready" | "playing" | "success" | "fail"
    let astro;
    let timeLeft = GAME_DURATION;
    let debrisList = [];
    let spawnTimer = 0;

    const keys = {
      left: false,
      right: false,
    };

    const pointerState = {
      left: false,
      right: false,
    };

    const astronautImg = new Image();
    astronautImg.src = ASSETS.astronaut;

    function resetGame() {
      astro = {
        x: WIDTH / 2,
        y: HEIGHT - 110,
        vx: 0,
      };
      timeLeft = GAME_DURATION;
      debrisList = [];
      spawnTimer = 0;
      hudTime.textContent = GAME_DURATION.toFixed(1);
      hudDebris.textContent = "0";
      hudStatus.textContent = "OK";
    }

    function setState(next, options = {}) {
      state = next;

      if (next === "ready") {
        messageLayer.style.display = "flex";
        messageInner.style.opacity = "1";
        messageTitle.textContent = "ã‚¹ãƒšãƒ¼ã‚¹ãƒ‡ãƒ–ãƒªå›é¿è¨“ç·´";
        messageText.innerHTML =
          "æ¾æ‘å®‡å®™é£›è¡Œå£«ã¯èˆ¹å¤–æ´»å‹•ï¼ˆEVAï¼‰ä¸­ã€‚<br>" +
          "ä¸Šã‹ã‚‰é™ã£ã¦ãã‚‹<strong>ã‚¹ãƒšãƒ¼ã‚¹ãƒ‡ãƒ–ãƒª</strong>ã‚’é¿ã‘ãªãŒã‚‰ã€<br>" +
          "<strong>åˆ°ç€ã¾ã§ç”Ÿãæ®‹ã‚Œ</strong>ã€‚<br><br>" +
          "ä¸€åº¦ã§ã‚‚ã¶ã¤ã‹ã‚‹ã¨ã‚¢ã‚¦ãƒˆã ã€‚";
        btnStart.textContent = "START";
        hudStatus.textContent = "OK";
      } else if (next === "playing") {
        messageLayer.style.display = "none";
        hudStatus.textContent = "OK";
      } else if (next === "success") {
        bgm.pause();
        messageLayer.style.display = "flex";
        messageTitle.textContent = "åˆ°ç€ï¼";
        messageText.innerHTML =
          "ã‚¹ãƒšãƒ¼ã‚¹ãƒ‡ãƒ–ãƒªã‚’è¯éº—ã«å›é¿ã—ã¦ã€<br>" +
          "ç„¡äº‹ã«ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã¸åˆ°ç€ã—ãŸã€‚<br><br>" +
          "æ—¥æœ¬äººå®‡å®™é£›è¡Œå£«ãŸã¡ã‚‚<br>ã«ã£ã“ã‚Šã®æ“ç¸¦ãƒ†ã‚¯ã€‚";
        btnStart.textContent = "ã‚‚ã†ä¸€å›";
        hudStatus.textContent = "CLEAR";
      } else if (next === "fail") {
        bgm.pause();
        messageLayer.style.display = "flex";
        const reason = options.reason || "hit";
        if (reason === "hit") {
          messageTitle.textContent = "è¢«å¼¾â€¦";
          messageText.innerHTML =
            "ã‚¹ãƒšãƒ¼ã‚¹ãƒ‡ãƒ–ãƒªã«<strong>ç›´æ’ƒ</strong>ã—ã¦ã—ã¾ã£ãŸã€‚<br>" +
            "æ¬¡ã¯å°‘ã—æ—©ã‚ã«å‹•ãå‡ºã—ã¦ã€<br>" +
            "è»Œé“ã‚’èª­ã‚“ã§å›é¿ã—ã¦ã¿ã‚ˆã†ã€‚";
        } else if (reason === "out_of_bounds") {
          messageTitle.textContent = "è¦‹å¤±ã£ãŸâ€¦";
          messageText.innerHTML =
            "æ¾æ‘ãŒè¦–ç•Œã®å¤–ã«æµã•ã‚Œã¦ã—ã¾ã£ãŸã€‚<br>" +
            "æ…£æ€§ã‚’æ„è­˜ã—ã¦ã€ç”»é¢å†…ã«ã‚­ãƒ¼ãƒ—ã—ã‚ˆã†ã€‚";
        } else if (reason === "timeout") {
          messageTitle.textContent = "æ™‚é–“åˆ‡ã‚Œ";
          messageText.innerHTML =
            "åˆ°ç€äºˆå®šæ™‚é–“ã‚’éãã¦ã—ã¾ã£ãŸã€‚<br>" +
            "ãƒ‡ãƒ–ãƒªã«æ°—ã‚’å–ã‚‰ã‚Œã™ããªã„ã‚ˆã†ã«ã€<br>" +
            "å°‘ã—ã ã‘æ”»ã‚ã®å›é¿ã‚‚å¤§äº‹ã ã€‚";
        }
        btnStart.textContent = "ã‚‚ã†ä¸€å›";
        hudStatus.textContent = "FAIL";
      }
    }

    function spawnDebris() {
      const count = Math.random() < 0.6 ? 1 : 2; // ãŸã¾ã«2å€‹
      for (let i = 0; i < count; i++) {
        const radius = 10 + Math.random() * 14;
        const margin = 20;
        const x = margin + Math.random() * (WIDTH - margin * 2);
        const y = -radius - Math.random() * 40;
        const vy = 80 + Math.random() * 120;
        debrisList.push({
          x,
          y,
          vy,
          radius,
        });
      }
    }

    function update(dt) {
      if (state !== "playing") return;

      // æ®‹ã‚Šæ™‚é–“
      timeLeft -= dt;
      if (timeLeft <= 0) {
        timeLeft = 0;
        hudTime.textContent = "0.0";
        setState("success");
        return;
      }
      hudTime.textContent = timeLeft.toFixed(1);

      // å…¥åŠ›çŠ¶æ…‹
      const left = keys.left || pointerState.left;
      const right = keys.right || pointerState.right;

      if (left && !right) {
        astro.vx -= MOVE_ACCEL * dt;
      } else if (right && !left) {
        astro.vx += MOVE_ACCEL * dt;
      } else {
        // ä½•ã‚‚æŠ¼ã—ã¦ãªã„ã¨ãã¯æ¸›é€Ÿ
        astro.vx *= FRICTION;
      }

      // æ¨ªé€Ÿåº¦åˆ¶é™
      if (astro.vx > MAX_VX) astro.vx = MAX_VX;
      if (astro.vx < -MAX_VX) astro.vx = -MAX_VX;

      // ä½ç½®æ›´æ–°ï¼ˆæ¨ªæ–¹å‘ã®ã¿ï¼‰
      astro.x += astro.vx * dt;

      // ç”»é¢å¤–ã«å‡ºã™ããŸã‚‰å¤±æ•—
      if (astro.x < -60 || astro.x > WIDTH + 60) {
        setState("fail", { reason: "out_of_bounds" });
        return;
      }

      // ç”»é¢å†…ã«ã‚¯ãƒ©ãƒ³ãƒ—ï¼ˆå®Œå…¨ã«å¤–ã«å‡ºã‚‹å‰ã®è¦‹ãŸç›®ç”¨ï¼‰
      if (astro.x < ASTRO_RADIUS) astro.x = ASTRO_RADIUS;
      if (astro.x > WIDTH - ASTRO_RADIUS) astro.x = WIDTH - ASTRO_RADIUS;

      // ãƒ‡ãƒ–ãƒªç”Ÿæˆ
      spawnTimer += dt;
      if (spawnTimer >= SPAWN_INTERVAL) {
        spawnTimer = 0;
        spawnDebris();
      }

      // ãƒ‡ãƒ–ãƒªæ›´æ–°
      for (const d of debrisList) {
        d.y += d.vy * dt;
      }

      // ç”»é¢å¤–ã®ãƒ‡ãƒ–ãƒªã‚’å‰Šé™¤
      debrisList = debrisList.filter((d) => d.y < HEIGHT + d.radius + 10);
      hudDebris.textContent = debrisList.length.toString();

      // è¡çªåˆ¤å®š
      for (const d of debrisList) {
        const dx = astro.x - d.x;
        const dy = astro.y - d.y;
        const dist = Math.hypot(dx, dy);
        if (dist < ASTRO_RADIUS + d.radius) {
          setState("fail", { reason: "hit" });
          return;
        }
      }
    }

    function draw() {
      ctx.clearRect(0, 0, WIDTH, HEIGHT);      

// ä¸Šéƒ¨ãƒ‰ãƒƒã‚­ãƒ³ã‚°ã‚²ãƒ¼ãƒˆï¼ˆæ¨ªå¹…ã„ã£ã±ã„ã®ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
ctx.save();

// é€²æ— 0ã€œ1ï¼ˆ0 = ã‚²ãƒ¼ãƒ é–‹å§‹ / 1 = åˆ°ç€ã‚¿ã‚¤ãƒŸãƒ³ã‚°ï¼‰
const progressRaw = 1 - timeLeft / GAME_DURATION;
const progress = Math.min(1, Math.max(0, progressRaw));

// é–‹å§‹ä½ç½®ãƒ»çµ‚äº†ä½ç½®
const GATE_START_Y = 40;
const GATE_END_Y = astro.y - 60; // æ¾æ‘ã®å°‘ã—ä¸Šã¾ã§é™ã‚Šã¦ãã‚‹
const gateY = GATE_START_Y + (GATE_END_Y - GATE_START_Y) * progress;

const gateHeight = 28;

// ã‚²ãƒ¼ãƒˆæœ¬ä½“ï¼ˆæ¨ªå¹…ã„ã£ã±ã„ï¼‰
const gTop = gateY - gateHeight / 2;
const gBottom = gateY + gateHeight / 2;

const gradGate = ctx.createLinearGradient(0, gTop, 0, gBottom);
gradGate.addColorStop(0, "rgba(15,23,42,0.98)");
gradGate.addColorStop(1, "rgba(15,23,42,0.9)");

ctx.fillStyle = gradGate;
ctx.strokeStyle = "rgba(148,163,184,0.9)";
ctx.lineWidth = 2;
ctx.beginPath();
ctx.roundRect(0, gTop, WIDTH, gateHeight, 12);
ctx.fill();
ctx.stroke();

// ä¸­å¤®ã®ãƒ©ã‚¤ãƒ³ï¼ˆãƒ‰ãƒƒã‚­ãƒ³ã‚°ã‚¾ãƒ¼ãƒ³ã½ã„ãƒ‡ã‚£ãƒ†ãƒ¼ãƒ«ï¼‰
ctx.strokeStyle = "rgba(56,189,248,0.7)";
ctx.setLineDash([6, 4]);
ctx.lineWidth = 1.5;
ctx.beginPath();
ctx.moveTo(10, gateY);
ctx.lineTo(WIDTH - 10, gateY);
ctx.stroke();
ctx.setLineDash([]);

// ãƒ©ãƒ™ãƒ«
ctx.fillStyle = "rgba(248,250,252,0.9)";
ctx.font = "10px system-ui, -apple-system, BlinkMacSystemFont, sans-serif";
ctx.textAlign = "center";
ctx.textBaseline = "middle";
ctx.fillText("DOCKING ZONE", WIDTH / 2, gateY - gateHeight / 2 - 10);

ctx.restore();

      // ãƒ‡ãƒ–ãƒªæç”»
      for (const d of debrisList) {
        ctx.save();
        ctx.translate(d.x, d.y);
        ctx.fillStyle = "rgba(148,163,184,0.95)";
        ctx.strokeStyle = "rgba(15,23,42,0.9)";
        ctx.lineWidth = 1.2;
        ctx.beginPath();
        ctx.arc(0, 0, d.radius, 0, Math.PI * 2);
        ctx.fill();
        ctx.stroke();

        // ã¡ã‚‡ã£ã¨ã ã‘ãƒ‡ã‚£ãƒ†ãƒ¼ãƒ«
        ctx.strokeStyle = "rgba(15,23,42,0.6)";
        ctx.beginPath();
        ctx.moveTo(-d.radius / 2, -d.radius / 3);
        ctx.lineTo(d.radius / 3, d.radius / 2);
        ctx.stroke();
        ctx.restore();
      }

     // æ¾æ‘å®‡å®™é£›è¡Œå£«
ctx.save();
ctx.translate(astro.x, astro.y);

// æ¨ªé€Ÿåº¦ã§å°‘ã—å‚¾ã‘ã‚‹
const tilt = Math.max(-0.4, Math.min(0.4, -astro.vx / 200));
ctx.rotate(tilt);

const baseSize = 72; // ç”»åƒã®æœ€å¤§ã‚µã‚¤ã‚º
let drawW = baseSize;
let drawH = baseSize;

if (astronautImg.complete && astronautImg.naturalWidth > 0) {
  const img = astronautImg;
  const aspect = img.naturalWidth / img.naturalHeight;

  if (aspect >= 1) {
    // æ¨ªé•·ï¼šæ¨ªã‚’åŸºæº–
    drawW = baseSize;
    drawH = baseSize / aspect;
  } else {
    // ç¸¦é•·ï¼šç¸¦ã‚’åŸºæº–
    drawH = baseSize;
    drawW = baseSize * aspect;
  }

  ctx.drawImage(img, -drawW / 2, -drawH / 2, drawW, drawH);
} else {
  // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ä¸­ã®ä»®ã‚¢ã‚¤ã‚³ãƒ³
  drawW = drawH = baseSize * 0.7;
  ctx.fillStyle = "#e5e7eb";
  ctx.beginPath();
  ctx.arc(0, 0, ASTRO_RADIUS, 0, Math.PI * 2);
  ctx.fill();
  ctx.fillStyle = "#020617";
  ctx.beginPath();
  ctx.arc(0, 0, ASTRO_RADIUS * 0.6, 0, Math.PI * 2);
  ctx.fill();
}

// ã‚¹ãƒ©ã‚¹ã‚¿ãƒ¼ã®å™´å°„ï¼ˆå·¦å³ãƒœã‚¿ãƒ³ä¸­ã®ã¿ï¼‰
const leftActive = keys.left || pointerState.left;
const rightActive = keys.right || pointerState.right;

ctx.fillStyle = "rgba(56,189,248,0.9)";

// ç”»åƒã‚µã‚¤ã‚ºã«åˆã‚ã›ã¦ç‚ã®ä½ç½®ã‚’æ±ºã‚ã‚‹
const halfW = drawW / 2;
const flameY = drawH / 4;

if (leftActive) {
  ctx.beginPath();
  ctx.moveTo(-halfW + 6, flameY);
  ctx.lineTo(-halfW - 10, flameY + 6);
  ctx.lineTo(-halfW + 6, flameY + 12);
  ctx.closePath();
  ctx.fill();
}
if (rightActive) {
  ctx.beginPath();
  ctx.moveTo(halfW - 6, flameY);
  ctx.lineTo(halfW + 10, flameY + 6);
  ctx.lineTo(halfW - 6, flameY + 12);
  ctx.closePath();
  ctx.fill();
}

ctx.restore();

    }

    let lastTime = performance.now();

    function loop(now) {
      const dt = (now - lastTime) / 1000;
      lastTime = now;

      update(dt);
      draw();

      requestAnimationFrame(loop);
    }

    // ã‚­ãƒ¼æ“ä½œ
    window.addEventListener("keydown", (e) => {
      if (e.key === "ArrowLeft") {
        keys.left = true;
      } else if (e.key === "ArrowRight") {
        keys.right = true;
      } else if (e.key === " " && state !== "playing") {
        // ã‚¹ãƒšãƒ¼ã‚¹ã§ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ
        e.preventDefault();
        startGame();
      }
    });

    window.addEventListener("keyup", (e) => {
      if (e.key === "ArrowLeft") {
        keys.left = false;
      } else if (e.key === "ArrowRight") {
        keys.right = false;
      }
    });

    // ã‚¿ãƒƒãƒãƒ»ãƒã‚¦ã‚¹æ“ä½œï¼ˆå·¦å³ãƒœã‚¿ãƒ³ï¼‰
    function bindThrustButton(btn, side) {
      const downEvents = ["mousedown", "touchstart"];
      const upEvents = ["mouseup", "mouseleave", "touchend", "touchcancel"];

      downEvents.forEach((ev) => {
        btn.addEventListener(ev, (e) => {
          e.preventDefault();
          pointerState[side] = true;
          btn.classList.add("active");
        });
      });

      upEvents.forEach((ev) => {
        btn.addEventListener(ev, (e) => {
          e.preventDefault();
          pointerState[side] = false;
          btn.classList.remove("active");
        });
      });
    }

    bindThrustButton(btnLeft, "left");
    bindThrustButton(btnRight, "right");

    function startGame() {
      resetGame();
      setState("playing");
        // â† ã“ã“ã«è¿½åŠ 
  bgm.currentTime = 0;
  bgm.play().catch(() => {});
    }

    btnStart.addEventListener("click", () => {
      startGame();
    });

    // åˆæœŸçŠ¶æ…‹
    resetGame();
    setState("ready");
    requestAnimationFrame(loop);
  </script>
</body>
</html>
