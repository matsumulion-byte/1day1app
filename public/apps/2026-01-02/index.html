<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
  <title>初夢フィルター｜一富士 二鷹 三松村</title>
  <meta name="theme-color" content="#070a14" />
  <style>
    :root{
      --bg:#070a14;
      --ink:#f3f6ff;
      --muted:rgba(243,246,255,.72);
      --line:rgba(255,255,255,.14);
      --panel:rgba(255,255,255,.08);
      --good:#34d399;
      --r:18px;
    }
    *{box-sizing:border-box;margin:0;padding:0;-webkit-user-select:none;user-select:none;-webkit-touch-callout:none}
    html,body{height:100%;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Sans","Noto Sans JP",sans-serif;overflow:hidden}
    button{font:inherit}

    .app{
  height:100dvh;
  display:grid;
  grid-template-rows:auto 1fr auto;
  gap:12px;
  padding:14px;
  padding-bottom:calc(14px + env(safe-area-inset-bottom));
  max-width:980px;
  margin:0 auto;
}

@media (min-width: 900px){
  .app{
    max-width: 1100px;
    margin: 0 auto;
    grid-template-columns: 1fr 360px; /* 左：プレビュー / 右：操作 */
    grid-template-rows: auto 1fr;
    column-gap: 18px;
    align-items:start;
  }
  header{ grid-column: 1 / -1; }
  .stage{ grid-column: 1; }
  footer{ grid-column: 2; align-self:start; }
}


    header{
      display:flex;align-items:flex-end;justify-content:space-between;gap:10px;
    }
    .title{
      line-height:1.15;
    }
    .title h1{font-size:16px;font-weight:800;letter-spacing:.02em}
    .title p{margin-top:4px;font-size:12px;color:var(--muted)}
    .badge{
      font-size:12px;
      color:var(--muted);
      border:1px solid var(--line);
      padding:6px 10px;
      border-radius:999px;
      background:rgba(0,0,0,.18);
      white-space:nowrap;
    }

    .stage{
  position:relative;
  border-radius:var(--r);
  overflow:hidden;
  border:1px solid var(--line);
  background:#000;

  aspect-ratio: 9 / 16;
  width: min(92vw, 520px);
  margin: 0 auto;
}

@media (min-width: 900px){
  .stage{
    width: min(60vh * (9/16), 520px); /* 画面高さ基準で自然に */
    margin: 0;
  }
}


video, .result img{ object-fit: cover; }


    /* live camera */
    video{
      width:100%;
      height:100%;
      object-fit:cover;
      transform: scaleX(-1); /* 自撮りっぽく（好みで消してOK） */
    }

    /* result */
    .result{
      position:absolute; inset:0;
      display:none;
    }
    .result.show{display:block}
    .result img{
      width:100%; height:100%;
      object-fit:cover;
    }

    /* flash + text animation */
    .flash{
      position:absolute; inset:0;
      background:#fff;
      opacity:0;
      pointer-events:none;
    }
    .flash.on{animation:flash .25s ease-out}
    @keyframes flash{
      0%{opacity:0}
      30%{opacity:.9}
      100%{opacity:0}
    }

    .chant{
      position:absolute;
      left:50%; top:50%;
      transform:translate(-50%,-50%) scale(.98);
      padding:14px 16px;
      border-radius:14px;
      background:rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.16);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      text-align:center;
      opacity:0;
      pointer-events:none;
    }
    .chant.on{animation:chant 1.05s ease-out}
    @keyframes chant{
      0%{opacity:0; transform:translate(-50%,-50%) scale(.96)}
      15%{opacity:1}
      70%{opacity:1}
      100%{opacity:0; transform:translate(-50%,-50%) scale(1.02)}
    }
    .chant .main{
      font-size:20px;
      font-weight:900;
      letter-spacing:.08em;
      white-space:nowrap;
    }
    .chant .sub{
      margin-top:6px;
      font-size:12px;
      color:var(--muted);
    }
    footer{
  position:sticky;
  bottom:0;
  z-index:10;
  display:flex;
  gap:10px;
  flex-wrap:wrap;

  padding-top:10px;
  padding-bottom:calc(10px + env(safe-area-inset-bottom));
  background:linear-gradient(180deg, rgba(7,10,20,0) 0%, rgba(7,10,20,.92) 18%, rgba(7,10,20,1) 100%);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
}

@media (min-width: 900px){
  footer{
    flex-direction:column;
    flex-wrap:nowrap;
  }
  .btn{ width:100%; }
}

    .btn{
      flex:1 1 140px;
      display:flex;align-items:center;justify-content:center;
      gap:8px;
      padding:14px 14px;
      border-radius:14px;
      border:1px solid var(--line);
      background:var(--panel);
      color:var(--ink);
      cursor:pointer;
      min-height:48px;
    }
    .btn.primary{
      background:rgba(52,211,153,.16);
      border-color:rgba(52,211,153,.32);
    }
    .btn:disabled{
      opacity:.45;
      cursor:not-allowed;
    }
    .hint{
      width:100%;
      font-size:12px;
      color:var(--muted);
      line-height:1.5;
      padding:10px 12px;
      border-radius:14px;
      border:1px dashed rgba(255,255,255,.18);
      background:rgba(255,255,255,.04);
    }
    /* ---- standby（撮る前のめでたい画面） ---- */
.standby{
  position:absolute;
  inset:0;
  z-index:6;
  display:grid;
  place-items:center;
  overflow:hidden;

  /* 金×紺の縦グラデ */
  background:
    radial-gradient(
      120% 60% at 50% 100%,
      rgba(255,215,160,.35),
      rgba(0,0,0,0) 60%
    ),
    linear-gradient(
      180deg,
      #3a2a00 0%,
      #6b4a00 25%,
      #b58a00 55%,
      #2a1c00 100%
    );
}

.standby::before{
  content:"";
  position:absolute;
  inset:-20%;
  background:
    radial-gradient(
      circle at 50% 80%,
      rgba(255,255,255,.25),
      rgba(255,255,255,0) 60%
    );
  transform:rotate(-8deg);
}

.standby::after{
  content:"";
  position:absolute;
  inset:0;
  background:
    repeating-linear-gradient(
      45deg,
      rgba(255,255,255,.03) 0 2px,
      rgba(255,255,255,0) 2px 6px
    );
  mix-blend-mode:overlay;
}

.standby-inner{
  position:relative;
  text-align:center;
  padding:28px 22px;
  border-radius:18px;
  background:rgba(0,0,0,.45);
  border:1px solid rgba(255,255,255,.25);
  backdrop-filter: blur(6px);
}

.standby-title{
  font-size:20px;
  font-weight:900;
  letter-spacing:.12em;
  color:#fff;
}

.standby-sub{
  margin-top:10px;
  font-size:14px;
  letter-spacing:.18em;
  color:rgba(255,255,255,.85);
}

.standby-note{
  margin-top:18px;
  font-size:12px;
  color:rgba(255,255,255,.7);
}

/* カメラ起動後に消す */
.standby.hide{
  display:none;
}

.stage{
  min-height: 0;   /* これがないとgridで縮まらず詰む */
}
footer{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:10px;
}
.hint{ grid-column: 1 / -1; }


    /* hidden canvas */
    canvas{display:none}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="title">
        <h1>初夢フィルター</h1>
      </div>
      <div class="badge" id="status">カメラ準備中</div>
    </header>

    <main class="stage" id="stage">
        <div class="standby" id="standby">
            <div class="standby-inner">
              <div class="standby-title">初夢フィルター</div>
              <div class="standby-note">カメラ起動で撮影</div>
            </div>
          </div>
      <video id="video" playsinline muted></video>

      <div class="result" id="result">
        <img id="resultImg" alt="result" />
      </div>

      <div class="flash" id="flash"></div>
      <div class="chant" id="chant">
        <div class="main">一富士　二鷹　三松村</div>
        <div class="sub">縁起、よし。</div>
      </div>

      <canvas id="canvas"></canvas>
    </main>

    <footer>
      <button class="btn primary" id="btnStart">カメラ起動</button>
      <button class="btn primary" id="btnShot" disabled>撮る</button>
      <button class="btn" id="btnRetry" disabled>撮り直す</button>
      <button class="btn" id="btnSave" disabled>保存</button>
      <div class="hint" id="hint">
        iPhoneは「カメラ起動」を押して許可 → 「撮る」で合成 → 「保存」で画像を保存できます。
      </div>
    </footer>
  </div>

  <script type="module">
    // Vercel用のパス解決ヘルパー
    const DATE_SEGMENT = (location.pathname.match(/\d{4}-\d{2}-\d{2}/) || [""])[0];
    const DATE_BASE = DATE_SEGMENT ? `/${DATE_SEGMENT}/` : "/";
    const asset = (p) => {
      const clean = String(p || "").replace(/^\.?\//, "");
      return `${DATE_BASE}${clean}`;
    };
  
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d', { alpha: false });
  
    const statusEl = document.getElementById('status');
    const hintEl = document.getElementById('hint');
  
    const btnStart = document.getElementById('btnStart');
    const btnShot  = document.getElementById('btnShot');
    const btnRetry = document.getElementById('btnRetry');
    const btnSave  = document.getElementById('btnSave');
  
    const result = document.getElementById('result');
    const resultImg = document.getElementById('resultImg');
  
    const flash = document.getElementById('flash');
    const chant = document.getElementById('chant');
  
    let stream = null;
    let overlays = null; // {fuji, hawk, matsu}
    let lastBlobUrl = null;
  
    function setStatus(s){ statusEl.textContent = s; }
  
    function flashOnce(){
      flash.classList.remove('on');
      void flash.offsetWidth;
      flash.classList.add('on');
    }
    function chantOnce(){
      chant.classList.remove('on');
      void chant.offsetWidth;
      chant.classList.add('on');
    }
  
    function loadImage(src){
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.decoding = 'async';
        img.onload = () => resolve(img);
        img.onerror = reject;
        img.src = src;
      });
    }
  
    async function ensureOverlays(){
      if (overlays) return overlays;
      const [fuji, hawk, matsu] = await Promise.all([
        loadImage(asset('./assets/fuji.png')),
        loadImage(asset('./assets/hawk.png')),
        loadImage(asset('./assets/matsumura.png')),
      ]);
      overlays = { fuji, hawk, matsu };
      return overlays;
    }
  
    async function startCamera(){
      standby.classList.add('hide');
      try{
        setStatus('カメラ起動中…');
        await ensureOverlays();
  
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'user' },
          audio: false
        });
  
        video.srcObject = stream;
        await video.play();
  
        setStatus('準備OK');
        btnShot.disabled = false;
        btnRetry.disabled = true;
        btnSave.disabled = true;
        result.classList.remove('show');
      }catch(e){
        console.error(e);
        setStatus('カメラ不可');
        hintEl.textContent = 'カメラが起動できませんでした。ブラウザの権限設定をご確認ください。';
      }
    }
  
    // object-fit: cover 相当で video フレームを canvas に描く
    function drawCover(source, sx, sy, sw, sh, dx, dy, dw, dh){
      ctx.drawImage(source, sx, sy, sw, sh, dx, dy, dw, dh);
    }
  
    function computeCoverRect(srcW, srcH, dstW, dstH){
      const srcAspect = srcW / srcH;
      const dstAspect = dstW / dstH;
      let sx=0, sy=0, sw=srcW, sh=srcH;
  
      if (srcAspect > dstAspect){
        sh = srcH;
        sw = Math.round(srcH * dstAspect);
        sx = Math.round((srcW - sw) / 2);
        sy = 0;
      }else{
        sw = srcW;
        sh = Math.round(srcW / dstAspect);
        sx = 0;
        sy = Math.round((srcH - sh) / 2);
      }
      return { sx, sy, sw, sh };
    }
  
    function roundRect(x,y,w,h,r){
      const rr = Math.min(r, w/2, h/2);
      ctx.beginPath();
      ctx.moveTo(x+rr, y);
      ctx.arcTo(x+w, y, x+w, y+h, rr);
      ctx.arcTo(x+w, y+h, x, y+h, rr);
      ctx.arcTo(x, y+h, x, y, rr);
      ctx.arcTo(x, y, x+w, y, rr);
      ctx.closePath();
    }
  
    function drawTextStamp(W,H){
      const boxW = Math.round(W * 0.84);
      const boxH = Math.round(H * 0.13);
      const x = Math.round((W - boxW)/2);
      const y = Math.round(H * 0.06);
  
      ctx.save();
      ctx.globalAlpha = 0.55;
      ctx.fillStyle = '#000';
      roundRect(x, y, boxW, boxH, 18);
      ctx.fill();
      ctx.globalAlpha = 1;
  
      ctx.strokeStyle = 'rgba(255,255,255,.18)';
      ctx.lineWidth = 2;
      roundRect(x, y, boxW, boxH, 18);
      ctx.stroke();
  
      ctx.fillStyle = '#f3f6ff';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
  
      const main = '一富士　二鷹　三松村';
      const sub  = '縁起、よし。';
  
      ctx.font = `900 ${Math.round(W*0.06)}px system-ui, -apple-system, "Hiragino Sans", "Noto Sans JP", sans-serif`;
      ctx.fillText(main, W/2, y + boxH*0.46);
  
      ctx.fillStyle = 'rgba(243,246,255,.75)';
      ctx.font = `700 ${Math.round(W*0.03)}px system-ui, -apple-system, "Hiragino Sans", "Noto Sans JP", sans-serif`;
      ctx.fillText(sub, W/2, y + boxH*0.78);
  
      ctx.restore();
    }
  
    function drawOverlayComposite(W, H, {fuji, hawk, matsu}){
      // 1) カメラ（先）
      {
        ctx.setTransform(1,0,0,1,0,0);
  ctx.globalAlpha = 1;
  ctx.globalCompositeOperation = 'source-over';
  ctx.filter = 'none';
        const vw = video.videoWidth;
        const vh = video.videoHeight;
        const r = computeCoverRect(vw, vh, W, H);

        ctx.save();
        ctx.translate(W, 0);
        ctx.scale(-1, 1);
        drawCover(video, r.sx, r.sy, r.sw, r.sh, 0, 0, W, H);
        ctx.restore();
      }
  
  // 2) 富士（下に寄せて小さめ／透過なし）
{
  const fujiH = Math.round(H * 0.40);  // ←小さく（0.33〜0.45で調整）
  const y0 = Math.round(H - fujiH + H * 0.06); // ←少し下へ（0.03〜0.10）

  // 画面外にはみ出た分も自然に切れる
  const r = computeCoverRect(fuji.naturalWidth, fuji.naturalHeight, W, fujiH);

  ctx.save();
  ctx.globalAlpha = 1;                 // ←透過なし
  ctx.filter = 'contrast(1.06) saturate(1.04)';
  drawCover(fuji, r.sx, r.sy, r.sw, r.sh, 0, y0, W, fujiH);
  ctx.filter = 'none';
  ctx.restore();

  // 富士の上端を少し暗くして馴染ませ（不要なら削除）
  ctx.save();
  const bandH = Math.round(fujiH * 0.18);
  const grad = ctx.createLinearGradient(0, y0, 0, y0 + bandH);
  grad.addColorStop(0, 'rgba(0,0,0,0.25)');
  grad.addColorStop(1, 'rgba(0,0,0,0.00)');
  ctx.fillStyle = grad;
  ctx.fillRect(0, y0, W, bandH);
  ctx.restore();
}



   // 3) 鷹（文字帯の下に配置）
{
  const targetW = Math.round(W * 0.32); // 好みで 0.28〜0.40
  const scale = targetW / hawk.naturalWidth;
  const w = Math.round(hawk.naturalWidth * scale);
  const h = Math.round(hawk.naturalHeight * scale);

  const textBandBottom = Math.round(H * (0.06 + 0.13)); // drawTextStampと同期
  const y = Math.round(textBandBottom + H * 0.02);      // ←ここで「もうちょい下」
  const x = Math.round(W - w - W * 0.04);               // 右寄せ

  ctx.save();
  ctx.globalAlpha = 0.92;
  ctx.filter = 'drop-shadow(0px 6px 10px rgba(0,0,0,.35))';
  ctx.drawImage(hawk, x, y, w, h);
  ctx.restore();
}

      // 4) 松村
      {
        const targetH = Math.round(H * 0.62);
        const scale = targetH / matsu.naturalHeight;
        const w = Math.round(matsu.naturalWidth * scale);
        const h = Math.round(matsu.naturalHeight * scale);
  
        const x = Math.round(W - w + W*0.06);
        const y = Math.round(H - h + H*0.06);
  
        ctx.save();
        ctx.globalAlpha = 0.98;
        ctx.filter = 'drop-shadow(0px 10px 18px rgba(0,0,0,.45))';
        ctx.drawImage(matsu, x, y, w, h);
        ctx.restore();
      }
  
      // 5) 文字
      drawTextStamp(W, H);
    }
    async function waitVideoReady(){
  if (video.readyState >= 2 && video.videoWidth && video.videoHeight) return;

  await new Promise(resolve => {
    const on = () => resolve();
    video.addEventListener('loadedmetadata', on, { once:true });
    video.addEventListener('loadeddata', on, { once:true });
    video.addEventListener('canplay', on, { once:true });
  });

  // 念のため次フレームまで進める
  await new Promise(r => requestAnimationFrame(r));
}

    async function takeShot(){
      if (!stream) return;
      await waitVideoReady(); // ←これ
  
// これに固定
const W = 1080;
const H = 1920;

  
      canvas.width = W;
      canvas.height = H;
  
      const imgs = await ensureOverlays();
  
      flashOnce();
      chantOnce();
  
      ctx.clearRect(0,0,W,H);
      drawOverlayComposite(W, H, imgs);
  
      const blob = await new Promise(res => canvas.toBlob(res, 'image/jpeg', 0.92));
      if (!blob) return;
  
      if (lastBlobUrl) URL.revokeObjectURL(lastBlobUrl);
      lastBlobUrl = URL.createObjectURL(blob);
  
      resultImg.src = lastBlobUrl;
      result.classList.add('show');
  
      btnSave.disabled = false;
      btnRetry.disabled = false;
      setStatus('完成');
    }
  
    function downloadResult(){
      if (!lastBlobUrl) return;
      const a = document.createElement('a');
      a.href = lastBlobUrl;
      a.download = 'hatsuyume_1fuji2taka3matsumura.jpg';
      document.body.appendChild(a);
      a.click();
      a.remove();
    }
  
    function retry(){
      result.classList.remove('show');
      btnSave.disabled = true;
      btnRetry.disabled = true;
      setStatus('準備OK');
    }
  
    btnStart.addEventListener('click', startCamera);
    btnShot.addEventListener('click', takeShot);
    btnSave.addEventListener('click', downloadResult);
    btnRetry.addEventListener('click', retry);
  
    setStatus('カメラ未起動');
  </script>
  