<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
<title>é¡”ã‚¹ãƒ­ãƒƒãƒˆï¼ˆåœæ­¢ç¶­æŒï¼‹å½“ãŸã‚ŠéŸ³å£°ï¼‰</title>
<style>
  :root{ --ink:#e9f1f7; --muted:#9fb0c0; }
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  html,body{height:100%;margin:0}
  body{
    display:grid;place-items:center;background:#0a0f15;color:var(--ink);
    font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Yu Gothic",sans-serif;
  }
  .app{width:min(92vw,480px);display:grid;gap:14px;padding:18px;background:#0e1520;border:1px solid #1d2836;border-radius:20px}
  h1{margin:0;font-size:clamp(18px,4.8vw,22px)} .sub{color:var(--muted);font-size:12px}
  .face{display:grid;grid-template-rows:1fr 1fr 1fr;gap:10px;background:#0b131d;border:1px solid #1b2432;border-radius:14px;padding:10px}
  .reel{position:relative;border:1px solid #1c2635;border-radius:12px;background:#0f1722;overflow:hidden}
  .window{height:120px;overflow:hidden;position:relative}
  .strip{display:flex;position:absolute;top:0;left:0;height:100%;will-change:transform}
  .cell{flex:0 0 auto;height:100%}
  .cellBG{
    width:100%;height:100%;
    background-repeat:no-repeat;background-size:100% 300%;
    background-position-x:50%;
  }
  .seg-top .cellBG{background-position-y:0%}
  .seg-mid .cellBG{background-position-y:50%}
  .seg-bot .cellBG{background-position-y:100%}
  .status{text-align:center;color:var(--muted);min-height:1.4em;font-size:14px}
  .controls{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .btn{appearance:none;cursor:pointer;border:0;border-radius:14px;padding:12px 18px;font-weight:700;background:#1e7d78;color:white}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  footer{display:flex;justify-content:space-between;align-items:center;font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<main class="app">
  <header>
    <div>
      <h1>é¡”ã‚¹ãƒ­ãƒƒãƒˆ</h1>
      <div class="sub">STARTã§å›è»¢ â†’ STOPã§ä¸Š/ä¸­/ä¸‹ã®é †ã«åœæ­¢ï¼ˆ1,1,1ã®ã¿å½“ãŸã‚Šï¼‰</div>
    </div>
  </header>

  <section class="face">
    <div class="reel seg-top"><div class="window"><div class="strip"></div></div></div>
    <div class="reel seg-mid"><div class="window"><div class="strip"></div></div></div>
    <div class="reel seg-bot"><div class="window"><div class="strip"></div></div></div>
  </section>

  <div class="status" id="status">STARTã§å›è»¢ã—ã¾ã™ã€‚</div>
  <div class="controls">
    <button id="start" class="btn">START</button>
    <button id="stop"  class="btn" disabled>STOP</button>
  </div>
  <footer>
    <div>å½“ãŸã‚Š(1,1,1): <span id="wins">0</span> / ãƒã‚ºãƒ¬: <span id="loses">0</span></div>
  </footer>
</main>

<script type="module">
// =========================================
// Vercelç”¨ assetãƒ˜ãƒ«ãƒ‘ãƒ¼
// =========================================
const asset = (p) => new URL(p, import.meta.url).toString();

// =========================================
// åŸºæœ¬è¨­å®š
// =========================================
const VARIANTS = 5;
const SPEED = 2000;   // å›è»¢ã‚¹ãƒ”ãƒ¼ãƒ‰(px/s)
const SNAP  = 0.25;   // åœæ­¢å¸ç€ä¿‚æ•°
const SEGMENTS = ["top","mid","bot"];

// =========================================
// å½“ãŸã‚ŠéŸ³å£°ï¼ˆæ¾æ‘ã§ã™ï¼‰
// =========================================
const sOk = new Audio(asset('/apps/2025-10-24/assets/matsumura_desu.m4a'));
sOk.preload = 'auto';
['click','touchstart','pointerdown'].forEach(ev=>{
  window.addEventListener(ev,()=>{ sOk.muted = false; }, {once:true});
});

// =========================================
// ãƒªãƒ¼ãƒ«ã‚¯ãƒ©ã‚¹
// =========================================
class Reel {
  constructor(root, seg){
    this.root=root; this.seg=seg;
    this.strip=root.querySelector('.strip');
    this.window=root.querySelector('.window');
    this.width=0; this.maxOffset=0;
    this.offset=0; this.speed=0;
    this.state="idle"; // idle/spin/stopping/stopped
    this.target=0;
  }
  build(){
    this.width=this.window.clientWidth;
    this.strip.innerHTML="";
    for(let i=1;i<=VARIANTS;i++){
      const c=document.createElement("div");
      c.className="cell"; c.style.width=this.width+"px";
      const b=document.createElement("div");
      b.className="cellBG";
      b.style.backgroundImage=`url(${asset('./apps/2025-10-24/assets/face_'+i+'.png')})`;
      c.appendChild(b); this.strip.appendChild(c);
    }
    const clone=this.strip.firstElementChild.cloneNode(true);
    this.strip.appendChild(clone);
    this.maxOffset=this.width*VARIANTS;
    this.offset=Math.random()*this.maxOffset;
    this.render();
  }
  start(){
    this.speed=SPEED*(0.9+Math.random()*0.2);
    this.state="spin";
  }
  requestStop(){
    if(this.state!=="spin")return;
    const idx=Math.floor(Math.random()*VARIANTS);
    this.target = idx*this.width;
    this.state="stopping";
  }
  tick(dt){
    if(this.state==="spin"){
      this.offset+=this.speed*dt;
    }else if(this.state==="stopping"){
      const cur=(this.offset%this.maxOffset+this.maxOffset)%this.maxOffset;
      let diff=this.target-cur;
      if(diff> this.maxOffset/2) diff-=this.maxOffset;
      if(diff<-this.maxOffset/2) diff+=this.maxOffset;
      this.offset+=diff*SNAP;
      if(Math.abs(diff)<0.5){
        this.offset=this.target;
        this.state="stopped";
      }
    }
    if(this.offset>=this.maxOffset) this.offset-=this.maxOffset;
    this.render();
  }
  render(){ this.strip.style.transform=`translateX(${-this.offset}px)`; }
  currentIndex(){ return Math.round(this.offset/this.width)%VARIANTS; }
  isStopped(){ return this.state==="stopped"; }
}

// =========================================
// ãƒªãƒ¼ãƒ«ç”Ÿæˆ
// =========================================
const reels=[...document.querySelectorAll(".reel")].map((r,i)=>new Reel(r,SEGMENTS[i]));
reels.forEach(r=>r.build());

// =========================================
// ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ—
// =========================================
let last=performance.now();
function loop(now){
  const dt=(now-last)/1000; last=now;
  reels.forEach(r=>r.tick(dt));
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

// =========================================
// UIåˆ¶å¾¡
// =========================================
const elStart=document.getElementById("start");
const elStop =document.getElementById("stop");
const elStatus=document.getElementById("status");
const elWins=document.getElementById("wins");
const elLoses=document.getElementById("loses");

let phase="idle", wins=0, loses=0, stopCount=0;

elStart.onclick=()=>{
  reels.forEach(r=>r.build());
  reels.forEach(r=>r.start());
  phase="spinning"; stopCount=0;
  elStart.disabled=true; elStop.disabled=false;
  elStatus.textContent="å›è»¢ä¸­â€¦ STOPã§ä¸Šâ†’ä¸­â†’ä¸‹ã®é †ã«åœæ­¢";
};

elStop.onclick=()=>{
  if(phase!=="spinning") return;
  if(stopCount<3){
    reels[stopCount].requestStop();
    stopCount++;
    elStatus.textContent=["ä¸Šã‚’åœæ­¢â€¦ æ¬¡ã¯ä¸­","ä¸­ã‚’åœæ­¢â€¦ æ¬¡ã¯ä¸‹","ä¸‹ã‚’åœæ­¢â€¦ åˆ¤å®šä¸­"][stopCount-1];
    if(stopCount===3){
      elStop.disabled=true;
      waitUntil(()=>reels.every(r=>r.isStopped()), 1500).then(()=>{
        const [a,b,c]=reels.map(r=>r.currentIndex());
        if(a===0 && b===0 && c===0){
          wins++; elWins.textContent=wins;
          elStatus.textContent="ğŸ‰ å½“ãŸã‚Šï¼ï¼ˆ1,1,1ï¼‰";
          try{ sOk.currentTime=0; sOk.play(); }catch{}
        }else{
          loses++; elLoses.textContent=loses;
          elStatus.textContent=`ğŸ™ƒ ãƒã‚ºãƒ¬ï¼ˆä¸Š${a+1}ãƒ»ä¸­${b+1}ãƒ»ä¸‹${c+1}ï¼‰`;
        }
        // æ­¢ã¾ã£ãŸã¾ã¾ã€‚å†åº¦STARTã§æ–°ã—ã„ã‚²ãƒ¼ãƒ ã¸ã€‚
        elStart.disabled=false;
      });
    }
  }
};

const waitUntil=(fn,limit=2000)=>new Promise(res=>{
  const t0=performance.now();
  (function poll(){
    if(fn()) return res(true);
    if(performance.now()-t0>limit) return res(false);
    requestAnimationFrame(poll);
  })();
});
</script>
</body>
</html>
