<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
<title>æ¾æ‘ã‚’æ•‘ãˆï¼119ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒ¬ã‚¹ã‚­ãƒ¥ãƒ¼ï¼ˆç…™ï¼‹BGMï¼‰</title>
<link rel="icon" href="data:,"><!-- â† 404å¯¾ç­–ï¼ˆç©ºfaviconï¼‰ -->
<style>
  :root{
    --ink:#eaf4ff; --bg:#0c111a; --accent:#ff2d2d; --ok:#27d17f;
    --safe-top: env(safe-area-inset-top, 0px); --safe-bottom: env(safe-area-inset-bottom, 0px);
  }
  *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent }
  html,body{ height:100%; margin:0; background:var(--bg); color:var(--ink);
    font-family: ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Yu Gothic",sans-serif }
  #wrap{ position:fixed; inset:0; display:grid; place-items:center;
    padding:max(8px, var(--safe-top)) 8px max(12px,var(--safe-bottom)) 8px;
    height:100dvh; height:100vh; /* dvhå„ªå…ˆã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§vh */
    min-height:-webkit-fill-available; /* iOS Safariå¯¾å¿œ */ }
  #game{ width:min(calc(100vw - 16px), calc(100dvh * 9 / 16));
    max-width:calc(100vh * 9 / 16);
    aspect-ratio:9/16; position:relative; border-radius:20px; overflow:hidden;
    background:linear-gradient(#0c111a 25%, #121a24 75%); box-shadow:0 20px 60px rgba(0,0,0,.45) }
  canvas{ position:absolute; inset:0; width:100%; height:100%; display:block }
  .hud{ position:absolute; inset:10px 10px auto 10px; display:flex; gap:8px; align-items:center; pointer-events:none }
  .pill{ background:rgba(0,0,0,.45); border:1px solid rgba(255,255,255,.12);
    padding:6px 10px; border-radius:999px; font-size:12px }
  .hud .right{ margin-left:auto; display:flex; gap:8px; align-items:center }
  .siren{ width:10px; height:10px; border-radius:50%; background:var(--accent); box-shadow:0 0 14px var(--accent); animation:blink .9s infinite }
  @keyframes blink{ 50%{ opacity:.3; box-shadow:none } }
  .bottom{ position:absolute; inset:auto 10px 10px 10px; display:flex; gap:8px; align-items:center }
  #gaugeWrap{ flex:1; height:14px; background:rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.12); border-radius:999px; overflow:hidden }
  #gauge{ height:100%; width:0%; background:linear-gradient(90deg,#4fb2ff,#27d17f) }
  button{ all:unset; cursor:pointer; padding:10px 14px; border-radius:12px;
    background:#0f1522; border:1px solid rgba(255,255,255,.12); color:var(--ink); font-weight:700; font-size:14px; box-shadow:0 8px 24px rgba(0,0,0,.35)}
  button:active{ transform:translateY(1px) }
  #modal{ position:absolute; inset:0; display:none; place-items:center; background:rgba(0,0,0,.55); backdrop-filter:blur(4px) }
  #card{ width:85%; max-width:460px; background:#0f1522; border:1px solid rgba(255,255,255,.12);
    border-radius:16px; padding:18px; text-align:center }
  #title{ font-size:18px; font-weight:800; margin-bottom:6px }
  #msg{ font-size:14px; opacity:.85; margin-bottom:12px }
  .cta{ display:flex; gap:8px; justify-content:center; flex-wrap:wrap }
  body{ -webkit-user-select:none; user-select:none; -webkit-touch-callout:none; touch-action:manipulation }
</style>
</head>
<body>
<div id="wrap">
  <div id="game" role="application" aria-label="æ¾æ‘ã‚’æ•‘ãˆï¼119ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒ¬ã‚¹ã‚­ãƒ¥ãƒ¼ï¼ˆç…™ï¼‹BGMï¼‰">
    <canvas id="c"></canvas>
    <div class="hud">
      <div class="pill">æ•‘å‡º <span id="saved">0</span></div>
      <div class="pill">è¦‹å¤±ã„ <span id="missed">0</span></div>
      <div class="right">
        <div class="siren"></div>
        <div class="pill">æ®‹ã‚Š <span id="time">30.0</span>s</div>
      </div>
    </div>
    <div class="bottom">
      <div id="gaugeWrap"><div id="gauge"></div></div>
      <button id="muteBtn" aria-pressed="false" title="BGMã‚ªãƒ³/ã‚ªãƒ•">ğŸ”Š</button>
      <button id="resetBtn">ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
    <div id="modal">
      <div id="card">
        <div id="title">æ¾æ‘ã‚’æ•‘ãˆï¼ï¼ˆç…™ï¼‹BGMï¼‰</div>
        <div id="msg">å…¨ã¦ã®çª“ã‹ã‚‰<strong>ç…™</strong>ãŒä¸ŠãŒã£ã¦ã„ã‚‹ã€‚<br>ã¨ãã©ã<strong>æ¿ƒã„ç…™ï¼‹æ¾æ‘</strong>ãŒå‡ºç¾ï¼<br>ãã®çª“ã‚’ã‚¿ãƒƒãƒ—ã—ã¦æ•‘å‡ºã—ã‚ˆã†ã€‚<br>åˆ¶é™æ™‚é–“å†…ã«ä½•äººåŠ©ã‘ã‚‰ã‚Œã‚‹ï¼Ÿ</div>
        <div class="cta">
          <button id="startBtn">å‡ºå‹•ã™ã‚‹</button>
          <button id="howBtn">éŠã³æ–¹</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ğŸµ BGM -->
<audio id="bgm" src="" loop preload="auto"></audio>

<script type="module">
// å‹•çš„ã‚¢ã‚»ãƒƒãƒˆè§£æ±ºï¼ˆVercel/ãƒ­ãƒ¼ã‚«ãƒ«ä¸¡å¯¾å¿œï¼‰
const asset = (fileName) => {
  try{
    const p = location.pathname;
    // /YYYY-MM-DD ã¾ãŸã¯ /YYYY-MM-DD/... ã®å…ˆé ­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æŠ½å‡º
    const m = p.match(/^\/(\d{4}-\d{2}-\d{2})(?:\/.*)?$/);
    const base = m ? `/${m[1]}` : '';
    return `${base}/assets/${fileName.replace(/^\/+/, '').replace(/^\.\/assets\//, '')}`;
  }catch(e){
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆç›¸å¯¾ï¼‰
    return `assets/${fileName.replace(/^\/+/, '').replace(/^\.\/assets\//, '')}`;
  }
};

/* === ç”»åƒ === */
async function loadImage(url){return new Promise((res,rej)=>{const img=new Image();img.onload=()=>res(img);img.onerror=()=>rej();img.src=url;});}
const IMG_URL={matsu:asset('matsu_window.png')};
const IMG={matsu:null};

/* === DOM === */
const cvs=document.getElementById('c'),ctx=cvs.getContext('2d');
const savedEl=document.getElementById('saved'),missedEl=document.getElementById('missed'),timeEl=document.getElementById('time'),gauge=document.getElementById('gauge');
const modal=document.getElementById('modal'),startBtn=document.getElementById('startBtn'),howBtn=document.getElementById('howBtn'),resetBtn=document.getElementById('resetBtn');
const muteBtn=document.getElementById('muteBtn');
const bgm=document.getElementById('bgm');bgm.src=asset('bgm.mp3');bgm.volume=0.4;

/* === BGMãƒŸãƒ¥ãƒ¼ãƒˆçŠ¶æ…‹ã®æ°¸ç¶šåŒ– === */
const LS_KEY='matsu119_bgm_muted';
function applyMuteUI(){
  const muted=bgm.muted;
  muteBtn.textContent = muted ? 'ğŸ”‡' : 'ğŸ”Š';
  muteBtn.setAttribute('aria-pressed', String(muted));
}
(function initMute(){
  const saved = localStorage.getItem(LS_KEY);
  if(saved!==null){ bgm.muted = saved==='1'; }
  applyMuteUI();
})();
muteBtn.addEventListener('click',()=>{
  bgm.muted=!bgm.muted;
  localStorage.setItem(LS_KEY, bgm.muted?'1':'0');
  applyMuteUI();
});

/* === åŸºæœ¬ === */
addEventListener('gesturestart', e=>e.preventDefault(), {passive:false});
addEventListener('contextmenu', e=>e.preventDefault());

/* === è¨­å®š/çŠ¶æ…‹ === */
const CFG={cols:4,rows:5,roundSec:30,spawnIntervalMin:600,spawnIntervalMax:1200,lifetimeMin:1100,lifetimeMax:2200,
  maxSimultaneous:3,wrongTapPenalty:0.85,waterSpeed:1200,waterRadius:7,
  smokeWeakRate:0.018,smokeStrongRate:0.06,smokeRiseMin:22,smokeRiseMax:45,smokeSizeMin:6,smokeSizeMax:16,smokeAlpha:0.16,
  smokeMaxPerWin:36,smokeGlobalMax:320};
const STATE={playing:false,tLeft:CFG.roundSec,saved:0,missed:0,windows:[],targets:[],waters:[],b:{x:0,y:0},building:null,
  smokesWeak:[],smokesStrong:[]};

/* === Layout === */
let W=0,H=0,DPR=Math.min(2,devicePixelRatio||1);
function fit(){
  const r=cvs.parentElement.getBoundingClientRect();
  // å®Ÿéš›ã®åˆ©ç”¨å¯èƒ½ãªé«˜ã•ã‚’å–å¾—ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ã‚’è€ƒæ…®ï¼‰
  const availH=window.visualViewport?.height || window.innerHeight;
  const availW=window.visualViewport?.width || window.innerWidth;
  // ã‚²ãƒ¼ãƒ ã‚¨ãƒªã‚¢ã®å®Ÿéš›ã®ã‚µã‚¤ã‚ºã‚’å–å¾—
  const gameW=Math.min(r.width, availW - 16);
  const gameH=Math.min(r.height, availH - parseFloat(getComputedStyle(document.getElementById('wrap')).paddingTop || '0') - parseFloat(getComputedStyle(document.getElementById('wrap')).paddingBottom || '0'));
  W=Math.floor(gameW*DPR);H=Math.floor(gameH*DPR);
  cvs.width=W;cvs.height=H;cvs.style.width=gameW+'px';cvs.style.height=gameH+'px';
  const bw=W*0.82,bh=H*0.66,bx=(W-bw)/2,by=H*0.08;
  STATE.building={x:bx,y:by,w:bw,h:bh};
  const px=bw/(CFG.cols+1),py=bh/(CFG.rows+1),ww=Math.min(60*DPR,px*0.75),wh=Math.min(38*DPR,py*0.55);
  STATE.windows=[];for(let r=0;r<CFG.rows;r++)for(let c=0;c<CFG.cols;c++){const x=bx+px*(c+1)-ww/2,y=by+py*(r+1)-wh/2;STATE.windows.push({x,y,w:ww,h:wh});}
  STATE.b.x=W/2;STATE.b.y=H-110*DPR;STATE.smokesWeak=STATE.windows.map(()=>[]);STATE.smokesStrong=STATE.windows.map(()=>[]);
}
fit();
addEventListener('resize',fit);
if(window.visualViewport)window.visualViewport.addEventListener('resize',fit);

/* === Modal === */
function openModal(t,m){if(t)document.getElementById('title').textContent=t;if(m)document.getElementById('msg').innerHTML=m;modal.style.display='grid';}
function closeModal(){modal.style.display='none';}
startBtn.onclick=()=>{closeModal();startGame();};
howBtn.onclick=()=>openModal('éŠã³æ–¹','ãƒ»å…¨ã¦ã®çª“ã§<b>ç…™</b>ãŒä¸ŠãŒã£ã¦ã„ã¾ã™ã€‚<br>ãƒ»ã¨ãã©ã<b>æ¿ƒã„ç…™ï¼‹æ¾æ‘</b>ãŒå‡ºç¾ã€‚<br>ãƒ»ãã®çª“ã‚’ã‚¿ãƒƒãƒ—ã§æ•‘å‡ºã€‚å¤–ã™ã¨æ™‚é–“ãƒšãƒŠãƒ«ãƒ†ã‚£ã€‚<br>ãƒ»30ç§’ã§æ•‘å‡ºæ•°ã‚’ç«¶ãŠã†ï¼');
resetBtn.onclick=()=>{STATE.playing?(endGame(),startGame()):startGame();};

/* === Game === */
let assetsReady=false;async function ensureAssets(){if(assetsReady)return;try{IMG.matsu=await loadImage(IMG_URL.matsu);}catch{}assetsReady=true;}
async function startGame(){
  await ensureAssets();STATE.playing=true;STATE.tLeft=CFG.roundSec;STATE.saved=0;STATE.missed=0;STATE.targets=[];STATE.waters=[];
  STATE.smokesWeak=STATE.windows.map(()=>[]);STATE.smokesStrong=STATE.windows.map(()=>[]);
  savedEl.textContent=0;missedEl.textContent=0;timeEl.textContent=CFG.roundSec.toFixed(1);gauge.style.width='0%';
  try{await bgm.play();}catch(e){console.warn('BGMå†ç”Ÿä¸å¯',e);}
  nextSpawn();
}
function endGame(){STATE.playing=false;bgm.pause();bgm.currentTime=0;openModal('çµæœ',`æ•‘å‡º:<b>${STATE.saved}</b> è¦‹å¤±ã„:<b>${STATE.missed}</b>`);}

/* === Spawn === */
let spawnTimer=null;function nextSpawn(){if(!STATE.playing)return;const ms=rand(CFG.spawnIntervalMin,CFG.spawnIntervalMax);clearTimeout(spawnTimer);
  spawnTimer=setTimeout(()=>{if(STATE.targets.length<CFG.maxSimultaneous)spawnTarget();nextSpawn();},ms);}
function spawnTarget(){const idx=shuffled([...Array(STATE.windows.length).keys()]).find(i=>!STATE.targets.some(t=>t.idx===i));if(idx==null)return;
  const life=rand(CFG.lifetimeMin,CFG.lifetimeMax);STATE.targets.push({idx,bornAt:performance.now(),life});}

/* === Input === */
cvs.addEventListener('pointerdown',e=>{
  if(!STATE.playing)return;
  const r=cvs.getBoundingClientRect();const x=(e.clientX-r.left)*DPR,y=(e.clientY-r.top)*DPR;
  const hit=STATE.targets.find(t=>{const w=STATE.windows[t.idx];return x>=w.x&&x<=w.x+w.w&&y>=w.y&&y<=w.y+w.h;});
  if(hit){const w=STATE.windows[hit.idx];shootWater(STATE.b.x,STATE.b.y,w.x+w.w/2,w.y+w.h/2);
    STATE.saved++;savedEl.textContent=STATE.saved;gauge.style.width=Math.min(100,(STATE.saved/(STATE.saved+STATE.missed+1))*100)+'%';
    STATE.targets=STATE.targets.filter(t=>t!==hit);STATE.smokesStrong[hit.idx]=[];
  }else{STATE.tLeft=Math.max(0,STATE.tLeft*CFG.wrongTapPenalty);flashMiss();}
});

/* === Smoke === */
function spawnSmokeForWindow(arr,w,rateMul){let total=0;for(const a of STATE.smokesWeak)total+=a.length;for(const a of STATE.smokesStrong)total+=a.length;if(total>CFG.smokeGlobalMax)return;
  if(arr.length>=CFG.smokeMaxPerWin)return;const emitProb=w.w*w.h*(CFG.smokeWeakRate*rateMul)/(60*DPR*DPR);
  if(Math.random()<emitProb){const n=1+(Math.random()<0.3?1:0);for(let i=0;i<n;i++){const x=w.x+w.w*0.5+(Math.random()-0.5)*w.w*0.4,y=w.y+w.h*0.65+Math.random()*w.h*0.2;
    const r=rand(CFG.smokeSizeMin,CFG.smokeSizeMax)*DPR,vy=-rand(CFG.smokeRiseMin,CFG.smokeRiseMax)*DPR,vx=(Math.random()-0.5)*18*DPR,life=rand(900,1600)/1000;
    arr.push({x,y,r,vx,vy,life,age:0,alpha:CFG.smokeAlpha*(0.7+Math.random()*0.6)});}}}
function updateAndDrawSmokes(dt){
  for(let i=0;i<STATE.windows.length;i++){const w=STATE.windows[i],arr=STATE.smokesWeak[i];
    spawnSmokeForWindow(arr,w,1);for(let j=arr.length-1;j>=0;j--){const p=arr[j];p.age+=dt;p.x+=p.vx*dt;p.y+=p.vy*dt;p.r*=1+(dt*0.25);
      const a=p.alpha*(1-p.age/p.life);if(a<=0){arr.splice(j,1);continue;}drawSmokePuff(p.x,p.y,p.r,a);}}
  const strongIdx=new Set(STATE.targets.map(t=>t.idx));
  for(let i=0;i<STATE.windows.length;i++){const w=STATE.windows[i],arr=STATE.smokesStrong[i];const rate=strongIdx.has(i)?1:0.25;
    spawnSmokeForWindow(arr,w,CFG.smokeStrongRate/CFG.smokeWeakRate*rate);
    for(let j=arr.length-1;j>=0;j--){const p=arr[j];p.age+=dt;p.x+=p.vx*dt;p.y+=p.vy*dt;p.r*=1+(dt*0.3);
      const a=p.alpha*1.2*(1-p.age/p.life*0.9);if(a<=0){arr.splice(j,1);continue;}drawSmokePuff(p.x,p.y,p.r,a);}}}
function drawSmokePuff(x,y,r,a){const g=ctx.createRadialGradient(x,y,r*0.1,x,y,r);g.addColorStop(0,`rgba(210,220,230,${a*0.55})`);g.addColorStop(1,`rgba(120,130,140,0)`);ctx.fillStyle=g;ctx.beginPath();ctx.arc(x,y,r,0,Math.PI*2);ctx.fill();}

/* === Draw === */
function drawStage(){const b=STATE.building;const g=ctx.createLinearGradient(0,b.y,0,b.y+b.h);g.addColorStop(0,'#182233');g.addColorStop(1,'#0f1624');
  ctx.fillStyle=g;ctx.strokeStyle='rgba(255,255,255,.08)';roundRect(b.x,b.y,b.w,b.h,18*DPR,true,true);
  for(const w of STATE.windows){ctx.fillStyle='rgba(255,255,255,.06)';roundRect(w.x,w.y,w.w,w.h,6*DPR,true,false);}
  ctx.fillStyle='#0b0f17';roundRect(STATE.b.x-70*DPR,STATE.b.y+28*DPR,140*DPR,30*DPR,14*DPR,true,false);}
function drawTargets(){for(const t of STATE.targets){const w=STATE.windows[t.idx];const cx=w.x+w.w/2,cy=w.y+w.h/2;
  if(IMG.matsu){const s=Math.min(w.w,w.h)*0.9;ctx.drawImage(IMG.matsu,cx-s/2,cy-s/2,s,s);}else{ctx.fillStyle='rgba(42,51,80,.95)';ctx.beginPath();ctx.arc(cx,cy,Math.min(w.w,w.h)*0.32,0,Math.PI*2);ctx.fill();ctx.fillStyle='#fff';ctx.font=`${12*DPR}px system-ui`;ctx.textAlign='center';ctx.fillText('æ¾',cx,cy+4*DPR);}
  ctx.fillStyle='rgba(255,255,255,.85)';ctx.font=`${10*DPR}px system-ui`;ctx.textAlign='center';ctx.fillText('ãŸã™ã‘ã¦ï¼',cx,w.y-6*DPR);}}
function drawWater(w){ctx.fillStyle='rgba(79,178,255,.95)';ctx.beginPath();ctx.arc(w.x,w.y,CFG.waterRadius*DPR,0,Math.PI*2);ctx.fill();
  ctx.strokeStyle='rgba(79,178,255,.35)';ctx.lineWidth=2*DPR;ctx.beginPath();ctx.moveTo(w.x-w.vx*0.02,w.y-w.vy*0.02);ctx.lineTo(w.x,w.y);ctx.stroke();}

/* === Loop === */
let last=performance.now(),missFlash=0;function flashMiss(){missFlash=1;}
function loop(now){
  const dt=Math.min(0.032,(now-last)/1000);last=now;
  ctx.clearRect(0,0,W,H);

  // èƒŒæ™¯ãƒ»çª“
  drawStage();

  if(STATE.playing){
    STATE.tLeft=Math.max(0,STATE.tLeft-dt);
    timeEl.textContent=STATE.tLeft.toFixed(1);
    if(STATE.tLeft<=0) endGame();

    // å‡ºç¾å¯¿å‘½
    for(let i=STATE.targets.length-1;i>=0;i--){
      const t=STATE.targets[i];
      if(now - t.bornAt >= t.life){
        STATE.targets.splice(i,1);
        STATE.missed++; missedEl.textContent=STATE.missed;
      }
    }
  }

  // ç…™ï¼ˆå¼±â†’å¼·ï¼‰
  updateAndDrawSmokes(dt);

  // æ¾æ‘
  drawTargets(now);

  // æ°´ã®ç²’
  for(let i=STATE.waters.length-1;i>=0;i--){
    const w=STATE.waters[i];
    w.life-=dt; drawWater(w); w.x+=w.vx*dt; w.y+=w.vy*dt;
    if(w.life<=0) STATE.waters.splice(i,1);
  }

  // ãƒŸã‚¹ãƒ•ãƒ©ãƒƒã‚·ãƒ¥
  if(missFlash>0){
    ctx.fillStyle=`rgba(255,45,45,${0.25*missFlash})`;
    ctx.fillRect(0,0,W,H);
    missFlash=Math.max(0,missFlash - dt*2.2);
  }

  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

/* ==== Utility ==== */
function shootWater(sx,sy,tx,ty){
  const dx=tx-sx,dy=ty-sy,d=Math.hypot(dx,dy);
  STATE.waters.push({x:sx,y:sy,vx:(dx/d)*CFG.waterSpeed,vy:(dy/d)*CFG.waterSpeed,life:d/CFG.waterSpeed});
}
function rand(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
function shuffled(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
function roundRect(x,y,w,h,r,f,s){
  ctx.beginPath();
  ctx.moveTo(x+r,y);
  ctx.arcTo(x+w,y,x+w,y+h,r);
  ctx.arcTo(x+w,y+h,x,y+h,r);
  ctx.arcTo(x,y+h,x,y,r);
  ctx.arcTo(x,y,x+w,y,r);
  if(f)ctx.fill();
  if(s)ctx.stroke();
}

/* ==== åˆæœŸè¡¨ç¤º ==== */
openModal(
  'æ¾æ‘ã‚’æ•‘ãˆï¼ï¼ˆç…™ï¼‹BGMï¼‰',
  'å…¨çª“ã§ã‚‚ãã‚‚ãç…™ã€‚<br><b>æ¿ƒã„ç…™ï¼‹æ¾æ‘</b>ã®çª“ã‚’ã‚¿ãƒƒãƒ—ã—ã¦æ•‘å‡ºï¼<br>å¤–ã™ã¨æ™‚é–“ãŒæ¸›ã‚‹ã‚ˆï¼'
);
</script>
</body>
</html>
