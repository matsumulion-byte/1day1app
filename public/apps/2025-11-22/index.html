<!doctype html>
<html lang="ja">
<head>
  <!-- OGP AUTO-GENERATED START (do not edit by hand) -->
  <meta property="og:title" content="æ¾æ‘ã§ã™ 5éŸ³ãƒ•ãƒ¬ãƒ¼ã‚ºãƒ¡ãƒ¼ã‚«ãƒ¼">
  <meta name="twitter:title" content="æ¾æ‘ã§ã™ 5éŸ³ãƒ•ãƒ¬ãƒ¼ã‚ºãƒ¡ãƒ¼ã‚«ãƒ¼">
  <meta property="og:description" content="æ¾æ‘ã§ã™ 5éŸ³ãƒ•ãƒ¬ãƒ¼ã‚ºãƒ¡ãƒ¼ã‚«ãƒ¼ ãƒ©ãƒ³ãƒ€ãƒ è­œé¢ã‚’æ¾æ‘ãƒœã‚¤ã‚¹ã§å†ç”Ÿ MATSUMURA voice ä»Šæ—¥ã®5éŸ³ãƒ•ãƒ¬ãƒ¼ã‚º è­œé¢ï¼‹æ¾æ‘ãƒœã‚¤ã‚¹ æ¾æ‘ã§ã™ã§å†ç”Ÿ åˆ¥ã®ãƒ•ãƒ¬ãƒ¼ã‚º ãƒ»è­œé¢ã¯ãƒˆéŸ³è¨˜å·ãƒ»4/4ã€Cãƒ¡ã‚¸ãƒ£ãƒ¼å›ºå®šã§ã™ã€‚ ãƒ»5éŸ³ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’ãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆã—ã¾ã™ã€‚ ãƒ»ã€Œæ¾æ‘ã§ã™ã§å†ç”Ÿã€ã§è­œé¢ã©ãŠ">
  <meta name="twitter:description" content="æ¾æ‘ã§ã™ 5éŸ³ãƒ•ãƒ¬ãƒ¼ã‚ºãƒ¡ãƒ¼ã‚«ãƒ¼ ãƒ©ãƒ³ãƒ€ãƒ è­œé¢ã‚’æ¾æ‘ãƒœã‚¤ã‚¹ã§å†ç”Ÿ MATSUMURA voice ä»Šæ—¥ã®5éŸ³ãƒ•ãƒ¬ãƒ¼ã‚º è­œé¢ï¼‹æ¾æ‘ãƒœã‚¤ã‚¹ æ¾æ‘ã§ã™ã§å†ç”Ÿ åˆ¥ã®ãƒ•ãƒ¬ãƒ¼ã‚º ãƒ»è­œé¢ã¯ãƒˆéŸ³è¨˜å·ãƒ»4/4ã€Cãƒ¡ã‚¸ãƒ£ãƒ¼å›ºå®šã§ã™ã€‚ ãƒ»5éŸ³ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’ãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆã—ã¾ã™ã€‚ ãƒ»ã€Œæ¾æ‘ã§ã™ã§å†ç”Ÿã€ã§è­œé¢ã©ãŠ">
  <meta property="og:url" content="/apps/2025-11-22/index.html">
  <meta property="og:type" content="website">
  <meta name="twitter:card" content="summary_large_image">
  <!-- OGP AUTO-GENERATED END -->

  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no"
  />
  <title>æ¾æ‘ã§ã™ 5éŸ³ãƒ•ãƒ¬ãƒ¼ã‚ºãƒ¡ãƒ¼ã‚«ãƒ¼</title>

  <!-- VexFlowï¼ˆè­œé¢æç”»ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼‰-->
  <script src="https://unpkg.com/vexflow@1.2.93/releases/vexflow-min.js"></script>

  <style>
    :root {
      --bg: #050814;
      --bg-soft: #0c1022;
      --accent: #ffcc33;
      --accent-soft: rgba(255, 204, 51, 0.16);
      --ink: #f5f7ff;
      --muted: #9aa0c2;
      --danger: #ff4b6a;
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --radius-lg: 24px;
      --shadow-soft: 0 18px 45px rgba(0, 0, 0, 0.5);
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
    }
    html, body {
      height: 100%;
      background: #000;
      color: var(--ink);
      font-family: system-ui, -apple-system, BlinkMacSystemFont,
        "Helvetica Neue", "Hiragino Kaku Gothic ProN", "Yu Gothic", sans-serif;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
      touch-action: manipulation;
    }
    body {
      display: flex;
      justify-content: center;
      align-items: stretch;
    }

    /* 9:16 ç¸¦ã®ãƒ•ãƒ¬ãƒ¼ãƒ  */
    .app-frame {
      position: relative;
      width: min(100vw, 480px);
      height: 100vh;
      max-height: 100vh;
      background: radial-gradient(circle at top, #141a3c 0, #020313 60%);
      overflow: hidden;
    }

    .app-inner {
      position: absolute;
      inset: var(--safe-top) 0 var(--safe-bottom);
      padding: 12px 14px 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(3, 7, 30, 0.9);
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.45);
      border: 1px solid rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(18px);
      font-size: 11px;
    }

    .header-main {
      font-size: 14px;
      font-weight: 700;
      letter-spacing: 0.08em;
    }
    .header-sub {
      font-size: 10px;
      color: var(--muted);
    }

    .chip {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      font-size: 10px;
      color: var(--accent);
      background: rgba(10, 15, 36, 0.9);
      text-align: center;
      min-width: 88px;
    }
    .chip span {
      opacity: 0.7;
    }

    .main-card {
      flex: 1;
      margin-top: 4px;
      padding: 12px 12px 16px;
      border-radius: var(--radius-lg);
      background: linear-gradient(145deg, #11172f 0%, #050817 55%, #02020a 100%);
      box-shadow: var(--shadow-soft);
      display: flex;
      flex-direction: column;
      gap: 12px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      position: relative;
      overflow: hidden;
    }

    .main-card::before {
      content: "";
      position: absolute;
      inset: -40%;
      background:
        radial-gradient(circle at 20% 0%, rgba(255, 255, 255, 0.09) 0, transparent 60%),
        radial-gradient(circle at 80% 120%, rgba(255, 204, 51, 0.12) 0, transparent 55%);
      opacity: 0.9;
      pointer-events: none;
    }

    .top-row {
      position: relative;
      z-index: 1;
    }

    .title-line {
      font-size: 14px;
      font-weight: 600;
    }

    .title-line span {
      font-size: 11px;
      font-weight: 400;
      color: var(--muted);
      margin-left: 4px;
    }

    .today-tag {
      margin-top: 4px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: var(--muted);
    }

    .today-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 0 4px rgba(255, 204, 51, 0.2);
    }

    .phrase-card {
      position: relative;
      z-index: 1;
      margin-top: 8px;
      flex: 1;
      min-height: 0;
      padding: 10px 10px 12px;
      border-radius: 18px;
      background: radial-gradient(circle at 50% 0, #1b2343 0, #050817 60%);
      border: 1px solid rgba(255, 255, 255, 0.06);
      display: flex;
      flex-direction: column;
      gap: 8px;
      overflow: hidden;
    }

    .phrase-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 10px;
      color: var(--muted);
    }

    .phrase-meta strong {
      color: var(--accent);
      font-weight: 600;
    }

    .phrase-meta-key {
      font-variant-numeric: tabular-nums;
    }

    /* è­œé¢ã‚¨ãƒªã‚¢ */
    .score-wrap {
      width: 100%;
      height: 150px;
      border-radius: 12px;
      background: #ffffff;
      border: 1px solid rgba(0, 0, 0, .12);
      padding: 10px 12px;
      overflow: hidden;
    }

    #score svg {
      width: 100%;
      height: 100%;
    }

    .pattern-label {
      margin-top: 2px;
      text-align: right;
      font-size: 10px;
      color: var(--muted);
    }

    .bottom-row {
      position: relative;
      z-index: 1;
      margin-top: 4px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 10px;
      color: var(--muted);
    }

    .button-row {
      display: flex;
      gap: 8px;
    }

    .btn-primary,
    .btn-secondary {
      flex: 1;
      padding: 8px 10px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      transition: transform 0.08s ease-out, box-shadow 0.08s ease-out,
        background 0.08s ease-out, border-color 0.08s ease-out;
    }

    .btn-primary {
      background: linear-gradient(120deg, #ffcc33, #ff8a3c);
      color: #241400;
      box-shadow: 0 14px 28px rgba(0, 0, 0, 0.6);
    }

    .btn-primary:active {
      transform: translateY(2px);
      box-shadow: 0 5px 14px rgba(0, 0, 0, 0.6);
    }

    .btn-secondary {
      background: rgba(3, 6, 26, 0.9);
      color: var(--ink);
      border: 1px solid rgba(255, 255, 255, 0.28);
      box-shadow: 0 10px 22px rgba(0, 0, 0, 0.6);
    }

    .btn-secondary:active {
      transform: translateY(2px);
      box-shadow: 0 5px 12px rgba(0, 0, 0, 0.6);
    }

    .hint-text {
      font-size: 10px;
      color: var(--muted);
    }

    @media (min-width: 768px) {
      .app-frame {
        border-radius: 32px;
        margin: 10px 0;
        box-shadow: 0 18px 60px rgba(0, 0, 0, 0.75);
      }
    }
  </style>
</head>
<body>
  <div class="app-frame">
    <div class="app-inner">
      <header>
        <div>
          <div class="header-main">æ¾æ‘ã§ã™ 5éŸ³ãƒ•ãƒ¬ãƒ¼ã‚ºãƒ¡ãƒ¼ã‚«ãƒ¼</div>
          <div class="header-sub">ãƒ©ãƒ³ãƒ€ãƒ è­œé¢ã‚’æ¾æ‘ãƒœã‚¤ã‚¹ã§å†ç”Ÿ</div>
        </div>
        <div class="chip">
          MATSUMURA
          <span> voice</span>
        </div>
      </header>

      <main class="main-card">
        <section class="top-row">
          <div class="title-line">
            ä»Šæ—¥ã®5éŸ³ãƒ•ãƒ¬ãƒ¼ã‚º
            <span>è­œé¢ï¼‹æ¾æ‘ãƒœã‚¤ã‚¹</span>
          </div>
          <div class="today-tag">
            <span class="today-dot"></span>
            <span id="today-label"></span>
          </div>
        </section>

        <section class="phrase-card">
          <div class="phrase-meta">
            <span class="phrase-meta-key" id="meta-key"></span>
            <span id="meta-info"></span>
          </div>

          <!-- è­œé¢ -->
          <div class="score-wrap">
            <div id="score"></div>
          </div>

          <div class="pattern-label" id="pattern-label"></div>
        </section>

        <section class="bottom-row">
          <div class="button-row">
            <button class="btn-secondary" id="play-btn" type="button">
              æ¾æ‘ã§ã™ã§å†ç”Ÿ
            </button>
            <button class="btn-primary" id="next-btn" type="button">
              åˆ¥ã®ãƒ•ãƒ¬ãƒ¼ã‚º
            </button>
          </div>
          <div class="hint-text">
            ãƒ»è­œé¢ã¯ãƒˆéŸ³è¨˜å·ãƒ»4/4ã€Cãƒ¡ã‚¸ãƒ£ãƒ¼å›ºå®šã§ã™ã€‚<br />
            ãƒ»5éŸ³ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’ãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆã—ã¾ã™ã€‚<br />
            ãƒ»ã€Œæ¾æ‘ã§ã™ã§å†ç”Ÿã€ã§è­œé¢ã©ãŠã‚Šã®ãƒ”ãƒƒãƒã§ã€Œæ¾æ‘ã§ã™ã€ãƒœã‚¤ã‚¹ãŒé³´ã‚Šã¾ã™ã€‚<br />
            ãƒ»æ°—ã«å…¥ã£ãŸãƒ•ãƒ¬ãƒ¼ã‚ºã¯ã‚¹ã‚¯ã‚·ãƒ§ã§ä¿å­˜ã—ã¦ãã ã•ã„ã€‚
          </div>
        </section>
      </main>
    </div>
  </div>

  <script type="module">
    // Vercelç”¨ã®ãƒ‘ã‚¹è§£æ±º
    const DATE_SEGMENT = (location.pathname.match(/\d{4}-\d{2}-\d{2}/) || [""])[0];
    const DATE_BASE = DATE_SEGMENT ? `/${DATE_SEGMENT}/` : '/';
    const asset = (p) => {
      const clean = String(p || '').replace(/^\.?\//, '');
      return `${DATE_BASE}${clean}`;
    };
  
    // --- éŸ³åãƒ»ã‚­ãƒ¼å‘¨ã‚Š -------------------------
    const NOTE_NAMES_SHARP = [
      "C","C#","D","D#","E","F","F#","G","G#","A","A#","B"
    ];
    const NOTE_NAMES_FLAT = [
      "C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"
    ];
  
    const KEYS = [
      { id: "C",  label: "Cãƒ¡ã‚¸ãƒ£ãƒ¼ï¼ˆå›ºå®šï¼‰", tonicIndex: 0, naming: "sharp", baseMidi: 60 },
    ];
  
    // åº¦æ•° â†’ ãƒˆãƒ‹ãƒƒã‚¯ã‹ã‚‰ã®åŠéŸ³æ•°
    const DEGREE_SEMITONES = {
      "1": 0,
      "2": 2,
      "3": 4,
      "4": 5,
      "5": 7,
      "6": 9,
      "7": 11,
      "b3": 3,
      "b5": 6,
      "b7": 10,
      "9": 14,
      "b9": 13,
      "#9": 15,
      "11": 17,
      "#11": 18,
      "13": 21,
      "b13": 20,
    };
  
    function degreeToNoteName(key, degreeSymbol) {
      const semi = DEGREE_SEMITONES[degreeSymbol];
      if (semi == null) return key.id;
      const idx = (key.tonicIndex + semi) % 12;
      const names = key.naming === "sharp" ? NOTE_NAMES_SHARP : NOTE_NAMES_FLAT;
      return names[idx];
    }
  
    function degreeToMidi(key, degreeSymbol) {
      const semi = DEGREE_SEMITONES[degreeSymbol] ?? 0;
      return key.baseMidi + semi;
    }
  
    function midiToFreq(midi) {
      return 440 * Math.pow(2, (midi - 69) / 12);
    }
  
    // VexFlow ç”¨ï¼š MIDI â†’ "c#/4" å½¢å¼
    function midiToVexKey(midi, naming = "sharp") {
      const noteIndex = ((midi % 12) + 12) % 12;
      const names = naming === "sharp" ? NOTE_NAMES_SHARP : NOTE_NAMES_FLAT;
      const name = names[noteIndex];
      const octave = Math.floor(midi / 12) - 1;
  
      const letter = name[0].toLowerCase();
      let accidental = "";
      if (name.length > 1) {
        const rest = name.slice(1);
        if (rest.includes("#")) accidental = "#";
        if (rest.includes("b")) accidental = "b";
      }
      return `${letter}${accidental}/${octave}`;
    }
  
    // éŸ³ä¾¡è¡¨ç¤º
    function durationToLabel(d) {
      const EPS = 0.01;
      if (Math.abs(d - 0.25) < EPS) return "â™¬ 16åˆ†";
      if (Math.abs(d - 1/3) < EPS)  return "â™ª3é€£";
      if (Math.abs(d - 0.5)  < EPS) return "â™ª 8åˆ†";
      if (Math.abs(d - 1)    < EPS) return "â™© 4åˆ†";
      if (Math.abs(d - 2)    < EPS) return "ğ… 2åˆ†";
      return "â™ª";
    }
    function durationToSymbol(d) {
      return durationToLabel(d).split(" ")[0];
    }
  
    // éŸ³ä¾¡ â†’ VexFlowã®durationæ–‡å­—åˆ—
    function durationToVF(d) {
      const EPS = 0.01;
      if (Math.abs(d - 2)   < EPS) return "h";   // half
      if (Math.abs(d - 1)   < EPS) return "q";   // quarter
      if (Math.abs(d - 0.5) < EPS) return "8";   // eighth
      if (Math.abs(d - 0.25)< EPS) return "16";  // sixteenth
      if (Math.abs(d - 1/3) < EPS) return "8";   // triplet uses 8th notes
      return "8";
    }
  
    // --- ãƒ•ãƒ¬ãƒ¼ã‚ºãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆå…¨éƒ¨5éŸ³ï¼‰ -----------------------
    const PATTERNS = [
  // ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼
  // SCALE ç³»
  // ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼
  {
    id: "scale_up5",
    label: "ã‚¹ã‚±ãƒ¼ãƒ« 5 éŸ³ä¸Šæ˜‡",
    degrees: ["1","2","3","4","5"],
    durations: [0.5,0.5,0.5,0.5,0.5],
    tags: ["scale","any"],
  },
  {
    id: "scale_down5",
    label: "ã‚¹ã‚±ãƒ¼ãƒ« 5 éŸ³ä¸‹é™",
    degrees: ["5","4","3","2","1"],
    durations: [0.5,0.5,0.5,0.5,0.5],
    tags: ["scale","any"],
  },
  {
    id: "scale_16th_run5",
    label: "16 åˆ†ã‚¹ã‚±ãƒ¼ãƒ«ãƒ©ãƒ³",
    degrees: ["1","2","3","4","5"],
    durations: [0.25,0.25,0.25,0.25,0.25],
    tags: ["scale","any"],
  },
  {
    id: "scale_up_jump",
    label: "ä¸Šæ˜‡â†’ã‚¸ãƒ£ãƒ³ãƒ—",
    degrees: ["1","2","3","4","6"],
    durations: [0.5,0.5,0.5,0.5,0.5],
    tags: ["scale","any"],
  },
  {
    id: "scale_down_jump",
    label: "ä¸‹é™â†’ã‚¸ãƒ£ãƒ³ãƒ—",
    degrees: ["5","4","3","2","6"],
    durations: [0.5,0.5,0.5,0.5,0.5],
    tags: ["scale","any"],
  },

  // ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼
  // CHORD ç³»
  // ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼
  {
    id: "triad_basic5",
    label: "ãƒˆãƒ©ã‚¤ã‚¢ãƒ‰å¾€å¾©",
    degrees: ["1","3","5","3","1"],
    durations: [0.5,0.5,0.5,0.5,0.5],
    tags: ["chord","any"],
  },
  {
    id: "seventh_resolve5",
    label: "7th â†’ 1åº¦è§£æ±º",
    degrees: ["1","3","5","b7","1"],
    durations: [0.5,0.5,0.5,0.5,0.5],
    tags: ["chord","any"],
  },
  {
    id: "arpeggio_jump5",
    label: "ã‚¢ãƒ«ãƒšã‚¸ã‚ªï¼‹ã‚¸ãƒ£ãƒ³ãƒ—",
    degrees: ["1","5","3","7","5"],
    durations: [0.5,0.5,0.5,0.5,0.5],
    tags: ["chord","any"],
  },
  {
    id: "reverse_arpeggio",
    label: "é€†ã‚¢ãƒ«ãƒšã‚¸ã‚ª",
    degrees: ["1","7","6","5","3"],
    durations: [0.5,0.5,0.5,0.5,0.5],
    tags: ["chord","any"],
  },
  {
    id: "lift_up",
    label: "ãƒªãƒ•ãƒˆã‚¢ãƒƒãƒ—é¢¨",
    degrees: ["3","5","7","1","9"],
    durations: [0.5,0.5,0.5,0.5,0.5],
    tags: ["chord","any"],
  },

  // ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼
  // CHROMATICï¼ˆåŠéŸ³ï¼‰ç³»
  // ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼
  {
    id: "chrom_approach5",
    label: "5åº¦ ã‚¯ãƒ­ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ",
    degrees: ["5","b5","4","3","1"],
    durations: [0.5,0.5,0.5,0.5,0.5],
    tags: ["chromatic","any"],
  },
  {
    id: "chrom_down1",
    label: "ã‚¯ãƒ­ãƒãƒãƒƒã‚¯ä¸‹é™ â†’1",
    degrees: ["3","b3","2","b2","1"],
    durations: [0.5,0.5,0.5,0.5,0.5],
    tags: ["chromatic","any"],
  },
  {
    id: "chrom_up",
    label: "ã‚¯ãƒ­ãƒãƒãƒƒã‚¯ä¸Šæ˜‡",
    degrees: ["1","b2","2","b3","3"],
    durations: [0.5,0.5,0.5,0.5,0.5],
    tags: ["chromatic","any"],
  },
  {
    id: "blue_note_desc",
    label: "ãƒ–ãƒ«ãƒ¼ãƒãƒ¼ãƒˆé¢¨ä¸‹é™",
    degrees: ["5","#5","6","b6","5"],
    durations: [0.5,0.5,0.5,0.5,0.5],
    tags: ["chromatic","any"],
  },
  {
    id: "blue_note_pull",
    label: "b3 â†’ 3 å¼•ã£å¼µã‚Š",
    degrees: ["2","b3","3","b3","2"],
    durations: [0.5,0.5,0.5,0.5,0.5],
    tags: ["chromatic","any"],
  },

  // ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼
  // ENCLOSURE ç³»
  // ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼
  {
    id: "enclosure3",
    label: "3åº¦ã‚¨ãƒ³ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£",
    degrees: ["2","b3","3","2","1"],
    durations: [0.5,0.5,0.5,0.5,0.5],
    tags: ["chromatic","any"],
  },
  {
    id: "enclosure5",
    label: "5åº¦ã‚¨ãƒ³ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£",
    degrees: ["6","#5","5","b5","5"],
    durations: [0.5,0.5,0.5,0.5,0.5],
    tags: ["chromatic","any"],
  },
  {
    id: "enclosure_alt",
    label: "ã‚ªãƒ«ã‚¿ãƒ¼ãƒ‰é¢¨ã‚¨ãƒ³ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£",
    degrees: ["b9","1","#9","1","5"],
    durations: [0.5,0.5,0.5,0.5,0.5],
    tags: ["chromatic","any"],
  },

  // ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼
  // 3é€£ç¬¦ï¼ˆTupletï¼‰ç³»
  // ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼
  {
    id: "triplet_up5",
    label: "ä¸Šæ˜‡ä¸‰é€£ + 8åˆ†2ã¤",
    degrees: ["1","2","3","5","6"],
    durations: [1/3,1/3,1/3,0.5,0.5],
    tags: ["chromatic","scale","any"],
    tuplets: [{ from:0, to:2, num_notes:3, notes_occupied:2 }],
  },
  {
    id: "triplet_enclosure5",
    label: "ä¸‰é€£ã‚¨ãƒ³ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£",
    degrees: ["3","b3","2","1","5"],
    durations: [1/3,1/3,1/3,0.5,0.5],
    tags: ["chromatic","any"],
    tuplets: [{ from:0, to:2, num_notes:3, notes_occupied:2 }],
  },
  {
    id: "triplet_reverse",
    label: "é€†ä¸‰é€£ + resolve",
    degrees: ["5","4","3","2","1"],
    durations: [1/3,1/3,1/3,0.5,0.5],
    tags: ["scale","any"],
    tuplets: [{ from:0, to:2, num_notes:3, notes_occupied:2 }],
  },

  // ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼
  // RHYTHMï¼ˆãƒªã‚ºãƒ ï¼‰ç³»
  // ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼
  {
    id: "rhythm_mix1",
    label: "â™ªâ™ªâ™¬â™¬â™ª",
    degrees: ["1","2","3","4","5"],
    durations: [0.5,0.5,0.25,0.25,0.5],
    tags: ["any"],
  },
  {
    id: "rhythm_mix2",
    label: "â™¬â™¬â™ªâ™ªâ™ª",
    degrees: ["5","3","4","2","1"],
    durations: [0.25,0.25,0.5,0.5,0.5],
    tags: ["any"],
  },
  {
    id: "rhythm_sync",
    label: "ã‚·ãƒ³ã‚³ãƒšé¢¨",
    degrees: ["1","3","2","5","4"],
    durations: [0.5,0.5,0.75,0.25,0.5],
    tags: ["any"],
  },
  {
    id: "rhythm_skip",
    label: "è·³ã­ã‚‹ãƒªã‚ºãƒ ",
    degrees: ["1","5","4","2","3"],
    durations: [0.5,0.25,0.25,0.5,0.5],
    tags: ["any"],
  },
  {
    id: "rhythm_push",
    label: "å‰ãƒãƒª PUSH",
    degrees: ["3","4","5","6","5"],
    durations: [0.25,0.25,0.5,0.5,0.5],
    tags: ["any"],
  },
];

    // --- DOM ------------------------------
    const todayLabel = document.getElementById("today-label");
    const patternLabelEl = document.getElementById("pattern-label");
    const metaKeyEl = document.getElementById("meta-key");
    const metaInfoEl = document.getElementById("meta-info");
    const nextBtn = document.getElementById("next-btn");
    const playBtn = document.getElementById("play-btn");
    const scoreContainer = document.getElementById("score");
  
    // --- çŠ¶æ…‹ ------------------------------
    let currentKey = KEYS[0];          // Cå›ºå®š
    let currentPattern = PATTERNS[0];
    let currentDegrees = PATTERNS[0].degrees;
    let currentDurations = PATTERNS[0].durations;
    let lastPatternId = null;
  
    function shuffle(arr) {
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }
  
    function pickPattern() {
      let pool = PATTERNS;
      if (lastPatternId && pool.length > 1) {
        const filtered = pool.filter(p => p.id !== lastPatternId);
        if (filtered.length > 0) pool = filtered;
      }
      const picked = shuffle(pool)[0];
      lastPatternId = picked.id;
      return picked;
    }
  
    // --- è­œé¢æç”»ï¼ˆVexFlowæ¨™æº–ã®æµã‚Œï¼‰ -----------------
    function renderScore() {
      const VF = Vex.Flow;
      scoreContainer.innerHTML = "";
  
      const width = scoreContainer.clientWidth || 260;
      const height = 150;
  
      const renderer = new VF.Renderer(
        scoreContainer,
        VF.Renderer.Backends.SVG
      );
      renderer.resize(width, height);
  
      const context = renderer.getContext();
      context
        .setFont("Arial", 10, "")
        .setBackgroundFillStyle("rgba(0,0,0,0)");
  
      // äº”ç·š
      const stave = new VF.Stave(10, 20, width - 20);
      stave
        .addClef("treble")
        .addTimeSignature("4/4")
        .addKeySignature(currentKey.id);
      stave.setContext(context).draw();
  
      const degrees = currentDegrees;
      const durations = currentDurations;
  
      // ãƒãƒ¼ãƒˆ
      const notes = degrees.map((deg, idx) => {
        const midi = degreeToMidi(currentKey, deg);
        const vexKey = midiToVexKey(midi, currentKey.naming);
        const durVal = durations[idx] ?? 0.5;
        const durStr = durationToVF(durVal);
  
        const note = new VF.StaveNote({
          clef: "treble",
          keys: [vexKey],
          duration: durStr,
        });
  
        const head = vexKey.split("/")[0];
        if (head.length > 1) {
          const accChar = head[1] === "#" ? "#" : "b";
          note.addAccidental(0, new VF.Accidental(accChar));
        }
  
        return note;
      });
  
      // ä¸‰é€£ç¬¦
      let tuplets = [];
      if (currentPattern.tuplets) {
        tuplets = currentPattern.tuplets.map(t => {
          return new VF.Tuplet(notes.slice(t.from, t.to + 1), {
            num_notes: t.num_notes,
            notes_occupied: t.notes_occupied,
          });
        });
      }
  
      // Voice / Formatter / Beam ã‚’ä¸€æ°—ã«
      VF.Formatter.FormatAndDraw(context, stave, notes, { autobeam: true });
  
      tuplets.forEach(tp => tp.setContext(context).draw());
    }
  
    // --- ãƒ•ãƒ¬ãƒ¼ã‚ºæ›´æ–° ------------------------------
    function renderPhrase() {
      const pattern = pickPattern();
      currentPattern = pattern;
      currentDegrees = pattern.degrees;
      currentDurations = pattern.durations;
  
      const rhythmSymbols = (pattern.durations || [])
        .map(durationToSymbol)
        .join(" ");
      patternLabelEl.textContent =
        `ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼š${pattern.label}` +
        (rhythmSymbols ? ` ï¼ ãƒªã‚ºãƒ ï¼š${rhythmSymbols}` : "");
  
      metaKeyEl.textContent = `ã‚­ãƒ¼ï¼š${currentKey.label}`;
      metaInfoEl.textContent = `5éŸ³ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’ãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆä¸­`;
  
      renderScore();
    }
  
    // --- ã‚¤ãƒ™ãƒ³ãƒˆ ------------------------------
    nextBtn.addEventListener("click", () => {
      renderPhrase();
    });
  
    // ä»Šæ—¥ã®æ—¥ä»˜
    (function setTodayLabel() {
      const d = new Date();
      const y = d.getFullYear();
      const m = d.getMonth() + 1;
      const day = d.getDate();
      const w = ["æ—¥", "æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ"][d.getDay()];
      todayLabel.textContent = `${y}/${m}/${day}ï¼ˆ${w}ï¼‰`;
    })();
  
    // é•·æŠ¼ã—ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç„¡åŠ¹
    document.addEventListener(
      "contextmenu",
      (e) => {
        e.preventDefault();
      },
      { passive: false }
    );
  
    // åˆæœŸè¡¨ç¤º
    renderPhrase();
  
    // ==========================================================
    // ã“ã“ã‹ã‚‰ æ¾æ‘ã§ã™ãƒœã‚¤ã‚¹å†ç”Ÿãƒ‘ãƒ¼ãƒˆ
    // ==========================================================
  
    // WebAudio
    let audioCtx = null;
    function getAudioCtx() {
      if (!audioCtx) {
        const Ctx = window.AudioContext || window.webkitAudioContext;
        if (Ctx) audioCtx = new Ctx();
      }
      return audioCtx;
    }
  
    // éŸ³å£°ãƒãƒƒãƒ•ã‚¡æ ¼ç´å…ˆ
    const phonemeBuffers = {};
  
    // æ¾æ‘ã§ã™ã®éŸ³ç¯€
    const MATSUMURA_PHONEMES = ["ma", "tsu", "mu", "ra", "desu"];
  
    // éŒ²éŸ³æ™‚ã®åŸºæº–ãƒ”ãƒƒãƒï¼ˆE4 â‰’ MIDI 64ï¼‰
    const BASE_MIDI = 64;
    const BASE_FREQ = 440 * Math.pow(2, (BASE_MIDI - 69) / 12);
  
    // m4a ãƒ­ãƒ¼ãƒ‰
    async function loadAudioBuffer(url) {
      const ctx = getAudioCtx();
      const res = await fetch(url);
      const arr = await res.arrayBuffer();
      return await ctx.decodeAudioData(arr);
    }
  
    async function initMatsumuraBuffers() {
      const files = {
        ma: asset("./assets/ma.m4a"),
        tsu: asset("./assets/tsu.m4a"),
        mu: asset("./assets/mu.m4a"),
        ra: asset("./assets/ra.m4a"),
        desu: asset("./assets/desu.m4a"),
      };
      for (const [key, url] of Object.entries(files)) {
        phonemeBuffers[key] = await loadAudioBuffer(url);
      }
    }
  
    // 1éŸ³ã¶ã‚“ã‚’ãƒ”ãƒƒãƒå¤‰æ›ã—ã¦å†ç”Ÿ
    function schedulePhonemeNote(ctx, buffer, targetFreq, durSec, startTime) {
      const src = ctx.createBufferSource();
      src.buffer = buffer;
  
      const rate = targetFreq / BASE_FREQ;
      src.playbackRate.value = rate;
  
      const gain = ctx.createGain();
      const attack = Math.min(0.03, durSec * 0.3);
      const release = Math.min(0.08, durSec * 0.3);
  
      gain.gain.setValueAtTime(0, startTime);
      gain.gain.linearRampToValueAtTime(1, startTime + attack);
      gain.gain.setValueAtTime(1, startTime + durSec - release);
      gain.gain.linearRampToValueAtTime(0, startTime + durSec);
  
      src.connect(gain).connect(ctx.destination);
  
      src.start(startTime);
      src.stop(startTime + durSec + 0.05);
    }
  
    // è­œé¢é€šã‚Šã®æ¾æ‘ã§ã™ã‚’æ­Œã‚ã›ã‚‹æœ¬ä½“
    let isPlayingMatsu = false;
  
    async function playMatsumuraWithScore() {
      if (isPlayingMatsu) return;
      const ctx = getAudioCtx();
      if (!ctx) return;
  
      if (ctx.state === "suspended") await ctx.resume();
  
      if (!phonemeBuffers.ma) {
        await initMatsumuraBuffers();
      }
  
      const degrees = currentDegrees;
      const durations = currentDurations;
      if (!degrees || !durations) return;
  
      const bpm = 100;
      const beatSec = 60 / bpm;
  
      let t = ctx.currentTime + 0.1;
      isPlayingMatsu = true;
  
      for (let i = 0; i < degrees.length; i++) {
        const deg = degrees[i];
        const durBeats = durations[i] ?? 0.5;
        const durSec = durBeats * beatSec;
  
        const midi = degreeToMidi(currentKey, deg);
        const freq = midiToFreq(midi);
  
        let phKey = "desu";
        if (i < 4) phKey = MATSUMURA_PHONEMES[i];
  
        const buffer = phonemeBuffers[phKey];
        if (buffer) {
          schedulePhonemeNote(ctx, buffer, freq, durSec, t);
        }
  
        t += durSec;
      }
  
      const totalMs = (t - ctx.currentTime) * 1000 + 200;
      setTimeout(() => {
        isPlayingMatsu = false;
      }, totalMs);
    }
  
    // å†ç”Ÿãƒœã‚¿ãƒ³ã¨æ¥ç¶š
    playBtn.addEventListener("click", () => {
      playMatsumuraWithScore();
    });
  </script>
</body>
</html>
