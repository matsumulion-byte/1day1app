<!doctype html>
<html lang="ja">
<head>
  <!-- OGP AUTO-GENERATED START (do not edit by hand) -->
  <meta property="og:title" content="ãµãƒ¼ã£ã¦æ¾æ‘ - 12/16 ç´™ã®è¨˜å¿µæ—¥">
  <meta name="twitter:title" content="ãµãƒ¼ã£ã¦æ¾æ‘ - 12/16 ç´™ã®è¨˜å¿µæ—¥">
  <meta property="og:description" content="ãµãƒ¼ã£ã¦æ¾æ‘ æ¯ã‚’å¹ãã‹ã‘ã‚‹ã¨ã€æ¾æ‘ãŒãƒšãƒ©ãƒšãƒ©ã™ã‚‹ã ã‘ã€‚ å¾…æ©Ÿ é¢¨é‡ï¼ˆãƒã‚¤ã‚¯éŸ³é‡ï¼‰ TH: 0.18 / v: 0.00 ğŸ¤ ã¯ã˜ã‚ã‚‹ â–  ã¨ã‚ã‚‹ â€» ãƒã‚¤ã‚¯è¨±å¯ãŒå¿…è¦ï¼ˆHTTPSæ¨å¥¨ï¼‰ï¼iPhoneã¯ãƒœã‚¿ãƒ³æŠ¼ä¸‹å¾Œã«å‹•ãã¾ã™ã€‚ â€» å†…å®¹ã®èªè­˜ã¯ã—ã¾ã›ã‚“ï¼ˆéŸ³é‡ã ã‘ï¼‰ã€‚">
  <meta name="twitter:description" content="ãµãƒ¼ã£ã¦æ¾æ‘ æ¯ã‚’å¹ãã‹ã‘ã‚‹ã¨ã€æ¾æ‘ãŒãƒšãƒ©ãƒšãƒ©ã™ã‚‹ã ã‘ã€‚ å¾…æ©Ÿ é¢¨é‡ï¼ˆãƒã‚¤ã‚¯éŸ³é‡ï¼‰ TH: 0.18 / v: 0.00 ğŸ¤ ã¯ã˜ã‚ã‚‹ â–  ã¨ã‚ã‚‹ â€» ãƒã‚¤ã‚¯è¨±å¯ãŒå¿…è¦ï¼ˆHTTPSæ¨å¥¨ï¼‰ï¼iPhoneã¯ãƒœã‚¿ãƒ³æŠ¼ä¸‹å¾Œã«å‹•ãã¾ã™ã€‚ â€» å†…å®¹ã®èªè­˜ã¯ã—ã¾ã›ã‚“ï¼ˆéŸ³é‡ã ã‘ï¼‰ã€‚">
  <meta property="og:image" content="/2025-12-16/assets/matsu.png">
  <meta name="twitter:image" content="/2025-12-16/assets/matsu.png">
  <meta property="og:url" content="/2025-12-16/">
  <meta property="og:type" content="website">
  <meta name="twitter:card" content="summary_large_image">
  <!-- OGP AUTO-GENERATED END -->

<meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
  <title>ãµãƒ¼ã£ã¦æ¾æ‘ - 12/16 ç´™ã®è¨˜å¿µæ—¥</title>
  <style>
    :root{
      --bg:#050814;
      --panel:#0e1223;
      --ink:#f6f7ff;
      --muted:#9ca3c7;
      --accent:#22c55e;
      --shadow: 0 18px 40px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      background: radial-gradient(1200px 700px at 50% -10%, #1a2450 0%, var(--bg) 60%);
      color:var(--ink);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;

      height: 100svh;
      overflow: hidden;

      display:flex;
      align-items:stretch;
      justify-content:center;
      padding: max(10px, env(safe-area-inset-top)) 10px max(10px, env(safe-area-inset-bottom));
      touch-action: manipulation;
    }
    .app{
      width:min(560px, 100%);
      height: 100%;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .card{
      background: rgba(14,18,35,.82);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow:hidden;

      display:flex;
      flex-direction:column;
      min-height: 0;
    }
    header{
      padding:12px 14px 8px;
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      flex: 0 0 auto;
    }
    h1{font-size:16px; letter-spacing:.04em}
    .sub{font-size:12px; color:var(--muted); margin-top:4px; line-height:1.45}
    .badge{
      font-size:12px; font-weight:900;
      padding:6px 10px; border-radius:999px;
      background: rgba(255,255,255,.12);
      color: rgba(255,255,255,.9);
      white-space:nowrap;
    }

    .stage{
      padding: 0 12px 10px;
      display:flex;
      flex-direction:column;
      gap:10px;
      flex: 1 1 auto;
      min-height: 0;
    }
    .canvasWrap{
      border-radius: 16px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      flex: 1 1 auto;
      min-height: 220px;
      display:flex;
    }
    canvas{ display:block; width:100%; height:100%; }

    .meter{
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.06);
      flex: 0 0 auto;
    }
    .meterTop{
      display:flex; align-items:center; justify-content:space-between;
      font-size:12px; color:var(--muted);
      margin-bottom:8px;
    }
    .bar{
      height:12px;
      border-radius:999px;
      background: rgba(255,255,255,.08);
      overflow:hidden;
      position:relative;
    }
    .fill{
      height:100%;
      width:0%;
      border-radius:999px;
      background: linear-gradient(90deg, rgba(34,197,94,.25), rgba(34,197,94,.95));
    }
    .th{
      position:absolute; top:0; bottom:0; width:2px;
      background: rgba(255,255,255,.35);
      left: 18%;
    }

    .controls{
      display:flex;
      gap:10px;
      padding: 0 12px 12px;
      flex: 0 0 auto;
    }
    button{
      flex:1;
      border:0;
      border-radius: 14px;
      padding: 14px 12px;
      font-weight: 900;
      letter-spacing: .04em;
      cursor:pointer;
      box-shadow: 0 10px 20px rgba(0,0,0,.25);
      transform: translateY(0);
      transition: transform .08s ease, filter .08s ease;
    }
    button:active{transform: translateY(1px); filter: brightness(.95);}
    .btnStart{background: rgba(34,197,94,.95); color:#04130a;}
    .btnStop{
      background: rgba(255,255,255,.08);
      color: var(--ink);
      border:1px solid rgba(255,255,255,.12);
      box-shadow:none;
    }
    button:disabled{opacity:.5; cursor:not-allowed; transform:none;}

    .fine{
      padding: 0 14px 12px;
      font-size:11px;
      color: var(--muted);
      line-height: 1.55;
      flex: 0 0 auto;
    }
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  </style>
</head>
<body>
  <div class="app">
    <div class="card">
      <header>
        <div>
          <h1>ãµãƒ¼ã£ã¦æ¾æ‘</h1>
          <div class="sub">æ¯ã‚’å¹ãã‹ã‘ã‚‹ã¨ã€æ¾æ‘ãŒãƒšãƒ©ãƒšãƒ©ã™ã‚‹ã ã‘ã€‚</div>
        </div>
        <div class="badge" id="badge">å¾…æ©Ÿ</div>
      </header>

      <div class="stage">
        <div class="canvasWrap">
          <canvas id="c"></canvas>
        </div>

        <div class="meter">
          <div class="meterTop">
            <span>é¢¨é‡ï¼ˆãƒã‚¤ã‚¯éŸ³é‡ï¼‰</span>
            <span class="mono">TH:<span id="thVal">0.18</span> / v:<span id="vVal">0.00</span></span>
          </div>
          <div class="bar">
            <div class="th" id="thLine"></div>
            <div class="fill" id="fill"></div>
          </div>
        </div>
      </div>

      <div class="controls">
        <button class="btnStart" id="btnStart">ğŸ¤ ã¯ã˜ã‚ã‚‹</button>
        <button class="btnStop" id="btnStop" disabled>â–  ã¨ã‚ã‚‹</button>
      </div>

      <div class="fine">
        â€» ãƒã‚¤ã‚¯è¨±å¯ãŒå¿…è¦ï¼ˆHTTPSæ¨å¥¨ï¼‰ï¼iPhoneã¯ãƒœã‚¿ãƒ³æŠ¼ä¸‹å¾Œã«å‹•ãã¾ã™ã€‚<br/>
        â€» å†…å®¹ã®èªè­˜ã¯ã—ã¾ã›ã‚“ï¼ˆéŸ³é‡ã ã‘ï¼‰ã€‚
      </div>
    </div>
  </div>

<script type="module">
  // Vercel / ãƒ­ãƒ¼ã‚«ãƒ«ä¸¡å¯¾å¿œã®ãƒ‘ã‚¹è§£æ±º
  const DATE_SEGMENT = (location.pathname.match(/\d{4}-\d{2}-\d{2}/) || [""])[0];
  const DATE_BASE = DATE_SEGMENT ? `/${DATE_SEGMENT}/` : "/";
  const asset = (p) => {
    const clean = String(p || "").replace(/^\.?\//, "");
    return `${DATE_BASE}${clean}`;
  };

  const canvas = document.getElementById("c");
  const ctx = canvas.getContext("2d");

  const badge = document.getElementById("badge");
  const btnStart = document.getElementById("btnStart");
  const btnStop  = document.getElementById("btnStop");
  const fillEl   = document.getElementById("fill");
  const thValEl  = document.getElementById("thVal");
  const vValEl   = document.getElementById("vVal");
  const thLine   = document.getElementById("thLine");

  const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
  const lerp  = (a,b,t)=>a+(b-a)*t;

  // --- Canvas resizeï¼ˆæ½°ã‚Œé˜²æ­¢ï¼šæç”»åº§æ¨™ã¯CSS pxåŸºæº–ï¼‰
  function resizeCanvas(){
    const rect = canvas.getBoundingClientRect();
    const dpr = Math.max(1, Math.min(2.5, window.devicePixelRatio || 1));
    canvas.width  = Math.floor(rect.width  * dpr);
    canvas.height = Math.floor(rect.height * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  window.addEventListener("resize", ()=>{ resizeCanvas(); draw(); }, {passive:true});

  // --- ç”»åƒèª­ã¿è¾¼ã¿
  const matsuImg = new Image();
  matsuImg.src = asset("./assets/matsu.png");
  let imgReady = false;
  matsuImg.onload = ()=>{ imgReady = true; draw(); };
  matsuImg.onerror = ()=>{ imgReady = false; draw(); };

  // --- ãƒã‚¤ã‚¯è§£æ
  let audioCtx = null;
  let analyser = null;
  let stream = null;
  let data = null;
  let rafId = null;
  let running = false;

  const TH = 0.18;
  thValEl.textContent = TH.toFixed(2);
  thLine.style.left = `${TH*100}%`;

  function computeRMS(buf){
    let sum = 0;
    for(let i=0;i<buf.length;i++){
      const x = buf[i];
      sum += x*x;
    }
    const rms = Math.sqrt(sum / buf.length);
    return clamp(rms * 2.4, 0, 1);
  }

  // --- çŠ¶æ…‹ï¼ˆãƒšãƒ©ãƒšãƒ©ï¼‰
  const st = {
    wob: 0,
    ang: 0,
    windSm: 0, // 0..1 å¹³æ»‘åŒ–
    flutter: 0, // â˜…è¿½åŠ ï¼šå®Ÿéš›ã®ãƒšãƒ©ãƒšãƒ©å¼·åº¦ï¼ˆ0..1
  };

  // èƒŒæ™¯ã®ç´™ç²‰ï¼ˆã»ã‚“ã®ã‚Šï¼‰
  const dust = Array.from({length: 70}, ()=>({
    x: Math.random(),
    y: Math.random(),
    r: Math.random()*2.0+0.6,
    s: Math.random()*0.45+0.08
  }));

  function drawBG(W,H){
    const g = ctx.createLinearGradient(0,0,0,H);
    g.addColorStop(0, "rgba(255,255,255,0.05)");
    g.addColorStop(1, "rgba(0,0,0,0.00)");
    ctx.fillStyle = g;
    ctx.fillRect(0,0,W,H);

    ctx.globalAlpha = 0.55;
    ctx.fillStyle = "rgba(255,255,255,0.18)";
    for(const d of dust){
      const x = d.x * W;
      const y = d.y * H;
      ctx.beginPath();
      ctx.arc(x, y, d.r, 0, Math.PI*2);
      ctx.fill();

      d.x -= (0.0014 + d.s*0.0032) * (0.8 + st.windSm*1.7);
      d.y += Math.sin((performance.now()/900) + d.x*12) * 0.00035;
      if(d.x < -0.05){ d.x = 1.05; d.y = Math.random(); }
    }
    ctx.globalAlpha = 1;
  }

  // ç”»åƒã‚’ã€Œæ½°ã•ãšã€ã«ï¼ˆcontainï¼‰ã§è¡¨ç¤ºã—ã¤ã¤ã€æ¨ªã‚¹ãƒ©ã‚¤ã‚¹ã§ãƒšãƒ©ãƒšãƒ©
  function drawFlutterMatsu(W,H){
    if(!imgReady){
      ctx.fillStyle = "rgba(255,255,255,0.75)";
      ctx.font = "800 14px system-ui, -apple-system, 'Segoe UI', sans-serif";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText("ç”»åƒèª­ã¿è¾¼ã¿ä¸­â€¦", W/2, H/2);
      return;
    }

    const iw = matsuImg.naturalWidth;
    const ih = matsuImg.naturalHeight;

    // ç”»é¢å†…ã«åã‚ã‚‹ï¼ˆcontainï¼‰ â†’ ã“ã‚Œã§æ½°ã‚Œãªã„
    const maxW = W * 0.72;
    const maxH = H * 0.78;
    const scale = Math.min(maxW/iw, maxH/ih);

    const dw = iw * scale;
    const dh = ih * scale;

    const cx = W * 0.52;
    const cy = H * 0.52;

    // é¢¨ã§å…¨ä½“ãŒå°‘ã—å‚¾ãï¼ˆç´™æ„Ÿï¼‰
    const tilt = lerp(0.02, -0.22, st.windSm);
    st.ang = lerp(st.ang, tilt, 0.10);

    // ãƒšãƒ©ãƒšãƒ©å‘¨æœŸ
// â˜…æ™®æ®µã¯ã»ã¼æ­¢ã¾ã‚‹ã€‚å¹ã„ãŸæ™‚ã ã‘é€²ã‚€
st.wob += 0.006 + st.flutter*0.55;

// â˜…æŒ¯å¹…ã‚‚ flutter åŸºæº–ï¼ˆæ™®æ®µã¯ã»ã¼æºã‚Œãªã„ï¼‰
const ampX = 0.6 + Math.pow(st.flutter, 1.35) * 18;
const ampY = 0.3 + Math.pow(st.flutter, 1.25) * 12;

    const phase = st.wob;

    ctx.save();
    ctx.translate(cx, cy);
    ctx.rotate(st.ang);

    // å½±ï¼ˆæ¾æ‘ã ã‘ã§ã‚‚æµ®ãï¼‰
    ctx.save();
    ctx.globalAlpha = 0.22;
    ctx.fillStyle = "rgba(0,0,0,0.55)";
    ctx.beginPath();
    ctx.ellipse(0, dh*0.40, dw*0.30, dh*0.07, 0, 0, Math.PI*2);
    ctx.fill();
    ctx.restore();

    // ç”»åƒã‚’æ¨ªã‚¹ãƒ©ã‚¤ã‚¹ã—ã¦æ³¢æ‰“ãŸã›ã‚‹ï¼ˆã‚¢ã‚¹ãƒšã‚¯ãƒˆç¶­æŒã®ã¾ã¾ï¼‰
    const slices = 28;
    const sliceH = dh / slices;
    const srcSliceH = ih / slices;

    for(let i=0;i<slices;i++){
      const t = i/(slices-1); // 0..1
      const y = (-dh/2) + i*sliceH;

      const dx = Math.sin(phase*1.05 + t*6.4) * ampX;
      const dy = Math.sin(phase*0.90 + t*5.1 + 0.8) * ampY;

      ctx.drawImage(
        matsuImg,
        0, i*srcSliceH, iw, srcSliceH,
        (-dw/2) + dx, y + dy, dw, sliceH + 1
      );
    }

    // é¢¨ãƒ©ã‚¤ãƒ³ï¼ˆå¹ã„ã¦ã‚‹æ™‚ã ã‘ï¼‰
    if(st.windSm > TH){
      const a = clamp((st.windSm-TH)/0.6, 0, 1);
      ctx.globalAlpha = 0.10 + a*0.20;
      ctx.strokeStyle = "rgba(34,197,94,1)";
      ctx.lineWidth = 2;
      ctx.setLineDash([10, 10]);
      for(let k=0;k<4;k++){
        const yy = (-dh*0.18) + k*(dh*0.14);
        ctx.beginPath();
        ctx.moveTo(-dw/2 - 90, yy);
        ctx.lineTo(-dw/2 - 10, yy + Math.sin(phase*0.9 + k)*6);
        ctx.stroke();
      }
      ctx.setLineDash([]);
      ctx.globalAlpha = 1;
    }

    ctx.restore();
  }

  function draw(){
    const W = canvas.getBoundingClientRect().width;
    const H = canvas.getBoundingClientRect().height;

    ctx.clearRect(0,0,W,H);
    drawBG(W,H);
    drawFlutterMatsu(W,H);

    ctx.save();
    ctx.fillStyle = "rgba(255,255,255,0.14)";
    ctx.font = "800 12px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace";
    ctx.textAlign = "left";
    ctx.fillText("BLOW TO FLUTTER", 12, 18);
    ctx.restore();

    if(!running){
      ctx.save();
      ctx.fillStyle = "rgba(5,8,20,0.45)";
      ctx.fillRect(0,0,W,H);
      ctx.fillStyle = "rgba(255,255,255,0.92)";
      ctx.font = "900 26px system-ui, -apple-system, 'Segoe UI', sans-serif";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText("ğŸ¤ ãƒã‚¤ã‚¯ã§ã€Œãµãƒ¼ã€", W/2, H*0.46);
      ctx.fillStyle = "rgba(255,255,255,0.70)";
      ctx.font = "700 14px system-ui, -apple-system, 'Segoe UI', sans-serif";
      ctx.fillText("æ¯ã‚’å¹ãã‹ã‘ã‚‹ã¨ãƒšãƒ©ãƒšãƒ©ã—ã¾ã™", W/2, H*0.54);
      ctx.restore();
    }
  }

  function tick(){
  if(!running) return;

  analyser.getFloatTimeDomainData(data);
  const v = computeRMS(data);

  vValEl.textContent = v.toFixed(2);
  fillEl.style.width = `${clamp(v*100,0,100)}%`;

  // é¢¨é‡ã®å¹³æ»‘åŒ–ï¼ˆç’°å¢ƒå·®ã‚’å¸åï¼‰
  const k = v > st.windSm ? 0.18 : 0.06;
  st.windSm = lerp(st.windSm, v, k);

  // â˜…ã—ãã„å€¤ã€Œã£ã½ãã€ã™ã‚‹ã‘ã©ã€åˆ‡ã‚Šæ›¿ãˆãªã„ï¼ˆsoft kneeï¼‰
  // THä»˜è¿‘ã‹ã‚‰ãƒŒãƒ«ãƒƒã¨ç«‹ã¡ä¸ŠãŒã‚‹
  const knee = 0.10; // å¤§ãã„ã»ã©æŸ”ã‚‰ã‹ã„
  const raw = (st.windSm - (TH - knee)) / (0.55 + knee); // ã ã„ãŸã„0..1ã¸
  const target = clamp(raw, 0, 1);

  // â˜…flutterã¯ã‚¹ãƒ—ãƒªãƒ³ã‚°ã£ã½ãè¿½å¾“ï¼ˆä¸Šã‚‚ä¸‹ã‚‚ãªã‚ã‚‰ã‹ï¼‰
  const follow = 0.16; // è¿½å¾“ã‚¹ãƒ”ãƒ¼ãƒ‰ï¼ˆå°ã•ã„ã»ã©æŸ”ã‚‰ã‹ã„ï¼‰
  st.flutter = lerp(st.flutter, target, follow);

  draw();
  rafId = requestAnimationFrame(tick);
}


  async function startMic(){
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    await audioCtx.resume();

    stream = await navigator.mediaDevices.getUserMedia({
      audio: { echoCancellation:true, noiseSuppression:true, autoGainControl:true },
      video: false
    });

    const src = audioCtx.createMediaStreamSource(stream);
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 2048;
    analyser.smoothingTimeConstant = 0.85;
    src.connect(analyser);

    data = new Float32Array(analyser.fftSize);

    running = true;
    badge.textContent = "ãµãƒ¼å¾…ã¡";
    btnStart.disabled = true;
    btnStop.disabled = false;

    draw();
    rafId = requestAnimationFrame(tick);
  }

  function stopMic(){
    running = false;
    badge.textContent = "åœæ­¢";
    btnStart.disabled = false;
    btnStop.disabled = true;

    if(rafId){ cancelAnimationFrame(rafId); rafId = null; }
    if(stream){
      stream.getTracks().forEach(t=>t.stop());
      stream = null;
    }
    if(audioCtx){
      try{ audioCtx.close(); }catch(e){}
      audioCtx = null;
    }
    analyser = null;
    data = null;

    const unwind = ()=>{
      st.windSm = lerp(st.windSm, 0, 0.08);
      draw();
      if(st.windSm > 0.002) requestAnimationFrame(unwind);
      else { st.windSm = 0; draw(); }
    };
    unwind();
  }

  btnStart.addEventListener("click", async ()=>{
    badge.textContent = "æº–å‚™ä¸­â€¦";
    try{
      await startMic();
    }catch(err){
      console.error(err);
      badge.textContent = "ãƒã‚¤ã‚¯ä¸å¯";
      btnStart.disabled = false;
      btnStop.disabled = true;
      draw();
      alert("ãƒã‚¤ã‚¯ã®è¨±å¯ãŒå¿…è¦ã§ã™ï¼ˆHTTPSç’°å¢ƒã§ãŠè©¦ã—ãã ã•ã„ï¼‰");
    }
  });

  btnStop.addEventListener("click", stopMic);

  // åˆæœŸåŒ–
  resizeCanvas();
  draw();
</script>
</body>
</html>
