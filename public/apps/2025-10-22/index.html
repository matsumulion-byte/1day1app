<!doctype html>
<html lang="ja">
<head>
  <!-- OGP AUTO-GENERATED START (do not edit by hand) -->
  <meta property="og:title" content="SAFE DROP - Parachute Day">
  <meta name="twitter:title" content="SAFE DROP - Parachute Day">
  <meta property="og:description" content="ğŸª‚ SAFE DROP BEST: 0 ğŸª‚ ãƒ‘ãƒ©ã‚·ãƒ¥ãƒ¼ãƒˆã‚’é–‹ã‘ï¼ è½ä¸‹ä¸­ã€ ç·‘ã®å®‰å…¨é«˜åº¦ ã§ã‚¿ãƒƒãƒ—ã—ã¦ãƒ‘ãƒ©ã‚·ãƒ¥ãƒ¼ãƒˆã‚’é–‹ã“ã†ã€‚ é–‹ã„ãŸã‚‰ ç«¯æœ«ã®å‚¾ã or å·¦å³ãƒœã‚¿ãƒ³ ã§ã‚¿ãƒ¼ã‚²ãƒƒãƒˆä¸­å¿ƒã‚’ç‹™ã£ã¦ç€åœ°ã€‚ å®‰å…¨é«˜åº¦ã§é–‹ã: +100ã€œ300 ç€åœ°ç²¾åº¦ãƒœãƒ¼ãƒŠã‚¹: 0ã€œ700 ã©é…ã‚Œ/åœ°">
  <meta name="twitter:description" content="ğŸª‚ SAFE DROP BEST: 0 ğŸª‚ ãƒ‘ãƒ©ã‚·ãƒ¥ãƒ¼ãƒˆã‚’é–‹ã‘ï¼ è½ä¸‹ä¸­ã€ ç·‘ã®å®‰å…¨é«˜åº¦ ã§ã‚¿ãƒƒãƒ—ã—ã¦ãƒ‘ãƒ©ã‚·ãƒ¥ãƒ¼ãƒˆã‚’é–‹ã“ã†ã€‚ é–‹ã„ãŸã‚‰ ç«¯æœ«ã®å‚¾ã or å·¦å³ãƒœã‚¿ãƒ³ ã§ã‚¿ãƒ¼ã‚²ãƒƒãƒˆä¸­å¿ƒã‚’ç‹™ã£ã¦ç€åœ°ã€‚ å®‰å…¨é«˜åº¦ã§é–‹ã: +100ã€œ300 ç€åœ°ç²¾åº¦ãƒœãƒ¼ãƒŠã‚¹: 0ã€œ700 ã©é…ã‚Œ/åœ°">
  <meta property="og:image" content="/2025-10-22/assets/player.png">
  <meta name="twitter:image" content="/2025-10-22/assets/player.png">
  <meta property="og:url" content="/2025-10-22/">
  <meta property="og:type" content="website">
  <meta name="twitter:card" content="summary_large_image">
  <!-- OGP AUTO-GENERATED END -->

<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
<title>SAFE DROP - Parachute Day</title>
<style>
  :root{
    --bg:#0b1017; --fg:#e9f1f7; --muted:#97a6b3; --acc:#4fd1c5; --danger:#ff5b6e; --ok:#90e06b;
  }
  *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
  html,body{ height:100%; margin:0; }
  body{
    font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN","Yu Gothic", sans-serif;
    color:var(--fg); background: radial-gradient(1200px 800px at 60% -10%, #17202a 0%, var(--bg) 60%);
    display:grid; place-items:center;
  }
  .wrap{ width:100%; max-width:520px; height:100dvh; max-height:100dvh; display:flex; flex-direction:column; }
  header{ padding:10px 14px; display:flex; align-items:center; justify-content:space-between; gap:10px; }
  header .title{ font-weight:700; letter-spacing:.3px; }
  header .score{ font-variant-numeric:tabular-nums; color:var(--muted); }
  canvas{ width:100%; height:100%; flex:1; display:block; background:linear-gradient(#5fb3ff 0%, #a5d9ff 40%, #e7f6ff 60%, #dbe8ef 100%); border-top:1px solid rgba(255,255,255,.08); border-bottom:1px solid rgba(0,0,0,.25)}
  .hud {
  position: absolute;
  top: 10px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 10px;
  pointer-events: none;
  z-index: 10;
}

  .btns{ position:fixed; left:0; right:0; bottom:0; padding:10px 12px 14px; display:flex; gap:12px; background:linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(0,0,0,.30) 40%); }
  .btn{ flex:1; padding:14px 10px; border-radius:14px; border:1px solid rgba(255,255,255,.15); background:rgba(255,255,255,.06); color:var(--fg); font-weight:700; letter-spacing:.2px; backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px); box-shadow: inset 0 0 0 1px rgba(255,255,255,.06), 0 10px 20px rgba(0,0,0,.25); pointer-events:auto; user-select:none; text-align:center; }
  .btn:active{ transform:translateY(1px); }
  .btn.primary{ background:linear-gradient(180deg, rgba(79,209,197,.9), rgba(79,209,197,.7)); color:#072d2a }
  .hud {
  position: absolute;
  top: 10px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 10px;
  pointer-events: none;
  z-index: 10;
}
  .msg{ position:absolute; left:50%; top:18%; transform:translateX(-50%); padding:10px 14px; border-radius:12px; background:rgba(0,0,0,.35); border:1px solid rgba(255,255,255,.15); color:var(--fg); text-align:center; max-width:90%; }
  .center{ position:absolute; inset:0; display:grid; place-items:center; pointer-events:none; }
  .card{ pointer-events:auto; background:rgba(8,12,16,.85); border:1px solid rgba(255,255,255,.12); border-radius:16px; box-shadow: 0 20px 40px rgba(0,0,0,.5); padding:18px; width:min(92%,440px); }
  .card h1{ margin:0 0 8px; font-size:20px }
  .card p{ margin:6px 0; color:var(--muted); line-height:1.5 }
  .row{ display:flex; gap:8px; margin-top:12px }
  .row .btn{ flex:1 }
  .chips{ display:flex; flex-wrap:wrap; gap:6px; margin-top:8px }
  .chip{ font-size:11px; padding:4px 8px; border-radius:999px; background:#0f1720; border:1px solid rgba(255,255,255,.1); color:#b7c3cf }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="title">ğŸª‚ SAFE DROP</div>
    <div class="score">
      <span id="best" class="pill">BEST: 0</span>
    </div>
  </header>
  <canvas id="game" width="360" height="640" aria-label="game"></canvas>

  <!-- ä¸­å¤®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
  <div id="message" class="msg" hidden></div>

  <!-- é–‹å§‹/ãƒªã‚¶ãƒ«ãƒˆ -->
  <div id="overlay" class="center">
    <div class="card">
      <h1>ğŸª‚ ãƒ‘ãƒ©ã‚·ãƒ¥ãƒ¼ãƒˆã‚’é–‹ã‘ï¼</h1>
      <p>è½ä¸‹ä¸­ã€<b>ç·‘ã®å®‰å…¨é«˜åº¦</b>ã§ã‚¿ãƒƒãƒ—ã—ã¦ãƒ‘ãƒ©ã‚·ãƒ¥ãƒ¼ãƒˆã‚’é–‹ã“ã†ã€‚<br>
      é–‹ã„ãŸã‚‰<b>ç«¯æœ«ã®å‚¾ã</b> or <b>å·¦å³ãƒœã‚¿ãƒ³</b>ã§ã‚¿ãƒ¼ã‚²ãƒƒãƒˆä¸­å¿ƒã‚’ç‹™ã£ã¦ç€åœ°ã€‚</p>
      <div class="chips">
        <span class="chip">å®‰å…¨é«˜åº¦ã§é–‹ã: +100ã€œ300</span>
        <span class="chip">ç€åœ°ç²¾åº¦ãƒœãƒ¼ãƒŠã‚¹: 0ã€œ700</span>
        <span class="chip">ã©é…ã‚Œ/åœ°é¢æ¿€çª: å¤±æ•—</span>
      </div>
      <div class="row">
        <button id="play" class="btn primary">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
        <button id="how" class="btn">éŠã³æ–¹</button>
      </div>
    </div>
  </div>

  <!-- HUDï¼ˆé«˜åº¦è¡¨ç¤ºï¼‰ -->
  <div class="hud" id="hud" hidden>
    <span class="pill" id="altPill">ALT: 0m</span>
    <span class="pill" id="windPill">WIND: 0</span>
  </div>

  <!-- æ“ä½œãƒœã‚¿ãƒ³ -->
  <div class="btns">
    <button id="left" class="btn">â†</button>
    <button id="open" class="btn primary">é–‹ã</button>
    <button id="right" class="btn">â†’</button>
  </div>
</div>

<script type="module">
/* ============================================================
   1æ—¥1ã‚¢ãƒ—ãƒªè¦ç´„ï¼šå‹•çš„ã‚¢ã‚»ãƒƒãƒˆã¯ asset() ã§å‚ç…§
   ============================================================ */
const asset = (p) => new URL(p, import.meta.url).toString();

/* ============================================================
   ç”»åƒï¼ˆè½ä¸‹ç‰©ï¼ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ï¼‰
   ============================================================ */
const IMAGES = {
  player: new Image(), // ä¾‹: 32ã€œ64pxå››æ–¹ãƒ»é€éPNGæ¨å¥¨
};
IMAGES.player.decoding = 'async';
IMAGES.player.src = asset('/2025-10-22/assets/player.png');
const IMG_READY = { player:false };
IMAGES.player.addEventListener('load', ()=> IMG_READY.player = true);

/* ============================================================
   åŸºæœ¬ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
   ============================================================ */
const cvs = document.getElementById('game');
const ctx = cvs.getContext('2d');
const DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
function fitCanvas(){
  const w = 360, h = 640;
  cvs.width = Math.floor(w * DPR);
  cvs.height = Math.floor(h * DPR);
  cvs.style.width = '100%';
  ctx.setTransform(DPR,0,0,DPR,0,0);
}
fitCanvas();
addEventListener('resize', fitCanvas);

/* ============================================================
   ã‚²ãƒ¼ãƒ çŠ¶æ…‹
   ============================================================ */
const STATE = { idle:'idle', falling:'falling', canopy:'canopy', landed:'landed', fail:'fail' };
let state = STATE.idle;
let tLast = 0; let rafId = 0;
// ç€åœ°ç‚¹ã®å¯è¦–åŒ–ç”¨ï¼ˆåˆ¤å®šã¨è¦‹ãŸç›®ã®ã‚ºãƒ¬ç¢ºèª/æ¼”å‡ºï¼‰
let lastLandingX = null;

const world = { width:360, height:640, groundY:600, safeTop:240, safeBottom:360, targetX:180 };

// è¶³å…ƒã‚ªãƒ•ã‚»ãƒƒãƒˆï¼ˆæç”»åŸºæº–ç‚¹â†’è¶³å…ˆï¼‰
const FOOT_OFFSET = 14;

// è¿½åŠ ï¼šã‚­ãƒ£ãƒãƒ”ãƒ¼ã¨ãƒ©ã‚¤ã‚¶ãƒ¼ã®åŸºæº–
const CANOPY_BASE_Y = -18;        // ã‚­ãƒ£ãƒãƒ”ãƒ¼ä¸‹ç«¯ï¼ˆdrawCanopyã®åŸºæº–ï¼‰
const RISER_TOP_Y   = CANOPY_BASE_Y - 2;
const RISER_SIDE_X  = 20;         // ã‚­ãƒ£ãƒãƒ”ãƒ¼å´ã®å·¦å³ä½ç½®
const HARNESS_SIDE_X = 10;        // è‚©ï¼ˆã‚­ãƒ£ãƒ©å´ï¼‰ã®å·¦å³ä½ç½®
const HARNESS_ANCHOR_RATIO = 0.30; // ç”»åƒé«˜ã•ã«å¯¾ã™ã‚‹è‚©ã®é«˜ã•(0..1)

// è¿½åŠ ï¼šãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç”»åƒã®æœ€å¤§ã‚µã‚¤ã‚ºï¼ˆè«–ç†pxï¼‰
const PLAYER_MAX_W = 48;   // æ¨ªã®æœ€å¤§å¹…
const PLAYER_MAX_H = 48;   // ç¸¦ã®æœ€å¤§é«˜

const player = {
  x:180, y:60,
  vx:0,
  vy:0.35,        // ã‚†ã£ãã‚Šç›®ã®åˆæœŸè½ä¸‹é€Ÿåº¦
  maxVy:10,
  wind:0,
  canopyOpen:false,
  canopyDrag:0.05, // é–‹å‚˜æ™‚ã®åˆ¶å‹•ã‚’ã‚„ã‚„å¼·ã
  bodyDrag:0.002,  // ç©ºæ°—æŠµæŠ—ã‚’å¼·ã‚
  steer:0,
};

const rng = (a,b) => a + Math.random()*(b-a);
let score = 0;
let best = Number(localStorage.getItem('safe_drop_best')||0);

/* ============================================================
   UI
   ============================================================ */
const overlay = document.getElementById('overlay');
function showOverlay(show){
  overlay.hidden = !show;
  overlay.style.display = show ? 'grid' : 'none';
}

const playBtn = document.getElementById('play');
const howBtn = document.getElementById('how');
const msg = document.getElementById('message');
const altPill = document.getElementById('altPill');
const windPill = document.getElementById('windPill');
const hud = document.getElementById('hud');
const bestEl = document.getElementById('best');
bestEl.textContent = `BEST: ${best}`;

const leftBtn = document.getElementById('left');
const rightBtn = document.getElementById('right');
const openBtn = document.getElementById('open');

/* ============================================================
   å…¥åŠ›
   ============================================================ */
let holdLeft=false, holdRight=false;
leftBtn.addEventListener('pointerdown', ()=>holdLeft=true);
leftBtn.addEventListener('pointerup', ()=>holdLeft=false);
leftBtn.addEventListener('pointerleave', ()=>holdLeft=false);
rightBtn.addEventListener('pointerdown', ()=>holdRight=true);
rightBtn.addEventListener('pointerup', ()=>holdRight=false);
rightBtn.addEventListener('pointerleave', ()=>holdRight=false);
openBtn.addEventListener('click', tryOpenCanopy);

addEventListener('keydown', (e)=>{
  if(e.key==='ArrowLeft') holdLeft = true;
  if(e.key==='ArrowRight') holdRight = true;
  if(e.key===' ' || e.key==='Enter') tryOpenCanopy();
});
addEventListener('keyup', (e)=>{
  if(e.key==='ArrowLeft') holdLeft = false;
  if(e.key==='ArrowRight') holdRight = false;
});

let gyroEnabled = false; let tilt = 0; // -1..1
if (window.DeviceOrientationEvent) {
  const req = DeviceOrientationEvent.requestPermission?.bind(DeviceOrientationEvent);
  howBtn.addEventListener('click', async ()=>{
    alert('ç«¯æœ«ã‚’å‚¾ã‘ã‚‹ã¨ãƒ‘ãƒ©ã‚·ãƒ¥ãƒ¼ãƒˆã‚’å·¦å³ã«æ“ç¸¦ã§ãã¾ã™ï¼ˆè¨±å¯ãŒå¿…è¦ãªå ´åˆãŒã‚ã‚Šã¾ã™ï¼‰ã€‚\nè¨±å¯ã§ããªã„/PCã§ã¯å·¦å³ãƒœã‚¿ãƒ³ã§æ“ä½œã—ã¦ãã ã•ã„ã€‚');
    if(req){ try{ const r = await req(); gyroEnabled = (r==='granted'); }catch{} }
  });
  addEventListener('deviceorientation', (e)=>{
    if(!gyroEnabled && DeviceOrientationEvent.requestPermission) return;
    const g = (e.gamma||0);
    tilt = Math.max(-1, Math.min(1, g/35));
  });
}

/* ============================================================
   é¢¨ãƒ¢ãƒ‡ãƒ«
   ============================================================ */
let windTimer = 0;
function updateWind(dt){
  windTimer -= dt;
  if(windTimer <= 0){
    player.wind = rng(-0.35, 0.35);
    windTimer = rng(700, 1600);
  }
}

/* ============================================================
   ã‚¹ã‚³ã‚¢
   ============================================================ */
function scoreForOpen(y){
  const center = (world.safeTop + world.safeBottom) / 2;
  const d = Math.abs(y - center);
  const maxD = (world.safeBottom - world.safeTop)/2;
  const pct = Math.max(0, 1 - (d/maxD));
  return Math.round(100 + 200*pct);
}
function scoreForLanding(dx){
  const max = 700, falloff = 180;
  const s = Math.max(0, max*(1 - Math.min(1, Math.abs(dx)/falloff)));
  return Math.round(s);
}

/* ============================================================
   åˆ¶å¾¡
   ============================================================ */
function reset(){
  state = STATE.falling;
  player.x = 180; player.y = 60;
  player.vx = 0; player.vy = 0.35;
  player.canopyOpen = false;
  player.steer = 0; tilt = 0;
  player.wind = rng(-0.2,0.2);
  windTimer = rng(600, 1200);

  const baseTop = 220, band = 140;
  world.safeTop = Math.round(rng(baseTop-20, baseTop+40));
  world.safeBottom = world.safeTop + band;
  world.targetX = Math.round(rng(80, world.width-80));

  score = 0;
  msg.hidden = true; showOverlay(false); hud.hidden = false;

  cancelAnimationFrame(rafId); tLast = performance.now();
  loop(tLast);
}
playBtn.addEventListener('click', reset);

function end(success, landingScore=0){
  state = success ? STATE.landed : STATE.fail; 
  hud.hidden = true;

  // å®Œå…¨åœæ­¢ï¼šé€Ÿåº¦ãƒ»é¢¨ãƒ»å…¥åŠ›ã‚’ã‚¼ãƒ­åŒ–
  player.vx = 0; player.vy = 0; player.wind = 0; player.steer = 0;
  holdLeft = false; holdRight = false;
  // è¶³å…ƒã‚’åœ°é¢ã«ã‚¹ãƒŠãƒƒãƒ—
  player.y = world.groundY - FOOT_OFFSET;

  const total = success ? (score + landingScore) : 0;
  if(success){
    best = Math.max(best, total);
    localStorage.setItem('safe_drop_best', String(best));
    bestEl.textContent = `BEST: ${best}`;
  }
  showOverlay(true);
  overlay.querySelector('.card').innerHTML = success ? `
    <h1>ğŸª‚ ç€åœ°æˆåŠŸï¼</h1>
    <p>é–‹å‚˜ãƒœãƒ¼ãƒŠã‚¹: <b>${score}</b><br>ç€åœ°ç²¾åº¦: <b>${landingScore}</b><br><br>
    <b>åˆè¨ˆ: ${total}</b></p>
    <div class="row">
      <button class="btn primary" id="replay">ã‚‚ã†ä¸€åº¦</button>
      <button class="btn" id="tips">ã‚³ãƒ„</button>
    </div>` : `
    <h1>ğŸ’¥ ç€åœ°å¤±æ•—â€¦</h1>
    <p>é…ã™ãã‚‹/é€Ÿåº¦ãŒé«˜ã™ãã¦åˆ¶å¾¡ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚<br>å®‰å…¨é«˜åº¦ã®<b>ä¸­å¤®ä»˜è¿‘</b>ã§é–‹ãã®ãŒã‚³ãƒ„ã€‚</p>
    <div class="row">
      <button class="btn primary" id="replay">å†æŒ‘æˆ¦</button>
      <button class="btn" id="tips">ãƒ’ãƒ³ãƒˆ</button>
    </div>`;
  overlay.querySelector('#replay').addEventListener('click', reset);
  overlay.querySelector('#tips').addEventListener('click', ()=>{
    alert('ãƒ»ç·‘ã®å¸¯ã®ã€Œä¸­å¤®ã€ã§é–‹ãã¨æ¸›é€ŸãŒå®‰å®šã—ã€å¾—ç‚¹ã‚‚é«˜ã„ã€‚\nãƒ»é¢¨ã¯ä¸€å®šæ™‚é–“ã”ã¨ã«å‘ã/å¼·ã•ãŒå¤‰ã‚ã‚‹ã€‚é–‹ã„ãŸå¾Œã¯ç«¯æœ«ã‚’å‚¾ã‘ã¦å¾®èª¿æ•´ã€‚\nãƒ»ç«¯æœ«ã‚’å‚¾ã‘ã‚‰ã‚Œãªã„å ´åˆã¯å·¦å³ãƒœã‚¿ãƒ³ã§OKã€‚');
  });
}

function tryOpenCanopy(){
  if(state !== STATE.falling) return;
  const footY = player.y + FOOT_OFFSET;
  if(player.y < world.safeTop){
    flash('æ—©ã™ãã‚‹ï¼ ã‚‚ã†å°‘ã—ä¸‹ã§é–‹ã“ã†');
    return;
  }
  // è¶³å…ƒåŸºæº–ã§ã€Œè¿‘ã™ãã€åˆ¤å®š
  if(footY > world.groundY - 120){
    openCanopy(); // ã»ã¼å¤±æ•—ã ãŒè¨±å¯
    return;
  }
  openCanopy();
}

function openCanopy(){
  if(player.canopyOpen) return;
  player.canopyOpen = true; state = STATE.canopy;
  const add = scoreForOpen(player.y);
  score += add; flash(`é–‹å‚˜ +${add}`);
}

/* ============================================================
   ãƒ«ãƒ¼ãƒ—
   ============================================================ */
function loop(t){
  const dt = Math.min(50, t - tLast); tLast = t;
  step(dt); render();
  rafId = requestAnimationFrame(loop);
}

function step(dt){
  // ç€åœ°/å¤±æ•—å¾Œã¯ç‰©ç†æ›´æ–°ã‚’å®Œå…¨åœæ­¢ï¼ˆãƒ‰ãƒªãƒ•ãƒˆé˜²æ­¢ï¼‰
  if(state===STATE.landed || state===STATE.fail){ return; }
  updateWind(dt);
  const steerBtn = (holdRight?1:0) - (holdLeft?1:0);
  player.steer = clamp(steerBtn*0.9 + tilt*0.7, -1, 1);

  // æ¨ª
  const steerAccel = player.canopyOpen ? 0.08 : 0.02;
  player.vx += player.wind*0.02*dt + player.steer*steerAccel*dt;
  player.vx *= 0.992; // æ‘©æ“¦
  player.x += player.vx;

  // ç¸¦ï¼ˆã‚†ã£ãã‚ŠåŒ–ï¼‰
  if(!player.canopyOpen){
    player.vy = Math.min(player.maxVy, player.vy + 0.006*dt); // é‡åŠ›å¼±ã‚
    player.vy *= (1 - player.bodyDrag*dt);                    // æŠµæŠ—å¼·ã‚
  }else{
    player.vy = Math.max(0.6, player.vy - player.canopyDrag*dt);
  }
  player.y += player.vy*dt*0.09; // è·é›¢ã‚¹ã‚±ãƒ¼ãƒ«ã‚’å°ã•ã

  // ç«¯
  player.x = clamp(player.x, 12, world.width-12);

  // åœ°é¢ï¼ˆè¶³å…ƒåŸºæº–ï¼‰
  const footY = player.y + FOOT_OFFSET;
  if(footY >= world.groundY){
    // ã‚¹ãƒŠãƒƒãƒ—ã—ã¦åˆ¤å®šã¨è¦‹ãŸç›®ã‚’å®Œå…¨ä¸€è‡´
    player.y = world.groundY - FOOT_OFFSET;
    lastLandingX = player.x;
    if(!player.canopyOpen){ end(false); return; }
    const dx = lastLandingX - world.targetX; const bonus = scoreForLanding(dx);
    end(true, bonus); return;
  }

  // HUDï¼ˆè¶³å…ƒåŸºæº–ã®é«˜åº¦è¡¨ç¤ºï¼‰
  const altitude = Math.max(0, Math.round(world.groundY - footY));
  altPill.textContent = `ALT: ${altitude}m`;
  windPill.textContent = `WIND: ${player.wind>=0?'+':''}${player.wind.toFixed(2)}`;
}

function clamp(v,a,b){ return Math.max(a, Math.min(b,v)); }

/* ============================================================
   æç”»
   ============================================================ */
function render(){
  const w = world.width, h = world.height;
  ctx.clearRect(0,0,w,h);
  drawSky();
  // å®‰å…¨å¸¯
  ctx.save(); ctx.globalAlpha = 0.18; ctx.fillStyle = '#74ff8a';
  ctx.fillRect(0, world.safeTop, w, world.safeBottom-world.safeTop); ctx.restore();
  drawTarget(world.targetX, world.groundY);
  drawGround();
  drawPlayer();
  // ç€åœ°ç‚¹ãƒãƒ¼ã‚«ãƒ¼ï¼ˆåˆ¤å®šç”¨ã®å®Ÿéš›ã®è¶³ä¸‹ä½ç½®ï¼‰
  if(lastLandingX!==null && (state===STATE.landed || state===STATE.fail)){
    drawTouchMarker(lastLandingX, world.groundY);
  }
  if(state===STATE.falling){
    ctx.save(); ctx.globalAlpha = 0.7; ctx.fillStyle = '#122018';
    ctx.fillRect(10, world.safeTop-18, 120, 16);
    ctx.fillStyle = '#90e06b'; ctx.font = '12px system-ui, sans-serif';
    ctx.fillText('ã“ã“ã§é–‹ãï¼', 16, world.safeTop-6); ctx.restore();
  }
}

function drawSky(){
  const t = performance.now()/1000;
  for(let i=0;i<8;i++){
    const y = 80 + (i*50) + Math.sin(t*0.2 + i)*8;
    const x = ((t*20 + i*90) % (world.width+120)) - 60;
    cloud(x, y, 1 + (i%3)*0.15);
  }
  function cloud(x,y,s){
    ctx.save(); ctx.translate(x,y); ctx.scale(s,s);
    ctx.fillStyle = 'rgba(255,255,255,.75)';
    roundRect(-24,-10,48,20,10); ctx.fill();
    roundRect(-14,-16,28,18,9); ctx.fill();
    roundRect(4,-12,20,16,8); ctx.fill();
    ctx.restore();
  }
}

function drawGround(){
  ctx.save();
  ctx.fillStyle = '#75b86b';
  ctx.fillRect(0, world.groundY, world.width, world.height - world.groundY);
  ctx.globalAlpha = 0.25; ctx.fillStyle = '#6aaa61';
  for(let x=-40; x<world.width+100; x+=40){
    ctx.beginPath();
    ctx.moveTo(x, world.groundY);
    ctx.lineTo(x+20, world.groundY);
    ctx.lineTo(x+80, world.height);
    ctx.lineTo(x+60, world.height);
    ctx.closePath(); ctx.fill();
  }
  ctx.restore();
}

function drawTarget(cx, gy){
  ctx.save(); const r = 26;
  // çš„ï¼ˆåœ°é¢ã‚»ãƒ³ã‚¿ãƒ¼=gyã«æƒãˆã‚‹ï¼‰
  for(let i=3;i>=1;i--){
    ctx.beginPath(); ctx.arc(cx, gy, r*i/3, 0, Math.PI*2);
    ctx.fillStyle = (i%2)?'#ffffff':'#ff5b6e'; ctx.fill();
  }
  // æ——ï¼ˆæ”¯æŸ±ã¯åœ°é¢ã‹ã‚‰ï¼‰
  ctx.strokeStyle = '#3a3a3a'; ctx.lineWidth = 2;
  ctx.beginPath(); ctx.moveTo(cx, gy); ctx.lineTo(cx, gy-32); ctx.stroke();
  ctx.fillStyle = '#4fd1c5';
  ctx.beginPath(); ctx.moveTo(cx, gy-32); ctx.lineTo(cx+18, gy-28); ctx.lineTo(cx, gy-24); ctx.closePath(); ctx.fill();
  ctx.restore();
}

function drawPlayer(){
  ctx.save();
  ctx.translate(player.x, player.y);

  // å½±ãªã©â€¦ï¼ˆæ—¢å­˜ã®ã¾ã¾ï¼‰

  // 1) ã‚­ãƒ£ãƒãƒ”ãƒ¼ï¼ˆé–‹å‚˜æ™‚ã®ã¿ï¼‰
  if (player.canopyOpen){
    ctx.save();
    const swing = (state===STATE.landed || state===STATE.fail) ? 0 :
      Math.sin(performance.now()/300 + player.x*0.02) * 6 * player.steer;
    ctx.rotate(swing * Math.PI/180);
    drawCanopy();                  // â† å…ˆã«ã‚­ãƒ£ãƒãƒ”ãƒ¼ã‚’æç”»
    ctx.restore();
  }

  // 2) æœ¬ä½“ï¼ˆç”»åƒå„ªå…ˆï¼‰
  let harnessYForLines = -6;       // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ™‚ã®è‚©é«˜ã•åˆæœŸå€¤
  if (IMG_READY.player){
    const iw = IMAGES.player.naturalWidth, ih = IMAGES.player.naturalHeight;

    // ç”»åƒã‚’æœ€å¤§48x48ä»¥å†…ã«åã‚ã‚‹ï¼ˆå¤§ãã™ãå¯¾å¿œï¼‰
    const PLAYER_MAX_W = 48, PLAYER_MAX_H = 48;
    const s = Math.min(PLAYER_MAX_W/iw, PLAYER_MAX_H/ih);
    const w = iw*s, h = ih*s;

    const topY = FOOT_OFFSET - h;  // ä¸‹ç«¯=è¶³å…ƒ(FOOT_OFFSET)
    ctx.drawImage(IMAGES.player, -w/2, topY, w, h);

    // ç”»åƒã‹ã‚‰è‚©ä½ç½®ã‚’è¨ˆç®—
    harnessYForLines = topY + h * HARNESS_ANCHOR_RATIO;
  } else {
    // ãƒ™ã‚¯ã‚¿ãƒ¼æœ¬ä½“ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
    ctx.fillStyle = '#243446'; roundRect(-8,-4,16,18,5); ctx.fill();
    ctx.fillStyle = '#ffcf6a'; ctx.beginPath(); ctx.arc(0,-10,6,0,Math.PI*2); ctx.fill();
    harnessYForLines = -6; // èƒ´ä½“ã®å°‘ã—ä¸Š
  }

  // 3) ãƒ©ã‚¤ã‚¶ãƒ¼ï¼ˆé–‹å‚˜æ™‚ã®ã¿æãï¼‰
  if (player.canopyOpen){
    ctx.save();
    ctx.lineWidth = 1.2;
    ctx.lineCap = 'round';
    ctx.strokeStyle = '#333';

    // å·¦
    ctx.beginPath();
    ctx.moveTo(-HARNESS_SIDE_X, harnessYForLines);
    ctx.quadraticCurveTo(
      -HARNESS_SIDE_X - 6, (harnessYForLines + RISER_TOP_Y)/2,
      -RISER_SIDE_X, RISER_TOP_Y
    );
    ctx.stroke();

    // å³
    ctx.beginPath();
    ctx.moveTo(HARNESS_SIDE_X, harnessYForLines);
    ctx.quadraticCurveTo(
      HARNESS_SIDE_X + 6, (harnessYForLines + RISER_TOP_Y)/2,
      RISER_SIDE_X, RISER_TOP_Y
    );
    ctx.stroke();
    ctx.restore();
  }

  ctx.restore();
}
function drawCanopy(){
  // ãƒ™ã‚¯ã‚¿ãƒ¼ã®ãƒ‘ãƒ©ã‚·ãƒ¥ãƒ¼ãƒˆï¼ˆå¸¸ã«ã“ã‚Œã‚’ä½¿ã†ï¼‰
  const r = 36;
  ctx.fillStyle = '#e83d57';
  ctx.beginPath();
  ctx.moveTo(-r, -18);
  ctx.quadraticCurveTo(0, -r-4, r, -18);
  ctx.lineTo(-r, -18);
  ctx.fill();

  ctx.strokeStyle = 'rgba(255,255,255,.6)';
  ctx.lineWidth = 1;
  for (let i=-3; i<=3; i++){
    const x = (i/3)*r;
    ctx.beginPath();
    ctx.moveTo(x, -18);
    ctx.quadraticCurveTo(x*0.6, -r*0.9, x, -18);
    ctx.stroke();
  }
}

function drawTouchMarker(x, gy){
  ctx.save();
  // è¶³è·¡åå­—ãƒãƒ¼ã‚«ãƒ¼
  ctx.strokeStyle = 'rgba(0,0,0,.6)'; ctx.lineWidth = 2;
  ctx.beginPath(); ctx.moveTo(x-8, gy); ctx.lineTo(x+8, gy); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(x, gy-8); ctx.lineTo(x, gy+8); ctx.stroke();
  ctx.restore();
}
function fitContain(iw, ih, maxW, maxH){
  const s = Math.min(maxW/iw, maxH/ih);
  return { w: iw*s, h: ih*s, scale: s };
}

/* ============================================================
   å°ç‰©
   ============================================================ */
function roundRect(x,y,w,h,r){ ctx.beginPath(); const rr=Math.min(r, w/2, h/2);
  ctx.moveTo(x+rr,y); ctx.arcTo(x+w,y,x+w,y+h,rr); ctx.arcTo(x+w,y+h,x,y+h,rr);
  ctx.arcTo(x,y+h,x,y,rr); ctx.arcTo(x,y,x+w,y,rr); ctx.closePath(); }
function flash(text){
  const msg = document.getElementById('message');
  msg.textContent = text; msg.hidden = false; msg.style.opacity = '1';
  msg.animate([{opacity:1},{opacity:0}], {duration:1200, easing:'ease', fill:'forwards'});
  setTimeout(()=>{ msg.hidden = true; }, 1200);
}

/* ============================================================
   åˆæœŸã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‹ã‚‰é–‹å§‹
   ============================================================ */
</script>
</body>
</html>
