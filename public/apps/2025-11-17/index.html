<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
  <title>草むらから松村を探せ！</title>
  <style>
    :root{
      --ink:#f7f8fc;
      --accent:#ffde59;
      --accent2:#ff6fb4;
    }
    *{
      box-sizing:border-box;
      margin:0;
      padding:0;
      -webkit-tap-highlight-color:transparent;
    }
    html,body{
      width:100%;
      height:100%;
      background:#111;
      display:flex;
      justify-content:center;
      align-items:center;
      font-family:system-ui,-apple-system,"Segoe UI","Hiragino Kaku Gothic ProN","Yu Gothic",sans-serif;
      color:var(--ink);
      touch-action:none;
      overflow:hidden;
    }

    /* 画面中央に9:16のフレームを固定 */
    #frame{
      width:min(100vw, 56.25vh);            /* 9:16 = 0.5625 */
      aspect-ratio:9/16;
      background:#000;
      border-radius:20px;
      overflow:hidden;
      box-shadow:0 20px 40px rgba(0,0,0,.7);
      position:relative;
    }

    #app{
      position:absolute;
      inset:0;
      display:flex;
      flex-direction:column;
      padding:12px;
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    .title{
      font-size:16px;
      font-weight:700;
      text-shadow:0 0 8px rgba(0,0,0,.7);
    }
    .subtitle{
      font-size:11px;
      opacity:.8;
    }
    .btnStart{
      border:none;
      border-radius:999px;
      padding:6px 14px;
      font-size:11px;
      font-weight:600;
      background:linear-gradient(135deg,var(--accent),var(--accent2));
      color:#302200;
      box-shadow:0 8px 18px rgba(0,0,0,.6);
      cursor:pointer;
      white-space:nowrap;
    }
    .btnStart:disabled{
      opacity:.6;
      box-shadow:none;
      cursor:default;
    }

    .hud{
      margin-top:8px;
      display:flex;
      gap:6px;
      font-size:10px;
    }
    .hudItem{
      flex:1;
      padding:4px 6px;
      border-radius:999px;
      background:rgba(0,0,0,.45);
      text-align:center;
      box-shadow:0 6px 14px rgba(0,0,0,.5);
    }
    .hudItem label{
      display:block;
      font-size:9px;
      opacity:.7;
    }
    .hudItem strong{
      font-size:15px;
    }

    /* 草むらステージ */
    #stage{
      position:relative;
      margin-top:8px;
      flex:1;
      border-radius:16px;
      overflow:hidden;
      background-size:cover;
      background-position:center;
      background-repeat:no-repeat;
      box-shadow:0 14px 26px rgba(0,0,0,.7);
      touch-action:none;
      cursor:pointer;
    }

    /* 草からチラ見え松村 */
    .target{
  position:absolute;
  max-width:80px;        /* 横幅の上限だけ決める */
  height:auto;           /* 縦は画像比率にまかせる */
  transform:translate(-50%,-50%);
  pointer-events:none;
  opacity:0;
  animation:peek 1.2s ease-out forwards;
  object-fit:contain;
}

    @keyframes peek{
      0%   { opacity:0; transform:translate(-50%,-40%) scale(.6); }
      30%  { opacity:1; transform:translate(-50%,-50%) scale(1); }
      90%  { opacity:1; }
      100% { opacity:0; transform:translate(-50%,-50%) scale(.85); }
    }

    /* タップした場所の松村スタンプ */
    .stamp{
      position:absolute;
      width:70px;
      height:70px;
      transform:translate(-50%, -50%);
      pointer-events:none;
      animation:jump 900ms ease-out forwards;
    }
    @keyframes jump{
      0%{ opacity:0; transform:translate(-50%,-20%) scale(.3); }
      20%{ opacity:1; }
      60%{ transform:translate(-50%,-120%) scale(1.1); }
      100%{ opacity:0; transform:translate(-50%,-40%) scale(.7); }
    }

    /* ヒットしたときの+1表示 */
    .hit{
      position:absolute;
      transform:translate(-50%,-50%);
      font-size:18px;
      font-weight:700;
      color:var(--accent);
      text-shadow:0 0 6px rgba(0,0,0,.9);
      pointer-events:none;
      animation:hitFloat 600ms ease-out forwards;
    }
    @keyframes hitFloat{
      0%{ opacity:0; transform:translate(-50%,-40%) translateY(6px); }
      20%{ opacity:1; }
      100%{ opacity:0; transform:translate(-50%,-40%) translateY(-22px); }
    }
  </style>
</head>
<body>
<div id="frame">
  <div id="app">
    <header>
      <div>
        <div class="title">草むらから松村を探せ！</div>
        <div class="subtitle">30秒のあいだに、草むらからチラ見えする松村をタップ！</div>
      </div>
      <button id="startBtn" class="btnStart">スタート</button>
    </header>

    <div class="hud">
      <div class="hudItem"><label>SCORE</label><strong id="score">0</strong></div>
      <div class="hudItem"><label>TIME</label><strong id="timer">30</strong></div>
      <div class="hudItem"><label>BEST</label><strong id="bestScore">0</strong></div>
    </div>

    <div id="stage"></div>
  </div>
</div>

<script type="module">
  const ASSET_BASE = '/apps/2025-11-17/';
  const asset = (p) => {
    if (p.startsWith('./')) return ASSET_BASE + p.slice(2);
    if (p.startsWith('/')) return ASSET_BASE + p.slice(1);
    return ASSET_BASE + p;
  };

  const stage    = document.getElementById('stage');
  const startBtn = document.getElementById('startBtn');
  const scoreEl  = document.getElementById('score');
  const bestEl   = document.getElementById('bestScore');
  const timerEl  = document.getElementById('timer');

  stage.style.backgroundImage = `url(${asset('./assets/bg_grass.png')})`;

  const hideSrc  = asset('./assets/matsu_hide.png');
  const stampSrc = asset('./assets/matsu_stamp.png');

  let playing = false;
  let time = 30;
  let score = 0;
  let best = Number(localStorage.getItem('hideBest') || 0);
  let timerId = null;

  bestEl.textContent = best;

  function resetGame(){
    time = 30;
    score = 0;
    scoreEl.textContent = '0';
    timerEl.textContent = '30';
  }

  function startGame(){
    if (playing) return;
    playing = true;
    resetGame();
    startBtn.textContent = 'プレイ中…';
    startBtn.disabled = true;

    spawnTarget();

    timerId = setInterval(() => {
      time--;
      if (time <= 0){
        time = 0;
        endGame();
      }
      timerEl.textContent = String(time);
    }, 1000);
  }

  function endGame(){
    if (!playing) return;
    playing = false;
    clearInterval(timerId);
    timerId = null;
    startBtn.disabled = false;
    startBtn.textContent = 'もう一回';

    if (score > best){
      best = score;
      localStorage.setItem('hideBest', String(best));
      bestEl.textContent = best;
      alert(`ハイスコア更新！ ${score} 点`);
    } else {
      alert(`${score} 点でした！`);
    }
  }

  function spawnTarget(){
    if (!playing) return;

    const t = document.createElement('img');
    t.src = hideSrc;
    t.className = 'target';

    const rect = stage.getBoundingClientRect();
    const margin = 50;
    const x = margin + Math.random() * (rect.width  - margin * 2);
    const y = margin + Math.random() * (rect.height - margin * 2);

    t.style.left = x + 'px';
    t.style.top  = y + 'px';
    t.dataset.x  = String(x);
    t.dataset.y  = String(y);

    stage.appendChild(t);

    // 1.2秒後に消して次を出す
    setTimeout(() => {
      t.remove();
      if (playing) spawnTarget();
    }, 1200);
  }

  function handleTap(evt){
  if (!playing) return;

  const rect = stage.getBoundingClientRect();
  const src  = evt.touches ? evt.touches[0] : evt;
  const x = src.clientX - rect.left;
  const y = src.clientY  - rect.top;

  // タップ位置にスタンプ
  spawnStamp(x, y);

  // 今表示中のターゲットを取得
  const target = stage.querySelector('.target');
  if (!target) return; // そもそも出てなければ何も起きない

  const tx = parseFloat(target.dataset.x || '0');
  const ty = parseFloat(target.dataset.y || '0');

  // かなり近くないとヒットにしない（判定をシビアに）
  const dist = Math.hypot(x - tx, y - ty);
  const hitRadius = 40; // ここを小さくすると「ちゃんと狙わないと当たらない」

  if (dist <= hitRadius){
    // 当たり！
    score++;
    scoreEl.textContent = String(score);
    spawnHit(tx, ty - 20);

    // 今の松村は消す
    target.remove();

    // すぐ次の松村を別の場所に出す
    spawnTarget();
  }
}

  function spawnStamp(x,y){
    const s = document.createElement('img');
    s.src = stampSrc;
    s.className = 'stamp';
    s.style.left = x + 'px';
    s.style.top  = y + 'px';
    stage.appendChild(s);
    setTimeout(() => s.remove(), 900);
  }

  function spawnHit(x,y){
    const h = document.createElement('div');
    h.className = 'hit';
    h.textContent = '+1';
    h.style.left = x + 'px';
    h.style.top  = y + 'px';
    stage.appendChild(h);
    setTimeout(() => h.remove(), 600);
  }

  startBtn.addEventListener('click', startGame);
  stage.addEventListener('pointerdown', handleTap, { passive:false });

  // iOS長押しメニュー無効
  document.addEventListener('contextmenu', e => e.preventDefault());
  document.addEventListener('gesturestart', e => e.preventDefault());
</script>
</body>
</html>
