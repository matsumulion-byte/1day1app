<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>æ¾æ‘ã‚­ãƒ£ãƒƒãƒï¼ç©ºã‹ã‚‰æ¾æ‘ãŒé™ã£ã¦ãã‚‹</title>
<style>
  :root { --bg:#0f1220; --fg:#fafafa; --accent:#6ee7ff; --danger:#ff5d7a; --good:#22c55e; --combo:#ffd54a; }
  html,body { height:100%; margin:0; background:var(--bg); color:var(--fg);
    font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Sans", "Noto Sans JP", "Helvetica Neue", Arial;
    overscroll-behavior: none; touch-action: manipulation;
  }
  .wrap { display:flex; flex-direction:column; align-items:center; gap:10px; padding:12px; }
  .hud { width:min(92vw,560px); display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap; }
  .badge { padding:6px 10px; border-radius:999px; background:#1a1f3a; border:1px solid #2b325c; font-weight:700; }
  .btn { padding:10px 14px; border-radius:10px; background:linear-gradient(180deg,#3b82f6,#2563eb); border:none; color:white; font-weight:700; box-shadow:0 6px 18px rgba(37,99,235,.35); }
  .btn:disabled { opacity:.5 }
  .mute { background:#334155; }
  .canvas-wrap { width:min(92vw,560px); aspect-ratio:9/16; border-radius:16px; overflow:hidden; position:relative;
    box-shadow:0 10px 40px rgba(0,0,0,.35), inset 0 0 0 1px #2b325c;
    -webkit-user-select:none; user-select:none; touch-action:none;
  }
  .canvas-wrap.desktop { aspect-ratio:3/4; } /* ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã¯ç¸¦çŸ­ã‚ */
  canvas { width:100%; height:100%; display:block; background: radial-gradient(120% 100% at 50% 0%, #182244 0%, #0f1220 60%); }
  .toast { position:absolute; left:50%; top:18%; transform:translateX(-50%); font-weight:900;
    text-shadow:0 4px 14px rgba(0,0,0,.6); pointer-events:none; color:#fff; font-size: clamp(20px, 6vw, 42px);
    opacity:0; transition: opacity .12s, transform .12s;
  }
  .toast.show { opacity:1; transform: translateX(-50%) scale(1.04); }
  .comboHUD { padding:6px 10px; border-radius:999px; background:#3a2d0a; border:1px solid #5b470f; color:#fff3c4; font-weight:900; }
  .overlay { position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:14px;
    background: linear-gradient(180deg, rgba(8,10,16,.72), rgba(8,10,16,.72)); color:white; text-align:center; padding:20px;
  }
  .card { background:#0f1428; border:1px solid #243056; border-radius:14px; padding:16px 14px; width:min(80%, 380px); }
  .small { font-size:12px; opacity:.7 }

  /* æµ®éŠã‚¹ã‚³ã‚¢ */
  .float-score { position:absolute; color:#fff; font-weight:900; text-shadow:0 2px 8px rgba(0,0,0,.5); pointer-events:none; }
</style>
</head>
<body>
<div class="wrap">
  <div class="hud">
    <div class="badge" id="time">â± 30.0s</div>
    <div class="badge" id="score">ğŸ¯ 0</div>
    <div class="comboHUD" id="combo">COMBO Ã—1</div>
    <div class="badge" id="best">ğŸ† 0</div>
    <button class="btn mute" id="muteBtn">ğŸ”Š éŸ³ON</button>
    <button class="btn" id="startBtn" disabled>â–¶ï¸ ãƒ­ãƒ¼ãƒ‰ä¸­â€¦</button>
  </div>
  <div class="canvas-wrap" id="stage">
    <canvas id="game" width="360" height="640"></canvas>
    <div class="toast" id="toast">æ¾æ‘ã§ã™ï¼</div>
    <div class="overlay" id="overlay">
      <div class="card">
        <h2 style="margin:0 0 6px">æ¾æ‘ã‚­ãƒ£ãƒƒãƒï¼ï¼ˆã‚³ãƒ³ãƒœç‰ˆï¼‰</h2>
        <p style="margin:0">30ç§’ã§ã€Œæ¾æ‘ã€ã‚’ã§ãã‚‹ã ã‘ã‚­ãƒ£ãƒƒãƒï¼<br>å½ç‰©ã‚’å–ã£ãŸã‚‰<strong style="color:var(--danger)">å³ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼</strong>ï¼</p>
        <p class="small" style="margin:8px 0 0">æŒ‡/ãƒã‚¦ã‚¹ã§ç§»å‹•ã€â† â†’ ã¾ãŸã¯ A/D ã§ã‚‚ç§»å‹•</p>
        <p class="small" style="margin:8px 0 0; color:#ffe08a">2.5ç§’ä»¥å†…ã®é€£ç¶šã‚­ãƒ£ãƒƒãƒã§ã‚³ãƒ³ãƒœUPï¼æœ€å¤§Ã—4</p>
      </div>
      <button class="btn" id="startBtn2" disabled>â–¶ï¸ ãƒ­ãƒ¼ãƒ‰ä¸­â€¦</button>
      <div class="small">ç”»åƒã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™â€¦</div>
    </div>
  </div>
</div>

<audio id="voice" preload="auto">
  <source src="/apps/2025-10-12/matsumura_desu.m4a" type="audio/mp4">
</audio>

<script>
(() => {
  // ===== ç’°å¢ƒæ¤œçŸ¥ & ã‚­ãƒ£ãƒ³ãƒã‚¹è¨­å®š =====
  const isDesktop = matchMedia('(pointer: fine)').matches && window.innerWidth >= 700;
  const TARGET_W = 360;
  const TARGET_H = isDesktop ? 520 : 640; // ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã¯ç¸¦çŸ­ã‚
  const speedScale = TARGET_H / 640;

  // DOMå‚ç…§
  const cv = document.getElementById('game');
  const ctx = cv.getContext('2d');
  const stage = document.getElementById('stage');
  if (isDesktop) stage.classList.add('desktop');
  cv.width = TARGET_W;
  cv.height = TARGET_H;

  // ===== ç”»åƒãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ =====
  const assets = {
    ok:  { src: '/apps/2025-10-12/matsu_ok.png',  img: new Image(), isReal: true  },
    ng1: { src: '/apps/2025-10-12/matsu_ng1.png', img: new Image(), isReal: false },
    ng2: { src: '/apps/2025-10-12/matsu_ng2.png', img: new Image(), isReal: false },
    ng3: { src: '/apps/2025-10-12/matsu_ng3.png', img: new Image(), isReal: false },
  };
  const list = Object.values(assets);
  let loaded = 0;
  const startBtn  = document.getElementById('startBtn');
  const startBtn2 = document.getElementById('startBtn2');
  const overlay   = document.getElementById('overlay');

  list.forEach(a=>{
    a.img.onload = a.img.onerror = () => {
      if (++loaded === list.length) {
        startBtn.disabled=false; startBtn.textContent='â–¶ï¸ ã‚¹ã‚¿ãƒ¼ãƒˆ';
        startBtn2.disabled=false; startBtn2.textContent='â–¶ï¸ ã‚²ãƒ¼ãƒ é–‹å§‹';
      }
    };
    a.img.src = a.src;
  });

  // ===== HUDç­‰ =====
  const timeEl  = document.getElementById('time');
  const scoreEl = document.getElementById('score');
  const comboEl = document.getElementById('combo');
  const bestEl  = document.getElementById('best');
  const toast   = document.getElementById('toast');
  const muteBtn = document.getElementById('muteBtn');
  const voice   = document.getElementById('voice');

  // ===== çŠ¶æ…‹ =====
  let running=false, gameOver=false;
  let score=0, best=Number(localStorage.getItem('matsuCatchBest')||0);
  let timeLeft=30000, lastT=0, spawnAcc=0, spawnInterval=700;
  let objects=[];
  bestEl.textContent = `ğŸ† ${best}`;

  // --- ã‚³ãƒ³ãƒœçŠ¶æ…‹ ---
  let comboCount = 0;           // é€£ç¶šã‚­ãƒ£ãƒƒãƒæ•°
  let comboTimer = 0;           // æ®‹ã‚Šæ™‚é–“(ms)
  const COMBO_WINDOW = 2500;    // 2.5ç§’ä»¥å†…ã®é€£ç¶šã§ç¶™ç¶š
  function comboMultiplier(cnt){
    if (cnt >= 9) return 4;
    if (cnt >= 6) return 3;
    if (cnt >= 3) return 2;
    return 1;
  }
  function updateComboHUD(){
    const mul = comboMultiplier(comboCount);
    comboEl.textContent = `COMBO Ã—${mul}`;
    comboEl.style.background = mul>=3 ? '#5b3f0a' : '#3a2d0a';
    comboEl.style.borderColor = mul>=3 ? '#855e0e' : '#5b470f';
  }

  // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆã–ã‚‹ï¼‰
  const player = { w: isDesktop ? 102 : 96, h: 34, x: TARGET_W/2 - (isDesktop?51:48), y: TARGET_H - 58 };

  // ===== å…¥åŠ›ï¼šã‚¹ãƒãƒ›æœ€é©åŒ–ï¼ˆpointer capture + ãƒ™ã‚¿è¿½å¾“ï¼‰ =====
  const SMOOTH_FACTOR_TOUCH = 0.40; // å°ã•ã„ã»ã©æŒ‡ã«ãƒ™ã‚¿ä»˜ã
  const SMOOTH_FACTOR_MOUSE = 0.25;

  let pointerActive = false;
  let activePointerId = null;
  let targetX = player.x;

  const toCanvasX = (clientX) => {
    const rect = cv.getBoundingClientRect();
    const ratio = cv.width / rect.width;
    return (clientX - rect.left) * ratio;
  };

  // iOSãªã©ã®ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªåˆæœŸåŒ–
  let audioUnlocked=false;
  function kickAudio(){
    if(audioUnlocked) return;
    try { voice.play().then(()=>{ voice.pause(); voice.currentTime=0; audioUnlocked=true; }).catch(()=>{}); } catch(e){}
  }

  stage.addEventListener('pointerdown', (e) => {
    pointerActive = true;
    activePointerId = e.pointerId;
    stage.setPointerCapture?.(activePointerId);
    targetX = toCanvasX(e.clientX) - player.w/2;
    kickAudio();
  }, { passive: true });

  stage.addEventListener('pointermove', (e) => {
    if (!pointerActive || (activePointerId!==null && e.pointerId!==activePointerId)) return;
    targetX = toCanvasX(e.clientX) - player.w/2;
    if (e.pointerType === 'touch') e.preventDefault?.();
  }, { passive: false });

  const release = () => {
    pointerActive = false;
    if (activePointerId !== null) {
      stage.releasePointerCapture?.(activePointerId);
      activePointerId = null;
    }
  };
  stage.addEventListener('pointerup', release, { passive: true });
  stage.addEventListener('pointercancel', release, { passive: true });
  stage.addEventListener('pointerleave', release, { passive: true });

  // ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã¯ãƒ›ãƒãƒ¼ã§ã‚‚è¿½å¾“
  if (isDesktop) {
    stage.addEventListener('pointermove', (e) => {
      if (pointerActive) return;
      targetX = toCanvasX(e.clientX) - player.w/2;
    }, { passive: true });
  }

  // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œ
  let keyDir = 0; // -1:å·¦, +1:å³
  addEventListener('keydown', e=>{
    if(e.key==='ArrowLeft' || e.key==='a' || e.key==='A') keyDir = -1;
    if(e.key==='ArrowRight'|| e.key==='d' || e.key==='D') keyDir = 1;
  });
  addEventListener('keyup', e=>{
    if(['ArrowLeft','a','A'].includes(e.key) && keyDir<0) keyDir = 0;
    if(['ArrowRight','d','D'].includes(e.key) && keyDir>0) keyDir = 0;
  });

  // ===== ã‚¹ãƒãƒ¼ãƒ³ï¼ˆæ¾æ‘ã‚’å¤§ãã‚ã«ï¼‰ =====
  function spawnObject(){
    const isReal = Math.random() < 0.7; // 70% æœ¬ç‰©
    const cand = isReal ? [assets.ok] : [assets.ng1, assets.ng2, assets.ng3];
    const chosen = cand[Math.floor(Math.random()*cand.length)];

    // â˜… ã‚µã‚¤ã‚ºã‚¢ãƒƒãƒ—ï¼ˆå¾“æ¥ã‚ˆã‚Šä¸€å›ã‚Šå¤§ãã„ï¼‰
    const base = 46, rand = 16;       // r = 46ã€œ62 â†’ ç›´å¾„ 92ã€œ124px
    const size = base + Math.random()*rand;

    const x = 24 + Math.random()*(TARGET_W - 48);
    const y = -(size*2) - 10;
    const v = (1.6 + Math.random()*0.9 + (1 - timeLeft/30000)*1.8) * speedScale;
    const sway = (Math.random()*0.8 + 0.4) * (Math.random()<0.5 ? -1 : 1);
    objects.push({ x, y, r:size, vy:v, img:chosen.img, isReal:chosen.isReal, sway, t:0 });
  }

  // ===== æç”» =====
  function drawBackground(){ ctx.clearRect(0,0,TARGET_W,TARGET_H); ctx.fillStyle='#0b0f1d'; ctx.fillRect(0, TARGET_H-36, TARGET_W, 36); }
  function roundRect(ctx, x, y, w, h, r) {
    const rr = Math.min(r, w/2, h/2);
    ctx.beginPath(); ctx.moveTo(x+rr, y);
    ctx.arcTo(x+w, y, x+w, y+h, rr);
    ctx.arcTo(x+w, y+h, x, y+h, rr);
    ctx.arcTo(x, y+h, x, y, rr);
    ctx.arcTo(x, y, x+w, y, rr);
    ctx.closePath();
  }
  // ã–ã‚‹æç”»
  function drawZaru(x, y, w, h){
    const r = 12;
    // å½±
    ctx.globalAlpha = .15;
    ctx.fillStyle = '#000';
    roundRect(ctx, x+3, y+6, w, h, r); ctx.fill();
    ctx.globalAlpha = 1;

    // å¤–æ 
    ctx.fillStyle = '#d1a85a';
    roundRect(ctx, x, y, w, h, r); ctx.fill();
    ctx.strokeStyle = '#b6893f'; ctx.lineWidth = 2;
    roundRect(ctx, x, y, w, h, r); ctx.stroke();

    // ç¸
    ctx.strokeStyle = '#e9c67b'; ctx.lineWidth = 4;
    roundRect(ctx, x+4, y+3, w-8, h-6, r-6); ctx.stroke();

    // ç·¨ã¿ç›®ï¼ˆè»½é‡ï¼‰
    ctx.save();
    ctx.beginPath(); roundRect(ctx, x+6, y+5, w-12, h-10, r-8); ctx.clip();
    ctx.strokeStyle = 'rgba(90,60,15,0.25)'; ctx.lineWidth = 2;

    const gridGap = 10;
    for(let gx = x; gx < x+w; gx += gridGap){
      ctx.beginPath(); ctx.moveTo(gx, y); ctx.lineTo(gx, y+h); ctx.stroke();
    }
    for(let gy = y; gy < y+h; gy += gridGap){
      ctx.beginPath(); ctx.moveTo(x, gy); ctx.lineTo(x+w, gy); ctx.stroke();
    }
    ctx.restore();
  }
  function drawPlayer(){ drawZaru(player.x, player.y, player.w, player.h); }
  function drawStars(t){
    const seed = Math.floor(t/800)%999;
    for(let i=0;i<22;i++){
      const x = ((i*seed*37)%TARGET_W);
      const y = ((i*seed*59)%(TARGET_H-80));
      const r = (i%3)+1;
      ctx.globalAlpha = 0.08 + ((i*7)%10)/60;
      ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fillStyle='#c7d2fe'; ctx.fill();
      ctx.globalAlpha = 1;
    }
  }
  function drawObject(o){
    ctx.save();
    ctx.translate(o.x, o.y);
    const k = Math.sin(o.t*0.002)*o.sway;
    const w = o.r*2, h = o.r*2;
    ctx.drawImage(o.img, -w/2 + k*2, -h/2, w, h);
    ctx.restore();
  }

  // ===== ãƒˆãƒ¼ã‚¹ãƒˆ/ã‚µã‚¦ãƒ³ãƒ‰/æµ®éŠã‚¹ã‚³ã‚¢ =====
  let toastTimer=0;
  function showToast(msg='æ¾æ‘ã§ã™ï¼'){
    toast.textContent = msg; toast.classList.add('show');
    clearTimeout(toastTimer); toastTimer = setTimeout(()=>toast.classList.remove('show'), 420);
  }
  let muted=false;
  function playVoice(){ if(!muted){ try{ const n=voice.cloneNode(true); n.volume=0.9; n.play().catch(()=>{}); }catch(e){} } }
  muteBtn.addEventListener('click', ()=>{
    muted=!muted; muteBtn.textContent = muted ? 'ğŸ”‡ éŸ³OFF' : 'ğŸ”Š éŸ³ON'; muteBtn.classList.toggle('mute', muted);
  });

  function spawnFloatScore(px, py, text, color='#fff'){
    const el = document.createElement('div');
    el.className = 'float-score';
    el.textContent = text;
    el.style.left = (px - 10) + 'px';
    el.style.top  = (py - 10) + 'px';
    el.style.color = color;
    stage.appendChild(el);
    let t=0;
    const id = setInterval(()=>{
      t += 16;
      el.style.transform = `translateY(${-t/20}px)`;
      el.style.opacity = String(Math.max(0, 1 - t/600));
      if(t>600){ clearInterval(id); el.remove(); }
    }, 16);
  }

  // ===== HUD/çµ‚äº† =====
  function updateHUD(){ timeEl.textContent=`â± ${(timeLeft/1000).toFixed(1)}s`; scoreEl.textContent=`ğŸ¯ ${score}`; bestEl.textContent=`ğŸ† ${best}`; updateComboHUD(); }
  function resetGame(){
    running=false; gameOver=false; score=0; timeLeft=30000; lastT=0; spawnAcc=0; spawnInterval=700; objects=[];
    comboCount = 0; comboTimer = 0; updateComboHUD();
    player.x = TARGET_W/2 - player.w/2; player.y = TARGET_H - 58; updateHUD();
  }
  function endGame(reason='time'){
    running=false; gameOver=true; overlay.style.display='flex';
    overlay.innerHTML = `
      <div class="card">
        <h2 style="margin:0 0 8px">${reason==='fake'?'ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ï¼':'ã‚¿ã‚¤ãƒ ã‚¢ãƒƒãƒ—ï¼'}</h2>
        <p style="margin:0 0 6px">ã‚¹ã‚³ã‚¢ï¼š<strong style="font-size:20px">${score}</strong></p>
        <p class="small" style="margin:0 0 10px">${reason==='fake'?'å½ç‰©ã‚’ã‚­ãƒ£ãƒƒãƒã—ã¦ã—ã¾ã£ãŸâ€¦':'ãŠã¤ã‹ã‚Œã•ã¾ï¼'}</p>
        <p class="small" style="margin:0">ãƒ™ã‚¹ãƒˆï¼š<strong>${best}</strong></p>
      </div>
      <button class="btn" id="retryBtn">â†» ã‚‚ã†ä¸€åº¦</button>
    `;
    document.getElementById('retryBtn').addEventListener('click', ()=>{ buildHomeOverlay(); startGame(); });
  }
  function buildHomeOverlay(){
    overlay.style.display='flex';
    overlay.innerHTML=`
      <div class="card">
        <h2 style="margin:0 0 6px">æ¾æ‘ã‚­ãƒ£ãƒƒãƒï¼ï¼ˆã‚³ãƒ³ãƒœç‰ˆï¼‰</h2>
        <p style="margin:0">30ç§’ã§ã€Œæ¾æ‘ã€ã‚’ã§ãã‚‹ã ã‘ã‚­ãƒ£ãƒƒãƒï¼<br>å½ç‰©ã§<strong style="color:var(--danger)">å³ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼</strong></p>
        <p class="small" style="margin:8px 0 0">æŒ‡/ãƒã‚¦ã‚¹ç§»å‹•ã€â† â†’ / Aãƒ»D ã§ç§»å‹•</p>
        <p class="small" style="margin:8px 0 0; color:#ffe08a">2.5ç§’ä»¥å†…ã®é€£ç¶šã‚­ãƒ£ãƒƒãƒã§å€ç‡UPï¼ˆæœ€å¤§Ã—4ï¼‰</p>
      </div>
      <button class="btn" id="startBtn2">â–¶ï¸ ã‚²ãƒ¼ãƒ é–‹å§‹</button>
    `;
    document.getElementById('startBtn2').addEventListener('click', startGame);
  }

  // ===== ãƒ«ãƒ¼ãƒ— =====
  function startGame(){
    resetGame();
    overlay.style.display='none';
    running=true;
    lastT=performance.now();
    requestAnimationFrame(loop);
  }

  function loop(t){
    if(!running) return;
    const dt = Math.min(50, t - lastT); lastT = t;

    timeLeft -= dt; if(timeLeft<0) timeLeft=0;

    // ã‚³ãƒ³ãƒœã‚¿ã‚¤ãƒãƒ¼æ¸›è¡°
    if(comboTimer > 0){
      comboTimer -= dt;
      if(comboTimer <= 0){ comboTimer = 0; comboCount = 0; }
    }

    // ã‚¹ãƒãƒ¼ãƒ³
    spawnAcc += dt;
    const dynamicInterval = Math.max(260, spawnInterval - ((30000 - timeLeft)/30000)*320);
    if (spawnAcc >= dynamicInterval) {
      spawnAcc = 0;
      const n = Math.random()<0.85 ? 1 : 2;
      for(let i=0;i<n;i++) spawnObject();
    }

    // å…¥åŠ›
    if(keyDir !== 0){
      const keySpeed = 6.0;
      player.x += keyDir * keySpeed * (dt/16.67);
      targetX = player.x;
    }
    const isTouching = pointerActive;
    const smooth = isTouching ? SMOOTH_FACTOR_TOUCH : SMOOTH_FACTOR_MOUSE;
    player.x += (targetX - player.x) * (1 - smooth);
    player.x = Math.max(4, Math.min(TARGET_W - player.w - 4, player.x));

    // ç‰©ä½“æ›´æ–°
    for(const o of objects){ o.t += dt; o.y += o.vy * (dt/16.67) * 3; }

    // å½“ãŸã‚Šåˆ¤å®šï¼ˆã‚¹ãƒãƒ›ã¯å°‘ã—ç”˜ã‚ï¼‰
    const px=player.x, py=player.y, pw=player.w, ph=player.h;
    const tol = isDesktop ? 10 : 14;
    const caught=[];
    for(const o of objects){
      if(o.y + o.r >= py && o.y - o.r <= py+ph){
        if(o.x >= px - tol && o.x <= px + pw + tol) caught.push(o);
      }
    }
    for(const o of caught){
      objects.splice(objects.indexOf(o),1);
      if(o.isReal){
        // --- ã‚³ãƒ³ãƒœå‡¦ç† ---
        comboCount = (comboTimer>0) ? (comboCount+1) : 1; // æ–°è¦ or ç¶™ç¶š
        comboTimer = COMBO_WINDOW;
        const mul = comboMultiplier(comboCount);
        const gain = mul; // 1/2/3/4ç‚¹
        score += gain;
        if(score>best){ best=score; localStorage.setItem('matsuCatchBest', String(best)); }
        playVoice(); showToast(mul>=3 ? `æ¾æ‘ã§ã™ï¼ Ã—${mul}` : 'æ¾æ‘ã§ã™ï¼');

        // æµ®éŠã‚¹ã‚³ã‚¢æ¼”å‡ºï¼ˆã‚³ãƒ³ãƒœè‰²ï¼‰
        const color = mul>=4 ? '#ffd54a' : (mul>=3 ? '#ffe08a' : '#ffffff');
        // ç”»é¢åº§æ¨™ã¸å¤‰æ›
        const rect = cv.getBoundingClientRect();
        const sx = rect.left + (o.x / cv.width) * rect.width;
        const sy = rect.top  + (o.y / cv.height)* rect.height;
        spawnFloatScore(sx, sy, `+${gain}`, color);
      } else {
        endGame('fake'); updateHUD(); return;
      }
    }

    // ç”»é¢å¤–ã‚’å‰Šé™¤
    objects = objects.filter(o => o.y - o.r <= TARGET_H+10);

    // æç”»
    drawBackground();
    drawStars(t);
    for(const o of objects) drawObject(o);
    drawPlayer();
    // ã‚­ãƒ£ãƒƒãƒã‚¾ãƒ¼ãƒ³
    ctx.globalAlpha=.06; ctx.fillStyle='#00e6a8'; ctx.fillRect(0, player.y-2, TARGET_W, player.h+4); ctx.globalAlpha=1;

    updateHUD();
    if(timeLeft<=0){ endGame('time'); return; }
    requestAnimationFrame(loop);
  }

  // ===== ãƒœã‚¿ãƒ³ =====
  startBtn.addEventListener('click', startGame);
  startBtn2?.addEventListener('click', startGame);

  // åˆæœŸ
  buildHomeOverlay();
  resetGame();
})();
</script>
</body>
</html>
