<!doctype html>
<html lang="ja">
<head>
  <!-- OGP AUTO-GENERATED START (do not edit by hand) -->
  <meta property="og:title" content="除夜の松村">
  <meta name="twitter:title" content="除夜の松村">
  <meta property="og:description" content="回数 0/108 音声 未開始 松村です 108/108 今年もお世話になりました。 来年もよろしくお願いいたします。 よいお年を。 除夜の鐘の代わりに松村を108回タップ！">
  <meta name="twitter:description" content="回数 0/108 音声 未開始 松村です 108/108 今年もお世話になりました。 来年もよろしくお願いいたします。 よいお年を。 除夜の鐘の代わりに松村を108回タップ！">
  <meta property="og:image" content="/2025-12-31/assets/bg_joya_matsumura.png">
  <meta name="twitter:image" content="/2025-12-31/assets/bg_joya_matsumura.png">
  <meta property="og:url" content="/2025-12-31/">
  <meta property="og:type" content="website">
  <meta name="twitter:card" content="summary_large_image">
  <!-- OGP AUTO-GENERATED END -->

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
  <title>除夜の松村</title>
  <meta name="theme-color" content="#070a14" />
  <style>
    :root{
      --bg:#070a14;
      --ink:#f3f6ff;
      --muted:rgba(243,246,255,.7);
      --line:rgba(255,255,255,.14);
      --panel:rgba(255,255,255,.08);
      --good:#34d399;
      --r:18px;
    }
    *{
      box-sizing:border-box;margin:0;padding:0;
      -webkit-user-select:none;user-select:none;-webkit-touch-callout:none;
      -webkit-tap-highlight-color: transparent;
    }
    html,body{
      height:100%;
      color:var(--ink);
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic",sans-serif;
      overflow:hidden;
      touch-action: manipulation;
      background:
        linear-gradient(rgba(0,0,0,.25), rgba(0,0,0,.45)),
        var(--bg-image, url("./assets/bg_joya_matsumura.png")) center / cover no-repeat;
    }
    button{font:inherit;border:0;background:none;color:inherit}

    .app{
      position:relative;
      width:100%;
      height:100%;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      padding:16px;
      gap:14px;
    }
    .top{
      position:absolute;
      top:10px;
      left:10px;
      right:10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      pointer-events:none;
    }
    .badge{
      pointer-events:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius:999px;
      background:rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.14);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      font-weight:700;
      letter-spacing:.02em;
    }
    .badge small{font-weight:600;color:var(--muted);letter-spacing:0}

    /* 透明ガラス枠は撤去。タップ領域は見えなくていい */
    .tapArea{
      width:min(520px, 96vw);
      height: min(86vh, 860px);
      border-radius:28px;
      background: transparent;
      border:none;
      box-shadow:none;
      display:grid;
      place-items:center;
      position:relative;
      overflow:hidden;
      touch-action: manipulation;
    }

    .matsu{
      width: min(280px, 100%);
      height:auto;
      filter: drop-shadow(0 30px 18px rgba(0,0,0,.55));
      transform: translateY(-40px);
      transition: transform 80ms ease;
      pointer-events:none;
    }
    .tapArea:active .matsu{
      transform: translateY(-40px) scale(.99);
    }

    .hint{
      text-align:center;
      color:var(--muted);
      font-size:13px;
      line-height:1.4;
      background:rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.10);
      padding:8px 10px;
      border-radius:999px;
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
    }

    .toast{
      position:absolute;
      left:50%;
      top:52%;
      transform:translate(-50%,-50%);
      padding:12px 14px;
      border-radius:999px;
      background:rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.18);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      font-weight:800;
      letter-spacing:.02em;
      opacity:0;
      pointer-events:none;
      transition: opacity 140ms ease, transform 140ms ease;
      white-space:nowrap;
      z-index: 2;
    }
    .toast.show{
      opacity:1;
      transform:translate(-50%,-55%);
    }

    .comment{
      position:absolute;
      top:42%;
      left:50%;
      transform:translate(-50%,-50%);
      font-size:20px;
      font-weight:900;
      letter-spacing:.08em;
      opacity:0;
      transition:opacity .2s ease, transform .2s ease;
      pointer-events:none;
      text-shadow: 0 10px 22px rgba(0,0,0,.7);
      z-index: 3;
      white-space:nowrap;
    }
    .comment.show{
      opacity:1;
      transform:translate(-50%,-55%);
    }

    /* 途中表示バグを潰すため、show以外は強制非表示 */
    .done{
      position:absolute;
      inset:0;
      display:none !important;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      gap:12px;
      background: radial-gradient(120% 120% at 50% 35%, rgba(52,211,153,.18), rgba(0,0,0,.65));
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      z-index: 5;
      text-align:center;
      padding:16px;
    }
    .done.show{ display:flex !important; }
    .done h1{ font-size:22px; letter-spacing:.04em; }
    .done p{ color:var(--muted); font-size:13px; max-width:26em; line-height:1.7;}

    /* 「もう一度」は削除（除夜はリトライさせない） */
    .sr{position:absolute;left:-9999px;}
  </style>
</head>
<body>
  <div class="app" id="app">
    <div class="top">
      <div class="badge" id="counter"><small>回数</small><span id="countText">0/108</span></div>
      <div class="badge" id="audioState"><small>音声</small><span id="audioText">未開始</span></div>
    </div>

    <button class="tapArea" id="tapArea" aria-label="松村をタップ">
      <img class="matsu" id="matsuImg" alt="松村" />
      <div class="toast" id="toast">松村です</div>
      <div class="comment" id="comment"></div>

      <div class="done" id="done">
        <h1>108/108</h1>
        <p>今年もお世話になりました。<br/>
           来年もよろしくお願いいたします。<br/>
           よいお年を。</p>
      </div>
    </button>

    <div class="hint">除夜の鐘の代わりに松村を108回タップ！</div>
    <div class="sr" aria-live="polite" id="ariaLive"></div>
  </div>

  <script type="module">
    // Vercel用のパス解決ヘルパー
    const DATE_SEGMENT = (location.pathname.match(/\d{4}-\d{2}-\d{2}/) || [""])[0];
    const DATE_BASE = DATE_SEGMENT ? `/${DATE_SEGMENT}/` : "/";
    const asset = (p) => {
      const clean = String(p || "").replace(/^\.?\//, "");
      return `${DATE_BASE}${clean}`;
    };

    // 背景画像パスを動的に設定
    document.documentElement.style.setProperty('--bg-image', `url("${asset('./assets/bg_joya_matsumura.png')}")`);

    const MAX = 108;

    const elTap = document.getElementById('tapArea');
    const elToast = document.getElementById('toast');
    const elComment = document.getElementById('comment');
    const elDone = document.getElementById('done');
    const elCountText = document.getElementById('countText');
    const elAudioText = document.getElementById('audioText');
    const elAria = document.getElementById('ariaLive');
    const elImg = document.getElementById('matsuImg');

    const IMG_SRC = asset('./assets/matsumura.png');
    const SND_SRC = asset('./assets/matsumura_desu.m4a');

    elImg.src = IMG_SRC;
    elImg.onerror = () => {
      elImg.remove();
      const fallback = document.createElement('div');
      fallback.style.cssText = `
        width:min(240px, 55%);
        aspect-ratio:1/1;
        border-radius:24px;
        display:grid;
        place-items:center;
        background:rgba(0,0,0,.28);
        border:1px solid rgba(255,255,255,.14);
        font-weight:900;
        letter-spacing:.08em;
        transform: translateY(-40px);
      `;
      fallback.textContent = '松村';
      elTap.appendChild(fallback);
    };

    let count = 0;
    let toastTimer = 0;
    let commentTimer = 0;

    let audioUnlocked = false;
    const baseAudio = new Audio(SND_SRC);
    baseAudio.preload = 'auto';

    const COMMENTS = {
      8:  "あと100回！",
      54: "折り返し！",
      98: "あと10回！",
      108:"松村納め"
    };

    function setCounter(){
      elCountText.textContent = `${count}/${MAX}`;
    }

    function showToast(isFinal=false){
      elToast.textContent = '松村です';
      elToast.classList.add('show');
      const dur = isFinal ? 380 : 180;
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => elToast.classList.remove('show'), dur);
    }

    function showComment(text, isFinal=false){
      clearTimeout(commentTimer);
      elComment.textContent = text;
      elComment.classList.add('show');
      const dur = isFinal ? 900 : 520;
      commentTimer = setTimeout(()=> elComment.classList.remove('show'), dur);
    }

    async function unlockAudioIfNeeded(){
      if (audioUnlocked) return true;
      try{
        baseAudio.currentTime = 0;
        await baseAudio.play();
        baseAudio.pause();
        baseAudio.currentTime = 0;
        audioUnlocked = true;
        elAudioText.textContent = 'ON';
        return true;
      }catch(e){
        elAudioText.textContent = '要タップ';
        return false;
      }
    }

    function playVoice(){
      const a = baseAudio.cloneNode(true);
      a.volume = 1.0;
      a.play().catch(()=>{});
    }

    function finish(){
      elDone.classList.add('show');
      elAria.textContent = '108回達成';
    }

    function resetUiEphemera(){
      elToast.classList.remove('show');
      elComment.classList.remove('show');
      clearTimeout(toastTimer);
      clearTimeout(commentTimer);
    }

    // 念のため初期状態で絶対に閉じる（途中で出る事故対策）
    elDone.classList.remove('show');
    setCounter();

    document.addEventListener('gesturestart', (e)=>e.preventDefault(), {passive:false});
    document.addEventListener('dblclick', (e)=>e.preventDefault(), {passive:false});

    elTap.addEventListener('pointerdown', async (e)=>{
      e.preventDefault();
      if (count >= MAX) return;

      await unlockAudioIfNeeded();

      count++;
      setCounter();

      if (audioUnlocked) playVoice();

      // 叩いた「間」をちょい暗転（除夜っぽさ）
      elTap.animate(
        [{filter:'brightness(1)'},{filter:'brightness(.92)'},{filter:'brightness(1)'}],
        {duration:120}
      );

      const isFinal = (count === MAX);

      const c = COMMENTS[count];
      if (c) showComment(c, isFinal);

      showToast(isFinal);

      if (isFinal){
        // 108回目は表示を残したいのでトースト/コメントの消しだけ緩める
        finish();
      }
    }, {passive:false});

    // 108後に再実行したい場合は、リロードでOK（ボタン撤去方針）
    // どうしても必要なら、ここで「長押し2秒でリセット」などにするのが自然。
  </script>
</body>
</html>
