<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
  <title>ちがい、みつけて</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:#0f172a;
      --ink:#eef2ff;
      --muted:#94a3b8;
      --accent:#38bdf8;
      --danger:#fb7185;
      --ok:#34d399;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      background:radial-gradient(circle at top, #111a3a 0, var(--bg) 55%);
      color:var(--ink);
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      overscroll-behavior:none;
      touch-action:manipulation;
    }
    .wrap{
      min-height:100svh;
      display:flex;
      flex-direction:column;
      padding: max(10px, env(safe-area-inset-top)) 12px max(12px, env(safe-area-inset-bottom));
      gap:10px;
    }
    header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .ttl{
      display:flex;flex-direction:column;gap:4px;
    }
    .ttl h1{
      font-size:18px;
      letter-spacing:.08em;
      font-weight:800;
    }
    .ttl p{font-size:12px;color:var(--muted)}
    .hud{
      display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end;
    }
    .pill{
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      display:flex;gap:6px;align-items:center;
      backdrop-filter: blur(6px);
    }
    .pill b{font-variant-numeric: tabular-nums;}
    .btn{
      appearance:none;border:none;
      padding:10px 12px;border-radius:12px;
      background:linear-gradient(180deg, rgba(56,189,248,.9), rgba(56,189,248,.65));
      color:#001018;
      font-weight:900;
      letter-spacing:.06em;
      cursor:pointer;
      box-shadow:0 10px 26px rgba(56,189,248,.18);
    }
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .stage{
      flex:1;
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    @media (min-width: 860px){
      .stage{grid-template-columns: 1fr 1fr;}
    }

    .card{
      position:relative;
      background:rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px;
      overflow:hidden;
      min-height: 280px;
    }
    .label{
      position:absolute;left:10px;top:10px;
      z-index:5;
      background:rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.16);
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      letter-spacing:.06em;
      backdrop-filter: blur(6px);
    }
    .imgWrap{
      position:absolute;inset:0;
      display:flex;align-items:center;justify-content:center;
      padding: 10px;
    }
    img{
      max-width:100%;
      max-height:100%;
      width:auto;height:auto;
      border-radius:14px;
      user-select:none;
      -webkit-user-drag:none;
      pointer-events:none;
    }
    .hitLayer{
      position:absolute;inset:0;
      z-index:4;
      cursor:crosshair;
    }
    .mark{
      position:absolute;
      width:56px;height:56px;
      border-radius:999px;
      border:4px solid var(--ok);
      box-shadow:0 10px 22px rgba(52,211,153,.25);
      transform: translate(-50%,-50%);
      pointer-events:none;
    }
    .xmark{
      position:absolute;
      transform: translate(-50%,-50%);
      color:var(--danger);
      font-weight:1000;
      font-size:38px;
      text-shadow:0 10px 18px rgba(251,113,133,.25);
      pointer-events:none;
    }
    .toast{
      position:fixed;
      left:50%;
      bottom: calc(14px + env(safe-area-inset-bottom));
      transform:translateX(-50%);
      z-index:50;
      background:rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.14);
      color:var(--ink);
      padding:10px 12px;
      border-radius:14px;
      font-size:13px;
      backdrop-filter: blur(8px);
      opacity:0;
      transition: opacity .18s ease, transform .18s ease;
      pointer-events:none;
      white-space:nowrap;
    }
    .toast.show{opacity:1;transform:translateX(-50%) translateY(-4px)}
    .overlay{
      position:fixed;inset:0;
      display:none;
      align-items:center;justify-content:center;
      z-index:60;
      background:rgba(2,6,23,.72);
      backdrop-filter: blur(10px);
      padding:18px;
    }
    .overlay.show{display:flex;}
    .modal{
      width:min(520px, 100%);
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.14);
      border-radius:22px;
      padding:16px;
      text-align:center;
    }
    .modal h2{font-size:18px;letter-spacing:.06em}
    .modal p{margin-top:8px;color:var(--muted);font-size:13px;line-height:1.5}
    .modal .row{margin-top:12px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
    .ghost{
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.14);
      color:var(--ink);
      box-shadow:none;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="ttl">
        <h1>ちがい、みつけて</h1>
        <p>3つ見つけたらクリア。間違いタップは +2秒。</p>
      </div>
      <div class="hud">
        <div class="pill">⏱ <b id="time">30.0</b>s</div>
        <div class="pill">✅ <b id="found">0</b>/3</div>
        <button class="btn" id="startBtn">START</button>
      </div>
    </header>

    <main class="stage">
      <section class="card" id="cardA">
        <div class="label">A</div>
        <div class="imgWrap"><img id="imgA" alt="A" /></div>
        <div class="hitLayer" data-side="A"></div>
      </section>

      <section class="card" id="cardB">
        <div class="label">B</div>
        <div class="imgWrap"><img id="imgB" alt="B" /></div>
        <div class="hitLayer" data-side="B"></div>
      </section>
    </main>
  </div>

  <div class="toast" id="toast"></div>

  <div class="overlay" id="overlay">
    <div class="modal">
      <h2 id="resultTitle">CLEAR</h2>
      <p id="resultText"></p>
      <div class="row">
        <button class="btn" id="retryBtn">RETRY</button>
        <button class="btn ghost" id="revealBtn">REVEAL</button>
      </div>
    </div>
  </div>

  <script type="module">
    // Vercel / ローカル両対応のパス解決（他の日付と同じルール）
    const DATE_SEGMENT = (location.pathname.match(/\d{4}-\d{2}-\d{2}/) || [""])[0];
    const DATE_BASE = DATE_SEGMENT ? `/${DATE_SEGMENT}/` : "/";
    const asset = (p) => {
      const clean = String(p || "").replace(/^\.?\//, "");
      return `${DATE_BASE}${clean}`;
    };

    // 画像
    const imgA = document.getElementById("imgA");
    const imgB = document.getElementById("imgB");
    imgA.src = asset("./assets/matsu_a.jpg");
    imgB.src = asset("./assets/matsu_b.png");

    const startBtn = document.getElementById("startBtn");
    const retryBtn = document.getElementById("retryBtn");
    const revealBtn = document.getElementById("revealBtn");

    const timeEl = document.getElementById("time");
    const foundEl = document.getElementById("found");
    const toast = document.getElementById("toast");
    const overlay = document.getElementById("overlay");
    const resultTitle = document.getElementById("resultTitle");
    const resultText = document.getElementById("resultText");

    // 差分ホットスポット（A画像の座標ベースで正規化）
    // ※Gemini画像を見る限り「メガネ付近」「Tシャツロゴ」「サックス先端」っぽい3点にしてある
    const HOTSPOTS = [
      { id: "face",   x: 794/1365, y: 638/2048, r: 78/1365 },  // 顔(メガネ周り)
      { id: "shirt",  x: 783/1365, y: 989/2048, r: 90/1365 },  // Tシャツロゴ
      { id: "sax",    x: 399/1365, y: 1661/2048, r: 105/1365 } // サックス先端
    ];

    let running = false;
    let t = 30.0;
    let found = new Set();
    let timerId = null;

    function showToast(msg){
      toast.textContent = msg;
      toast.classList.add("show");
      clearTimeout(showToast._id);
      showToast._id = setTimeout(()=>toast.classList.remove("show"), 900);
    }

    function reset(){
      running = false;
      t = 30.0;
      found = new Set();
      timeEl.textContent = t.toFixed(1);
      foundEl.textContent = "0";
      startBtn.disabled = false;
      startBtn.textContent = "START";
      overlay.classList.remove("show");

      document.querySelectorAll(".mark,.xmark").forEach(n=>n.remove());
      if(timerId){ clearInterval(timerId); timerId=null; }
    }

    function start(){
      reset();
      running = true;
      startBtn.disabled = true;
      startBtn.textContent = "PLAYING…";
      const startedAt = performance.now();
      let last = startedAt;

      timerId = setInterval(()=>{
        const now = performance.now();
        const dt = (now - last)/1000;
        last = now;

        if(!running) return;
        t -= dt;
        if(t < 0) t = 0;
        timeEl.textContent = t.toFixed(1);

        if(t <= 0){
          finish(false);
        }
      }, 50);

      showToast("3つ見つけて！");
    }

    function finish(isClear){
      if(!running) return;
      running = false;
      if(timerId){ clearInterval(timerId); timerId=null; }

      resultTitle.textContent = isClear ? "CLEAR" : "TIME UP";
      resultText.textContent = isClear
        ? `ナイス。残り ${t.toFixed(1)} 秒で発見。`
        : `見つけた数：${found.size}/3`;

      overlay.classList.add("show");
      startBtn.disabled = false;
      startBtn.textContent = "RESTART";
    }

    function addMark(cardEl, cx, cy){
      const m = document.createElement("div");
      m.className = "mark";
      m.style.left = cx + "px";
      m.style.top = cy + "px";
      cardEl.appendChild(m);
    }

    function addX(cardEl, cx, cy){
      const x = document.createElement("div");
      x.className = "xmark";
      x.textContent = "×";
      x.style.left = cx + "px";
      x.style.top = cy + "px";
      cardEl.appendChild(x);
      setTimeout(()=>x.remove(), 380);
    }

    function hitTest(normX, normY){
      // 正規化座標で距離判定（円）
      for(const s of HOTSPOTS){
        const dx = normX - s.x;
        const dy = normY - s.y;
        const dist = Math.sqrt(dx*dx + dy*dy);
        if(dist <= s.r) return s;
      }
      return null;
    }

    function onTap(e){
      if(!running) return;

      const layer = e.currentTarget;
      const card = layer.closest(".card");
      const img = card.querySelector("img");

      // 画像が画面内で「どこに描画されているか」を算出（contain対応）
      const rect = layer.getBoundingClientRect();
      const imgRect = img.getBoundingClientRect();

      const px = e.clientX;
      const py = e.clientY;

      // 画像外タップは無視（containで余白があるため）
      if(px < imgRect.left || px > imgRect.right || py < imgRect.top || py > imgRect.bottom){
        return;
      }

      const localX = px - imgRect.left;
      const localY = py - imgRect.top;
      const w = imgRect.width;
      const h = imgRect.height;

      const normX = localX / w;
      const normY = localY / h;

      const spot = hitTest(normX, normY);

      // 見つけた！
      if(spot && !found.has(spot.id)){
        found.add(spot.id);
        foundEl.textContent = String(found.size);

        // 両方のカードに同じ位置へ◯（それぞれの表示サイズで）
        const markAx = (normX * document.getElementById("cardA").querySelector("img").getBoundingClientRect().width)
          + (document.getElementById("cardA").querySelector("img").getBoundingClientRect().left - document.getElementById("cardA").getBoundingClientRect().left);
        const markAy = (normY * document.getElementById("cardA").querySelector("img").getBoundingClientRect().height)
          + (document.getElementById("cardA").querySelector("img").getBoundingClientRect().top - document.getElementById("cardA").getBoundingClientRect().top);

        const markBx = (normX * document.getElementById("cardB").querySelector("img").getBoundingClientRect().width)
          + (document.getElementById("cardB").querySelector("img").getBoundingClientRect().left - document.getElementById("cardB").getBoundingClientRect().left);
        const markBy = (normY * document.getElementById("cardB").querySelector("img").getBoundingClientRect().height)
          + (document.getElementById("cardB").querySelector("img").getBoundingClientRect().top - document.getElementById("cardB").getBoundingClientRect().top);

        addMark(document.getElementById("cardA"), markAx, markAy);
        addMark(document.getElementById("cardB"), markBx, markBy);

        showToast(`ちがい発見！ (${found.size}/3)`);

        if(found.size >= 3){
          finish(true);
        }
        return;
      }

      // ハズレ
      t = Math.max(0, t - 2.0); // ここは「+2秒」表現したいなら実質-2秒で同等
      timeEl.textContent = t.toFixed(1);
      addX(card, px - rect.left, py - rect.top);
      showToast("ハズレ！ -2.0s");
      if(t <= 0) finish(false);
    }

    // イベント
    document.querySelectorAll(".hitLayer").forEach(el=>{
      el.addEventListener("pointerdown", onTap, {passive:true});
    });

    startBtn.addEventListener("click", start);
    retryBtn.addEventListener("click", start);

    revealBtn.addEventListener("click", ()=>{
      // まだ見つけてない差分を強制表示
      const aCard = document.getElementById("cardA");
      const bCard = document.getElementById("cardB");

      const aImgRect = aCard.querySelector("img").getBoundingClientRect();
      const bImgRect = bCard.querySelector("img").getBoundingClientRect();
      const aCardRect = aCard.getBoundingClientRect();
      const bCardRect = bCard.getBoundingClientRect();

      for(const s of HOTSPOTS){
        if(found.has(s.id)) continue;
        found.add(s.id);
        foundEl.textContent = String(found.size);

        const ax = (s.x * aImgRect.width) + (aImgRect.left - aCardRect.left);
        const ay = (s.y * aImgRect.height) + (aImgRect.top - aCardRect.top);
        const bx = (s.x * bImgRect.width) + (bImgRect.left - bCardRect.left);
        const by = (s.y * bImgRect.height) + (bImgRect.top - bCardRect.top);
        addMark(aCard, ax, ay);
        addMark(bCard, bx, by);
      }
      showToast("答え表示");
    });

    // 初期
    reset();
  </script>
</body>
</html>
