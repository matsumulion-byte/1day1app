<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover,user-scalable=no" />
<title>MATSUMURA QUEST </title>
<style>
  :root{
    --bg:#0b0b0f; --ink:#e9f1f7; --muted:#9aa3ad; --acc:#ffb703;
    --dq:#e9f1f7; --card:#121217; --shadow:0 10px 30px rgba(0,0,0,.35);
    --safe-top: env(safe-area-inset-top, 0px); --safe-bottom: env(safe-area-inset-bottom, 0px);
  }
  *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; touch-action:manipulation }
  html,body{ min-height:100vh; margin:0; padding:0; background:var(--bg); color:var(--ink);
    font-family:"MS Gothic","Osaka-mono","DotGothic16",ui-monospace,monospace;
    overflow-x:hidden; width:100%; touch-action:manipulation }
  #root{ min-height:100vh; display:flex; align-items:center; justify-content:center;
    padding:calc(8px + var(--safe-top)) 0 calc(12px + var(--safe-bottom)) 0;
    width:100%; max-width:100vw }
  .stage{ width:420px; max-width:100%; background:var(--card); border-radius:16px; box-shadow:var(--shadow); overflow:hidden; padding:12px;
    margin:0 auto }
  .battle{
    background:#000 no-repeat;
    background-size:cover;
    background-position:center;
    width:100%; height:300px; border-radius:10px; position:relative; overflow:hidden;
    display:flex; align-items:center; justify-content:center;
  }
  .enemy{
    width:220px; max-width:70%; max-height:80%; height:auto; image-rendering:pixelated;
    filter:drop-shadow(0 6px 18px rgba(0,0,0,.6));
    object-fit:contain;
  }
  .enemy.hit{ animation: flash .25s linear 2 }
  @keyframes flash{
    0%,100%{ filter:drop-shadow(0 6px 18px rgba(0,0,0,.6)) }
    50%{ filter:brightness(2) drop-shadow(0 0 0 rgba(0,0,0,0)) }
  }
  .enemy.vanish{ animation: vanish .8s ease forwards; }
  @keyframes vanish{
    0%{ opacity:1; transform:scale(1) }
    100%{ opacity:0; transform:scale(1.4) }
  }
  .hud{ display:flex; justify-content:space-between; margin-top:10px; gap:8px; font-size:12px; color:var(--muted) }
  .hud .bar{ flex:1; background:#111827; border-radius:8px; overflow:hidden; position:relative; height:10px }
  .hud .bar>i{ position:absolute; inset:0; background:linear-gradient(90deg,#22c55e,#84cc16); width:100% }
  .hud .label{ min-width:72px; text-align:right }
  .dqbox{
    background:#000; color:#e9f1f7; border-radius:8px; margin-top:10px; padding:10px;
    box-shadow:inset 0 0 0 3px var(--dq), inset 0 0 0 6px #000;
  }
  .menu{ display:grid; grid-template-columns:1fr 1fr; gap:6px }
  .menu button{
    width:100%; padding:10px; background:#0b0b0f; color:#e9f1f7;
    border:1px solid var(--dq); border-radius:6px; font-weight:700
  }
  .menu button.sel{ outline:2px solid var(--acc); background:#1e293b; color:#fffbeb }
  .log{ min-height:64px; line-height:1.6 }
  .taphint{ text-align:center; color:var(--muted); font-size:12px; margin-top:6px }
  @media (max-width: 480px) {
    html,body{ min-height:100vh; height:auto }
    #root{ min-height:100vh; padding:calc(4px + var(--safe-top)) 0 calc(8px + var(--safe-bottom)) 0 }
    .stage{ width:100%; padding:8px; border-radius:12px; margin:0 }
    .battle{ height:250px; border-radius:8px; background-size:cover; background-position:center }
    .enemy{ max-width:65%; max-height:75% }
    .dqbox{ padding:8px; margin-top:8px }
    .menu{ gap:4px }
    .menu button{ padding:8px; font-size:14px }
  }
</style>
</head>
<body>
<div id="root">
  <div class="stage" id="stage">
    <div class="battle" id="battle">
      <img id="enemy" class="enemy" alt="enemy" />
    </div>

    <div class="hud">
      <div class="label">まつむら</div>
      <div class="bar"><i id="hpHero"></i></div>
    </div>
    <div class="hud" style="margin-top:4px;">
      <div class="label">ENEMY</div>
      <div class="bar"><i id="hpEnemy"></i></div>
    </div>

    <div id="menuBox" class="dqbox">
      <div class="menu">
        <button data-cmd="fight" class="sel">▶ たたかう</button>
        <button data-cmd="guard">▶ まもる</button>
        <button data-cmd="item">▶ どうぐ</button>
        <button data-cmd="run">▶ にげる</button>
      </div>
    </div>

    <div id="logBox" class="dqbox log">　タップで たたかいを はじめる</div>
    <div class="taphint">※ 勝っても負けても画面タップで もう一度</div>
  </div>
</div>

<script type="module">
// Vercel用のパス解決
const DATE_SEGMENT = (location.pathname.match(/\d{4}-\d{2}-\d{2}/) || [""])[0];
const DATE_BASE = DATE_SEGMENT ? `/${DATE_SEGMENT}/` : '/';
const asset = (p) => {
  const clean = String(p || '').replace(/^\.?\//, '');
  return `${DATE_BASE}${clean}`;
};
const $ = s=> document.querySelector(s);

// DOM
const stage = $('#stage');
const enemyEl = $('#enemy');
const hpHeroEl = $('#hpHero');
const hpEnemyEl = $('#hpEnemy');
const menuBox = $('#menuBox');
const logBox = $('#logBox');
const battleEl = $('#battle');

// アセットパスを設定
enemyEl.src = asset('./assets/enemy.png');
battleEl.style.backgroundImage = `url('${asset('./assets/bg_battle.png')}')`;

// サウンド（BGMのみ）
const S = { bgm: null };
function loadSounds(){
  if(S.bgm) return;
  S.bgm = new Audio(asset('./assets/battle_bgm.mp3'));
  S.bgm.loop = true;
  S.bgm.volume = 0.9;
}

// 状態
let running=false, inputLock=true, finished=true;
const MAX_HERO=100, MAX_ENEMY=70;
let heroHP=MAX_HERO, enemyHP=MAX_ENEMY;

function setHP(el, now, max){
  const w = Math.max(0, Math.min(100, Math.round(now/max*100)));
  el.style.width = w+'%';
}

function reset(){
  running=false; inputLock=true; finished=true;
  heroHP=MAX_HERO; enemyHP=MAX_ENEMY;
  setHP(hpHeroEl, heroHP, MAX_HERO);
  setHP(hpEnemyEl, enemyHP, MAX_ENEMY);
  enemyEl.classList.remove('hit','vanish');
  enemyEl.style.visibility='visible';
  logBox.textContent='　タップで たたかいを はじめる';
}

function start(){
  if(running) return;
  running=true; inputLock=false; finished=false;
  loadSounds();
  S.bgm.play().catch(()=>{});
  typeLine('　モンスターが あらわれた！');
  setTimeout(()=>typeLine('　どうする？（コマンドを えらんでください）'),500);
}

function endBattle(msg){
  running=false; inputLock=true; finished=true;
  typeLine('　'+msg+'（タップで もういちど）');
  S.bgm.pause();
}

// タイプライタ
let typing=0;
function typeLine(text){
  typing++; inputLock=true; logBox.textContent='';
  let i=0;
  const tm=setInterval(()=>{
    const ch=(text[i]!==undefined)?text[i]:'';
    logBox.textContent=logBox.textContent+ch;
    i++;
    if(i>text.length){
      clearInterval(tm);
      typing--;
      if(typing===0 && running) inputLock=false;
    }
  },20);
}

// エフェクト
function enemyShake(){
  enemyEl.classList.add('hit');
  setTimeout(()=>enemyEl.classList.remove('hit'),300);
}

// コマンド
function cmdFight(){
  if(inputLock||!running)return;
  inputLock=true;
  const dmg=Math.floor(Math.random()*10)+10;
  enemyHP=Math.max(0,enemyHP-dmg);
  enemyShake();
  setHP(hpEnemyEl,enemyHP,MAX_ENEMY);
  typeLine(`　まつむらの こうげき！　${dmg} の ダメージ！`);
  setTimeout(()=>enemyHP<=0?win():enemyTurn(),520);
}

function cmdGuard(){
  if(inputLock||!running)return;
  inputLock=true;
  typeLine('　まつむらは みをまもっている！');
  setTimeout(()=>enemyTurn(true),420);
}

function cmdItem(){
  if(inputLock||!running)return;
  inputLock=true;
  const heal=Math.floor(Math.random()*10)+8;
  heroHP=Math.min(MAX_HERO,heroHP+heal);
  setHP(hpHeroEl,heroHP,MAX_HERO);
  typeLine(`　やくそうを つかった！　HPが ${heal} かいふく！`);
  setTimeout(()=>enemyTurn(),520);
}

function cmdRun(){
  if(inputLock||!running)return;
  inputLock=true;
  const ok=Math.random()<0.35;
  if(ok){
    typeLine('　にげだした！');
    setTimeout(()=>endBattle('たたかいは おわった。'),600);
  }else{
    typeLine('　しかし まわりこまれてしまった！');
    setTimeout(()=>enemyTurn(),520);
  }
}

function enemyTurn(guarded=false){
  const dmg=Math.floor(Math.random()*8)+5;
  const real=guarded?Math.max(1,Math.floor(dmg*0.4)):dmg;
  heroHP=Math.max(0,heroHP-real);
  setHP(hpHeroEl,heroHP,MAX_HERO);
  typeLine(`　モンスターの こうげき！　${real} の ダメージ！`);
  setTimeout(()=>{
    if(heroHP<=0)lose();
    else{inputLock=false;typeLine('　どうする？');}
  },520);
}

function win(){
  typeLine('　モンスターを たおした！');
  enemyEl.classList.add('vanish');
  setTimeout(()=>{enemyEl.style.visibility='hidden';},800);
  setTimeout(()=>{typeLine('　レベルが あがった！（気がする）');},700);
  setTimeout(()=>endBattle('けいけんちを てにいれた（気がする）'),1600);
}

function lose(){
  typeLine('　まつむらは ちからつきた…');
  setTimeout(()=>endBattle('めのまえが まっくらに なった'),1200);
}

// メニュー操作
const menuButtons=[...menuBox.querySelectorAll('button')];
function setSel(i){menuButtons.forEach((b,idx)=>b.classList.toggle('sel',idx===i));}
let selIdx=0;setSel(selIdx);
menuBox.addEventListener('click',e=>{
  const b=e.target.closest('button');if(!b||inputLock||!running)return;
  const cmd=b.dataset.cmd;
  if(cmd==='fight')cmdFight();
  if(cmd==='guard')cmdGuard();
  if(cmd==='item')cmdItem();
  if(cmd==='run')cmdRun();
});
window.addEventListener('keydown',e=>{
  if(!running||inputLock)return;
  if(e.key==='ArrowDown'){selIdx=(selIdx+1)%menuButtons.length;setSel(selIdx);}
  if(e.key==='ArrowUp'){selIdx=(selIdx-1+menuButtons.length)%menuButtons.length;setSel(selIdx);}
  if(e.key==='Enter'||e.key===' '){menuButtons[selIdx].click();}
});

// タップで開始/再戦
stage.addEventListener('pointerdown',(e)=>{
  e.preventDefault();
  if(!running&&finished){reset();start();}
},{passive:false});

// ダブルタップズームを防ぐ
let lastTouchEnd = 0;
document.addEventListener('touchend', (e) => {
  const now = Date.now();
  if (now - lastTouchEnd <= 300) {
    e.preventDefault();
  }
  lastTouchEnd = now;
}, false);

// 初期化
reset();
</script>
</body>
</html>
