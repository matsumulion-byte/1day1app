<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
  <meta name="theme-color" content="#0b1020" />
  <title>MATSUMURA GACHA</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:rgba(255,255,255,.08);
      --panel2:rgba(255,255,255,.12);
      --line:rgba(255,255,255,.14);
      --ink:#f3f6ff;
      --muted:rgba(243,246,255,.72);
      --r:18px;
      --shadow: 0 18px 60px rgba(0,0,0,.55);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%; background:var(--bg); color:var(--ink); overflow:hidden}
    body{
      font-family: ui-sans-serif, system-ui, -apple-system, "Hiragino Kaku Gothic ProN","Noto Sans JP", "Segoe UI", Arial, sans-serif;
      -webkit-font-smoothing: antialiased;
      touch-action: manipulation;
    }
    a,button{color:inherit}
    .app{
      height:100%;
      display:flex;
      flex-direction:column;
      padding:16px;
      gap:12px;
      max-width:520px;
      margin:0 auto;
    }
    header{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      padding:14px 14px;
      border-radius:var(--r);
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      border:1px solid var(--line);
      box-shadow: var(--shadow);
    }
    .hgroup{display:flex; flex-direction:column; gap:6px;}
    .title{font-weight:800; letter-spacing:.06em; font-size:18px;}
    .sub{color:var(--muted); font-size:12px; line-height:1.35}
    .meta{display:flex; flex-direction:column; gap:6px; align-items:flex-end}
    .chip{
      padding:6px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      background:rgba(0,0,0,.18);
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }
    .meta small{color:var(--muted); font-size:11px}
    main{flex:1; display:flex; flex-direction:column; gap:12px; overflow:hidden}
    .card{
      border-radius:var(--r);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
      border:1px solid var(--line);
      box-shadow: 0 12px 40px rgba(0,0,0,.42);
      overflow:hidden;
    }
    .hero{
      position:relative;
      height:310px;
      display:flex;
      align-items:center;
      justify-content:center;
      background:
        radial-gradient(60% 60% at 50% 35%, rgba(96,165,250,.22), transparent 55%),
        radial-gradient(60% 60% at 70% 65%, rgba(34,211,238,.12), transparent 55%),
        rgba(0,0,0,.20);
    }
    .hero-inner{
      width:100%;
      height:100%;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:14px;
      padding:16px;
    }
    .capsule{
      width:120px; height:120px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.22);
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.30), transparent 55%),
        radial-gradient(circle at 65% 70%, rgba(255,255,255,.18), transparent 55%),
        rgba(255,255,255,.06);
      box-shadow: 0 20px 60px rgba(0,0,0,.55);
      position:relative;
      overflow:hidden;
    }
    .capsule::after{
      content:"";
      position:absolute; inset:-30%;
      background:conic-gradient(from 90deg,
        rgba(255,255,255,.18),
        rgba(255,255,255,0),
        rgba(255,255,255,.12),
        rgba(255,255,255,0)
      );
      transform: rotate(0deg);
      opacity:.9;
      animation: spin 2.4s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    .hero-text{color:var(--muted); font-size:12px}
    .actions{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      padding:12px;
    }
    button{
      border:1px solid var(--line);
      background:rgba(255,255,255,.08);
      border-radius:14px;
      padding:12px 12px;
      font-weight:700;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    button:active{transform: translateY(1px)}
    button.primary{
      background:linear-gradient(180deg, rgba(96,165,250,.28), rgba(96,165,250,.12));
      border-color: rgba(96,165,250,.35);
    }
    button.secondary{
      background:rgba(255,255,255,.06);
    }
    button.ghost{
      background:transparent;
    }
    button:disabled{
      opacity:.45;
      cursor:not-allowed;
    }
    .footer{
      padding:10px 12px 12px;
      display:flex;
      gap:10px;
      justify-content:space-between;
      align-items:center;
      border-top:1px solid rgba(255,255,255,.10);
      color:var(--muted);
      font-size:12px;
    }

    /* Modal */
    .backdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.62);
      display:none;
      align-items:flex-start;
      justify-content:center;
      padding:16px;
      z-index:50;
      overflow:auto;
    }
    .backdrop.show{display:flex}
    .modal{
      width:min(520px, 100%);
      border-radius:22px;
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      border:1px solid rgba(255,255,255,.18);
      box-shadow: 0 20px 80px rgba(0,0,0,.7);
      overflow:hidden;
      position:relative;
    }
    .modal-top{
      display:flex; justify-content:space-between; align-items:center;
      padding:12px 12px;
      border-bottom:1px solid rgba(255,255,255,.12);
    }
    .badge{
      font-size:12px;
      font-weight:800;
      letter-spacing:.06em;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.20);
      background:rgba(0,0,0,.18);
    }
    .close{
      width:40px; height:36px;
      display:grid; place-items:center;
      border-radius:12px;
    }
    .modal-body{padding:12px}
    .reveal{
      border-radius:18px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.22);
    }
    .reveal .imgwrap{
      position:relative;
      aspect-ratio: 4 / 5;
      display:grid;
      place-items:center;
      background: rgba(0,0,0,.22);
    }
    .reveal img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
      transition: opacity .15s ease;
      opacity:0;
    }
    .reveal img.on{
      opacity:1;
    }
    .rarityline{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      margin-top:10px;
      color:var(--muted);
      font-size:12px;
    }
    .newpill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 8px;
      border-radius:999px;
      background:rgba(34,197,94,.16);
      border:1px solid rgba(34,197,94,.30);
      color:rgba(209,250,229,.95);
      font-weight:800;
      font-size:11px;
    }
    .hint{
      margin-top:8px;
      color:var(--muted);
      font-size:12px;
      line-height:1.45;
    }

    /* Rarity FX */
    .fx{position:absolute; inset:0; pointer-events:none; opacity:0}
    .fx.on{opacity:1}
    .fx.n{background:transparent}
    .fx.r{
      background: radial-gradient(60% 60% at 50% 40%, rgba(59,130,246,.28), transparent 60%);
      animation: pulse 900ms ease-in-out infinite alternate;
    }
    .fx.sr{
      background:
        radial-gradient(60% 60% at 50% 40%, rgba(34,211,238,.22), transparent 60%),
        radial-gradient(60% 60% at 50% 70%, rgba(167,139,250,.18), transparent 65%);
      animation: pulse 780ms ease-in-out infinite alternate;
    }
    .fx.ssr{
      background:
        conic-gradient(from 0deg,
          rgba(255,255,255,.00),
          rgba(99,102,241,.22),
          rgba(34,211,238,.20),
          rgba(96,165,250,.20),
          rgba(244,114,182,.18),
          rgba(255,255,255,.00)
        );
      filter: blur(1px);
      animation: spin 1.4s linear infinite;
      opacity:.7;
    }
    .fx.ur{
      background:
        radial-gradient(60% 60% at 50% 40%, rgba(250,204,21,.22), transparent 60%),
        conic-gradient(from 90deg,
          rgba(250,204,21,.0),
          rgba(250,204,21,.22),
          rgba(255,255,255,.0),
          rgba(250,204,21,.18),
          rgba(255,255,255,.0)
        );
      animation: spin 1.1s linear infinite;
      opacity:.85;
    }
    @keyframes pulse{to{transform:scale(1.02); opacity:.85}}

    /* Catalog */
    .catalog{
      display:none;
      flex:1;
      overflow:hidden;
    }
    .catalog.show{display:flex; flex-direction:column; gap:10px}
    .catalog-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px;
    }
    .catalog-head .left{
      display:flex; flex-direction:column; gap:4px;
    }
    .catalog-head .left b{font-size:14px}
    .catalog-head .left span{font-size:12px;color:var(--muted)}
    .grid{
      padding:0 12px 12px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    .tile{
      position:relative;
      border-radius:14px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      aspect-ratio: 1 / 1.2;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .tile img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .locked{
      display:grid;
      place-items:center;
      color:rgba(243,246,255,.55);
      font-weight:900;
      letter-spacing:.08em;
      background:
        radial-gradient(60% 60% at 50% 35%, rgba(255,255,255,.08), transparent 60%),
        rgba(0,0,0,.30);
    }
    .tile .tag{
      position:absolute;
      left:8px; top:8px;
      font-size:10px;
      font-weight:900;
      padding:4px 7px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.30);
    }
    .tile .newdot{
      position:absolute;
      right:8px; top:8px;
      font-size:10px;
      font-weight:900;
      padding:4px 7px;
      border-radius:999px;
      background:rgba(34,197,94,.16);
      border:1px solid rgba(34,197,94,.30);
      color:rgba(209,250,229,.95);
    }

    /* 10-pull results */
    .results{
      margin-top:10px;
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      gap:8px;
    }
    .mini{
      border-radius:12px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.22);
      aspect-ratio: 1 / 1.15;
      position:relative;
      cursor:pointer;
    }
    .mini img{width:100%;height:100%;object-fit:cover;display:block}
    .mini .rmini{
      position:absolute; left:6px; bottom:6px;
      font-size:10px; font-weight:900;
      padding:3px 6px; border-radius:999px;
      background:rgba(0,0,0,.30);
      border:1px solid rgba(255,255,255,.18);
    }
    .mini .nmini{
      position:absolute; right:6px; top:6px;
      font-size:10px; font-weight:900;
      padding:3px 6px; border-radius:999px;
      background:rgba(34,197,94,.16);
      border:1px solid rgba(34,197,94,.30);
      color:rgba(209,250,229,.95);
    }

    /* PC時の図鑑グリッド調整 */
    @media (min-width: 768px){
      .grid{
        grid-template-columns: repeat(4, 1fr);
        gap:14px;
      }
    }

    @media (max-height:720px){
      .hero{height:280px}
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="hgroup">
        <div class="title">MATSUMURA GACHA</div>
        <div class="sub">当たりもハズレも、松村。</div>
      </div>
      <div class="meta">
        <div class="chip" id="rateChip">松村回収率：--%</div>
        <small id="countText">累計：0回</small>
      </div>
    </header>

    <main>
      <section class="card" id="homeCard">
        <div class="hero">
          <div class="hero-inner">
            <div class="capsule" aria-hidden="true"></div>
            <div class="hero-text">回して、引いて、図鑑を埋める。</div>
          </div>
        </div>
        <div class="actions">
          <button class="primary" id="btnSingle">回す（1回）</button>
          <button class="secondary" id="btnTen">10連を回す</button>
          <button class="ghost" id="btnCatalog">図鑑を見る</button>
          <button class="ghost" id="btnReset">リセット</button>
        </div>
        <div class="footer">
          <div>レア：N / R / SR / SSR / UR</div>
          <div id="status">準備OK</div>
        </div>
      </section>

      <section class="card catalog" id="catalogCard">
        <div class="catalog-head">
          <div class="left">
            <b>図鑑</b>
            <span id="catalogSub">-- / --</span>
          </div>
          <div style="display:flex; gap:8px;">
            <button class="secondary" id="btnBack">戻る</button>
          </div>
        </div>
        <div class="grid" id="grid"></div>
      </section>
    </main>
  </div>

  <!-- Reveal Modal -->
  <div class="backdrop" id="backdrop" role="dialog" aria-modal="true" aria-label="結果">
    <div class="modal">
      <div class="modal-top">
        <div class="badge" id="badge">N</div>
        <button class="close ghost" id="btnClose" aria-label="閉じる">✕</button>
      </div>
      <div class="modal-body">
        <div class="reveal">
          <div class="imgwrap" id="imgwrap">
            <div class="fx n" id="fx"></div>
            <img id="resultImg" alt="matsumura" />
          </div>
        </div>

        <div class="rarityline">
          <div id="idText">—</div>
          <div id="newText" style="display:none" class="newpill">NEW</div>
        </div>

        <div id="tenBlock" style="display:none">
          <div class="hint">10連結果（タップで拡大）</div>
          <div class="results" id="results"></div>
        </div>

        <div class="hint" id="hint">—</div>
      </div>
    </div>
  </div>

  <script type="module">
    // 1日1アプリ ルール：動的アセットは import.meta.url を使う
    const asset = (p) => {
      const clean = (p || "").replace(/^\.\//, "");
      // Vercel のルーティング（ /YYYY-MM-DD → /apps/YYYY-MM-DD/... ）に対応
      const m = window.location.pathname.match(/^\/(\d{4}-\d{2}-\d{2})(?:\/|$)/);
      if(m){
        return `/${m[1]}/${clean}`;
      }
      // ローカル開発や直接 /apps/... を開いたとき用
      return new URL(p, import.meta.url).toString();
    };

    /**
     * ここに assets 内の画像ファイル名を列挙してください。
     * 例： /app/2026-02-17/assets/matsumura_01.jpg なら "./assets/matsumura_01.jpg"
     */
    const IMAGE_FILES = [
      "./assets/matsumura_01.png",
      "./assets/matsumura_02.png",
      "./assets/matsumura_03.png",
      "./assets/matsumura_04.png",
      "./assets/matsumura_05.png",
      "./assets/matsumura_06.png",
      "./assets/matsumura_07.png",
      "./assets/matsumura_08.png",
      "./assets/matsumura_09.png",
      "./assets/matsumura_10.png",
      "./assets/matsumura_11.png",
      "./assets/matsumura_12.png",

      // ...増やす
    ];

    // レアリティ確率（合計100）
    const RARITIES = [
      { key:"N",   p:60, fx:"n",   hint:"平常運転 松村" },
      { key:"R",   p:25, fx:"r",   hint:"ちょい良い 松村" },
      { key:"SR",  p:10, fx:"sr",  hint:"仕事できそう 松村" },
      { key:"SSR", p:4,  fx:"ssr", hint:"神々しい 松村" },
      { key:"UR",  p:1,  fx:"ur",  hint:"松村神" },
    ];

    const STORAGE_KEY = "matsumura_gacha_v1";

    const $ = (id) => document.getElementById(id);

    const el = {
      rateChip: $("rateChip"),
      countText: $("countText"),
      status: $("status"),

      homeCard: $("homeCard"),
      catalogCard: $("catalogCard"),

      btnSingle: $("btnSingle"),
      btnTen: $("btnTen"),
      btnCatalog: $("btnCatalog"),
      btnReset: $("btnReset"),
      btnBack: $("btnBack"),

      grid: $("grid"),
      catalogSub: $("catalogSub"),

      backdrop: $("backdrop"),
      btnClose: $("btnClose"),
      badge: $("badge"),
      fx: $("fx"),
      resultImg: $("resultImg"),
      idText: $("idText"),
      newText: $("newText"),
      hint: $("hint"),

      tenBlock: $("tenBlock"),
      results: $("results"),
    };

    function safeImages() {
      // 空だと何もできないのでガード
      return IMAGE_FILES.filter(Boolean);
    }

    function loadState() {
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return { owned:{}, pulls:0, newFlags:{} };
        const st = JSON.parse(raw);
        return {
          owned: st.owned ?? {},
          pulls: Number.isFinite(st.pulls) ? st.pulls : 0,
          newFlags: st.newFlags ?? {}
        };
      }catch{
        return { owned:{}, pulls:0, newFlags:{} };
      }
    }
    function saveState(st){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(st));
    }

    function pickRarity(){
      const roll = Math.random() * 100;
      let acc = 0;
      for(const r of RARITIES){
        acc += r.p;
        if(roll < acc) return r;
      }
      return RARITIES[0];
    }

    function pickImage(){
      const imgs = safeImages();
      if(imgs.length === 0) return null;
      const idx = Math.floor(Math.random() * imgs.length);
      return imgs[idx];
    }

    function idFromPath(p){
      // 図鑑のキー：ファイル名で管理
      try{
        const u = new URL(p, import.meta.url);
        return u.pathname.split("/").pop() || p;
      }catch{
        return p.split("/").pop() || p;
      }
    }

    function updateHeader(){
      const imgs = safeImages();
      const total = imgs.length;
      const ownedCount = Object.values(state.owned).filter(Boolean).length;
      const rate = total ? Math.round((ownedCount / total) * 100) : 0;

      el.rateChip.textContent = `松村回収率：${total ? rate : "--"}%`;
      el.countText.textContent = `累計：${state.pulls}回`;

      el.catalogSub.textContent = `${ownedCount} / ${total}（${total ? rate : 0}%）`;
    }

    function showStatus(msg){
      el.status.textContent = msg;
      clearTimeout(showStatus._t);
      showStatus._t = setTimeout(()=>{ el.status.textContent = "準備OK"; }, 1200);
    }

    function openModalSingle(result){
      el.tenBlock.style.display = "none";
      el.results.innerHTML = "";

      el.backdrop.classList.add("show");
      applyResultToModal(result);
    }

    function openModalTen(results){
      // 10連は1枚目をメイン表示、下に結果一覧
      el.backdrop.classList.add("show");
      el.tenBlock.style.display = "block";
      el.results.innerHTML = "";

      applyResultToModal(results[0], { label:`10連 1/10` });

      results.forEach((res, i)=>{
        const d = document.createElement("div");
        d.className = "mini";
        const img = document.createElement("img");
        img.src = asset(res.path);
        img.alt = "matsumura";
        d.appendChild(img);

        const r = document.createElement("div");
        r.className = "rmini";
        r.textContent = res.rarity.key;
        d.appendChild(r);

        if(res.isNew){
          const n = document.createElement("div");
          n.className = "nmini";
          n.textContent = "NEW";
          d.appendChild(n);
        }

        d.addEventListener("click", ()=>{
          applyResultToModal(res, { label:`10連 ${i+1}/10` });
        });

        el.results.appendChild(d);
      });
    }

    function applyResultToModal(result, opt = {}){
      const { rarity, path, id, isNew } = result;

      el.badge.textContent = rarity.key;
      el.idText.textContent = opt.label ? `${opt.label} · ${id}` : id;

      el.newText.style.display = isNew ? "inline-flex" : "none";
      el.hint.textContent = rarity.hint;

      // fx
      el.fx.className = `fx on ${rarity.fx}`;

      // image（フェードイン）
      el.resultImg.classList.remove("on");
      el.resultImg.src = asset(path);
      requestAnimationFrame(()=> el.resultImg.classList.add("on"));

      // NEWフラグは一度表示したら消す（次からはNEWにならない）
      if(state.newFlags[id]){
        state.newFlags[id] = false;
        saveState(state);
        // 図鑑側の NEW 表示更新に備えてヘッダーも更新
        updateHeader();
      }
    }

    function closeModal(){
      el.backdrop.classList.remove("show");

      // モーダル内容をリセット
      el.resultImg.removeAttribute("src");     // 画像を消す
      el.fx.className = "fx n";                // FXを初期化
      el.badge.textContent = "";               // バッジ消す
      el.idText.textContent = "";              // IDテキスト消す
      el.hint.textContent = "";                // ヒント消す
      el.newText.style.display = "none";       // NEWを消す

      el.tenBlock.style.display = "none";      // 10連ブロックを閉じる
      el.results.innerHTML = "";               // 10連サムネを消す
    }

    function goCatalog(){
      el.homeCard.style.display = "none";
      el.catalogCard.classList.add("show");
      renderCatalog();
    }
    function goHome(){
      el.catalogCard.classList.remove("show");
      el.homeCard.style.display = "";
    }

    function renderCatalog(){
      const imgs = safeImages();
      el.grid.innerHTML = "";

      imgs.forEach((p)=>{
        const id = idFromPath(p);
        const owned = !!state.owned[id];
        const isNew = !!state.newFlags[id];

        const tile = document.createElement("div");
        tile.className = "tile";

        if(owned){
          const img = document.createElement("img");
          img.src = asset(p);
          img.alt = "matsumura";
          tile.appendChild(img);

          const tag = document.createElement("div");
          tag.className = "tag";
          tag.textContent = "OWNED";
          tile.appendChild(tag);

          if(isNew){
            const nd = document.createElement("div");
            nd.className = "newdot";
            nd.textContent = "NEW";
            tile.appendChild(nd);
          }

          tile.addEventListener("click", ()=>{
            // 図鑑タップ時はレアなしで開くのもアリだけど、
            // 今回は「最後に引いたレア」を保持してないので N 表示で統一
            const rarity = RARITIES[0];
            const res = { rarity, path:p, id, isNew };
            el.backdrop.classList.add("show");
            el.tenBlock.style.display = "none";
            el.results.innerHTML = "";
            applyResultToModal(res, { label:"図鑑" });
          });
        }else{
          const locked = document.createElement("div");
          locked.className = "locked";
          locked.textContent = "???";
          tile.appendChild(locked);

          const tag = document.createElement("div");
          tag.className = "tag";
          tag.textContent = "LOCK";
          tile.appendChild(tag);
        }

        el.grid.appendChild(tile);
      });

      updateHeader();
    }

    function doSingle(){
      const p = pickImage();
      if(!p){
        showStatus("assets に画像がありません");
        return;
      }

      const rarity = pickRarity();
      const id = idFromPath(p);

      state.pulls += 1;

      const wasOwned = !!state.owned[id];
      if(!wasOwned){
        state.owned[id] = true;
        state.newFlags[id] = true;
      }

      saveState(state);
      updateHeader();

      // 演出：少し待ってから表示（「回した感」）
      el.btnSingle.disabled = true;
      el.btnTen.disabled = true;
      showStatus("回転中…");

      setTimeout(()=>{
        el.btnSingle.disabled = false;
        el.btnTen.disabled = false;

        openModalSingle({
          rarity,
          path: p,
          id,
          isNew: !wasOwned
        });
      }, 650);
    }

    function doTen(){
      const imgs = safeImages();
      if(imgs.length === 0){
        showStatus("assets に画像がありません");
        return;
      }

      el.btnSingle.disabled = true;
      el.btnTen.disabled = true;
      showStatus("10連回転中…");

      const results = [];
      for(let i=0;i<10;i++){
        const p = pickImage();
        const rarity = pickRarity();
        const id = idFromPath(p);

        state.pulls += 1;

        const wasOwned = !!state.owned[id];
        if(!wasOwned){
          state.owned[id] = true;
          state.newFlags[id] = true;
        }

        results.push({
          rarity,
          path: p,
          id,
          isNew: !wasOwned
        });
      }

      saveState(state);
      updateHeader();

      setTimeout(()=>{
        el.btnSingle.disabled = false;
        el.btnTen.disabled = false;
        openModalTen(results);
      }, 800);
    }

    function resetAll(){
      const ok = confirm("図鑑と累計回数をリセットします。よろしいですか？");
      if(!ok) return;
      state = { owned:{}, pulls:0, newFlags:{} };
      saveState(state);
      updateHeader();
      if(el.catalogCard.classList.contains("show")) renderCatalog();
      showStatus("リセットしました");
    }

    // init
    let state = loadState();
    updateHeader();

    // bind
    el.btnSingle.addEventListener("click", doSingle);
    el.btnTen.addEventListener("click", doTen);
    el.btnCatalog.addEventListener("click", goCatalog);
    el.btnBack.addEventListener("click", goHome);
    el.btnReset.addEventListener("click", resetAll);

    el.btnClose.addEventListener("click", closeModal);
    el.backdrop.addEventListener("click", (e)=>{
      if(e.target === el.backdrop) closeModal();
    });
    window.addEventListener("keydown", (e)=>{
      if(e.key === "Escape") closeModal();
    });

    // 画像が未設定なら案内
    if(safeImages().length === 0){
      showStatus("IMAGE_FILES を追加してください");
    }
  </script>
</body>
</html>
