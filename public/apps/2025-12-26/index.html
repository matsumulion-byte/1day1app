<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
  <title>ä»•äº‹ç´ã‚BOX ã€œæ¾æ‘ã‚’ç´ã‚ã‚ã€œ</title>
  <meta name="theme-color" content="#0b1020" />
  <style>
    :root{
      --bg1:#070a14;
      --bg2:#0b1020;
      --ink:#f3f6ff;
      --muted:rgba(243,246,255,.70);
      --line:rgba(255,255,255,.14);
      --panel:rgba(255,255,255,.07);
      --panel2:rgba(255,255,255,.11);
      --good:#34d399;
      --bad:#fb7185;
      --r:18px;
      --shadow: 0 18px 50px rgba(0,0,0,.45);
    }

    *{ box-sizing:border-box; margin:0; padding:0; }
    html,body{ width:100%; height:100%; overflow:hidden; background: radial-gradient(1200px 900px at 50% 15%, #101a3a 0%, var(--bg2) 40%, var(--bg1) 100%); color:var(--ink); }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Yu Gothic", sans-serif;
      -webkit-tap-highlight-color: transparent;
      touch-action: none; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«/æ‹¡å¤§/ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ã‚’æŠ‘æ­¢ */
      user-select: none;
      -webkit-user-select: none;
      -webkit-touch-callout: none;
    }

    .app{
      position:relative;
      width:100%;
      height:100%;
    }

    /* HUD */
    .hud{
      position:absolute;
      left:12px; right:12px; top:10px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      z-index:50;
      pointer-events:none;
    }
    .hud .pill{
      pointer-events:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      border:1px solid var(--line);
      border-radius:999px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      font-weight:700;
      letter-spacing:.02em;
    }
    .hud .pill small{ font-weight:700; color:var(--muted); }
    .hud .pill .num{ font-variant-numeric: tabular-nums; }

    /* Stage */
    #stage {
  position: absolute;
  inset: 0;
  overflow: hidden;

  background:
    linear-gradient(
      rgba(7,10,20,.35),
      rgba(7,10,20,.55)
    ),
    /* background-image set by JS */
}


    /* Box area */
    .boxWrap{
      position:absolute;
      left:50%;
      bottom:14px;
      transform:translateX(-50%);
      width:min(420px, 92vw);
      height:min(240px, 30vh);
      border-radius: calc(var(--r) + 6px);
      z-index:30;
      display:flex;
      align-items:flex-end;
      justify-content:center;
      pointer-events:none;
    }
    .box{
      position:relative;
      width:100%;
      height:100%;
      border-radius: calc(var(--r) + 6px);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      border:1px solid var(--line);
      box-shadow: var(--shadow);
      overflow:hidden;
      transform: translateY(0) scale(1);
      transition: transform 120ms ease;
      display:flex;
      align-items:flex-end;
      justify-content:center;
    }

    /* ç®±ç”»åƒï¼ˆã‚ã‚Œã°å·®ã—æ›¿ãˆï¼‰ */
    .box .img{
      position:absolute;
      inset:0;
      display:flex;
      align-items:flex-end;
      justify-content:center;
      padding:14px;
    }
    .box .img img{
      width:100%;
      height:100%;
      object-fit:contain;
      filter: drop-shadow(0 12px 22px rgba(0,0,0,.35));
      opacity:.95;
    }

    /* ç®±ã®ä¸­ã«å¸ã„è¾¼ã‚€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆï¼ˆå½“ãŸã‚Šåˆ¤å®šã®å¯è¦–åŒ–ã«ã‚‚ä½¿ãˆã‚‹ï¼‰ */
    .box .mouth{
      position:absolute;
      left:10%;
      right:10%;
      top:28%;
      bottom:18%;
      border-radius: 18px;
      background: radial-gradient(600px 240px at 50% 70%, rgba(0,0,0,.35), rgba(0,0,0,.08) 55%, rgba(255,255,255,.06) 100%);
      border:1px dashed rgba(255,255,255,.16);
      opacity:.35;
      pointer-events:none;
    }
    .box .label{
      position:absolute;
      left:12px;
      top:10px;
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:8px 10px;
      border-radius:999px;
      background: rgba(0,0,0,.28);
      border:1px solid rgba(255,255,255,.14);
      color:rgba(243,246,255,.92);
      font-weight:800;
      letter-spacing:.03em;
      font-size:12px;
    }
    .box .label b{ color:#fff; }
    .box .fill{
      position:absolute;
      left:0; right:0; bottom:0;
      height:0%;
      background: linear-gradient(180deg, rgba(52,211,153,.00), rgba(52,211,153,.18));
      transition: height 180ms ease;
      pointer-events:none;
    }

    /* Matsumura items */
    .matsu{
      position:absolute;
      width:70px;
      height:70px;
      border-radius:16px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      box-shadow: 0 12px 30px rgba(0,0,0,.35);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      transform: translate3d(0,0,0);
      touch-action:none;
      will-change: transform, left, top;
    }
    .matsu img{
      width:100%;
      height:100%;
      object-fit:contain;
      pointer-events:none;
      -webkit-user-drag:none;
      user-drag:none;
    }
    .matsu::after{
      content:"";
      position:absolute;
      inset:-1px;
      border-radius:16px;
      background: radial-gradient(120px 90px at 30% 15%, rgba(255,255,255,.16), rgba(255,255,255,0) 60%);
      pointer-events:none;
    }
    .matsu.grab{
      box-shadow: 0 18px 48px rgba(0,0,0,.55);
      transform: translate3d(0,0,0) scale(1.04);
      border-color: rgba(255,255,255,.22);
    }
    .matsu.snap{
      transition: transform 140ms ease, opacity 140ms ease;
    }

    /* Start / End overlay */
    .overlay{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:100;
      background: radial-gradient(900px 700px at 50% 20%, rgba(16,26,58,.78), rgba(7,10,20,.92));
      padding:22px;
    }
    .card{
      width:min(520px, 92vw);
      border-radius: calc(var(--r) + 10px);
      border:1px solid rgba(255,255,255,.16);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
      padding:18px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .title{
      font-size:20px;
      font-weight:900;
      letter-spacing:.03em;
      margin-bottom:10px;
    }
    .desc{
      font-size:13px;
      line-height:1.55;
      color:var(--muted);
      margin-bottom:14px;
    }
    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .btn{
      appearance:none;
      border:none;
      border-radius: 999px;
      padding:12px 14px;
      font-weight:900;
      letter-spacing:.03em;
      cursor:pointer;
      background: rgba(255,255,255,.10);
      color:var(--ink);
      border:1px solid rgba(255,255,255,.16);
    }
    .btn.primary{
      background: linear-gradient(180deg, rgba(52,211,153,.95), rgba(52,211,153,.78));
      color:#062015;
      border:1px solid rgba(52,211,153,.35);
    }
    .hint{
      margin-top:10px;
      font-size:12px;
      color:rgba(243,246,255,.62);
    }
    .result{
      margin-top:10px;
      padding:12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      color:rgba(243,246,255,.9);
      line-height:1.6;
      font-size:13px;
    }

    /* Small screens */
    @media (max-width: 420px){
      .matsu{ width:62px; height:62px; border-radius:14px; }
      .matsu::after{ border-radius:14px; }
      .title{ font-size:18px; }
    }

    /* Prevent iOS long-press image save / selection */
    img{ -webkit-touch-callout:none; }
  </style>
</head>
<body>
  <div class="app">
    <div class="hud">
      <div class="pill"><small>æ®‹ã‚Š</small><span class="num" id="time">30.0</span></div>
      <div class="pill"><small>ç´å“æ•°</small><span class="num" id="score">0</span><small>/</small><span class="num" id="total">30</span></div>
    </div>

    <div id="stage" aria-label="game stage">
      <div class="boxWrap">
        <div class="box" id="box">
          <div class="fill" id="fill"></div>
          <div class="label">ğŸ“¦ <b>ä»•äº‹ç´ã‚BOX</b></div>
          <div class="mouth" id="mouth" aria-hidden="true"></div>
          <div class="img" aria-hidden="true">
            <!-- ç®±ç”»åƒã‚’ç”¨æ„ã—ã¦ã‚‹ãªã‚‰å·®ã—æ›¿ãˆ -->
            <img id="boxImg" alt="ç®±" />
          </div>
        </div>
      </div>
    </div>

    <!-- Start / End overlay -->
    <div class="overlay" id="overlay">
      <div class="card">
        <div class="title">ä»•äº‹ç´ã‚BOX ã€œæ¾æ‘ã‚’ç´ã‚ã‚ã€œ</div>
        <div class="desc">
          30ç§’ã§ã€æ•£ã‚‰ã°ã£ãŸæ¾æ‘ãŸã¡ï¼ˆ30ä½“ï¼‰ã‚’ç®±ã«ç´ã‚ã¦ãã ã•ã„ã€‚<br>
          æ“ä½œã¯ <b>ã‚¿ãƒƒãƒ—ï¼†ãƒ‰ãƒ©ãƒƒã‚°</b> ã ã‘ã€‚
        </div>
        <div class="row">
          <button class="btn primary" id="startBtn">ã¯ã˜ã‚ã‚‹</button>
          <button class="btn" id="howBtn">æ“ä½œ</button>
        </div>
        <div class="hint" id="hint">
          â€» éŸ³ã‚’é³´ã‚‰ã™ãŸã‚ã€é–‹å§‹ã¯ã‚¿ãƒƒãƒ—æ“ä½œãŒå¿…è¦ã§ã™ã€‚
        </div>
        <div class="result" id="help" style="display:none;">
          ãƒ»æ¾æ‘ã‚’æ´ã‚“ã§ã€ç®±ã®ä¸­ã¸ãƒ‰ãƒ©ãƒƒã‚°ã™ã‚‹ã¨ç´å“ã€‚<br>
          ãƒ»ç®±ã®å£ï¼ˆç‚¹ç·šã‚¨ãƒªã‚¢ï¼‰ã«å…¥ã‚Œã°OKã€‚<br>
          ãƒ»å…¨éƒ¨ç´ã‚ã‚‹ã¨å³ã‚¯ãƒªã‚¢ã€‚
        </div>
      </div>
    </div>

    <audio id="bgm" preload="auto"></audio>
  </div>

  <script type="module">
    // 1æ—¥1ã‚¢ãƒ—ãƒª ãƒ«ãƒ¼ãƒ«ï¼šå‹•çš„ã‚¢ã‚»ãƒƒãƒˆã¯ import.meta.url ã‚’ä½¿ã†
    // Vercelç”¨ï¼šç¾åœ¨ã®URLãƒ‘ã‚¹ã‚’ãƒ™ãƒ¼ã‚¹ã«ã™ã‚‹
    const asset = (p) => {
      const basePath = window.location.pathname.replace(/\/$/, '') || '';
      return basePath + '/' + p.replace(/^\.\//, '');
    };

    // ===== ã‚¢ã‚»ãƒƒãƒˆï¼ˆè¦ï¼šãƒ•ã‚¡ã‚¤ãƒ«åã‚’åˆã‚ã›ã‚‹ï¼‰ =====
    // æ¾æ‘10ç¨®ï¼ˆä¾‹ï¼‰ã€‚æ‰‹å…ƒã®åå‰ã«åˆã‚ã›ã¦æ›¸ãæ›ãˆã¦OKã€‚
    const MATSU_VARIANTS = [
      "./assets/matsu_01.png",
      "./assets/matsu_02.png",
      "./assets/matsu_03.png",
      "./assets/matsu_04.png",
      "./assets/matsu_05.png",
      "./assets/matsu_06.png",
      "./assets/matsu_07.png",
      "./assets/matsu_08.png",
      "./assets/matsu_09.png",
      "./assets/matsu_10.png",
    ];

    // ç®±ç”»åƒï¼ˆç„¡ã‘ã‚Œã°é€æ˜ã«ãªã‚‹ã®ã§ã€ç”¨æ„ã—ã¦ã‚‹ãªã‚‰å…¥ã‚Œã¦ï¼‰
    const BOX_IMAGE = "./assets/box.png";

    // BGMï¼ˆ30ç§’ãƒ»ãƒ«ãƒ¼ãƒ—ãªã—ï¼‰
    const BGM_FILE = "./assets/bgm.mp3";

    // ===== è¨­å®š =====
    const GAME_SECONDS = 30.0;
    const TOTAL = 30;              // æ¾æ‘ç·æ•°
    const PER_VARIANT = 3;         // 10ç¨®é¡Ã—3ä½“ï¼30ä½“
    const DROP_TIGHTNESS = 0.88;   // ç®±ã®å£åˆ¤å®šã‚’å°‘ã—å³ã—ã‚ã«ï¼ˆ0.8ã€œ1.0ï¼‰

    // ===== DOM =====
    const stage = document.querySelector("#stage");
    const overlay = document.querySelector("#overlay");
    const startBtn = document.querySelector("#startBtn");
    const howBtn = document.querySelector("#howBtn");
    const help = document.querySelector("#help");

    const timeEl = document.querySelector("#time");
    const scoreEl = document.querySelector("#score");
    const totalEl = document.querySelector("#total");

    const boxEl = document.querySelector("#box");
    const mouthEl = document.querySelector("#mouth");
    const fillEl = document.querySelector("#fill");

    const bgm = document.querySelector("#bgm");
    const boxImg = document.querySelector("#boxImg");

    totalEl.textContent = String(TOTAL);

    // ç”»åƒã‚»ãƒƒãƒˆ
    boxImg.src = asset(BOX_IMAGE);
    bgm.src = asset(BGM_FILE);
    bgm.loop = false;

    // èƒŒæ™¯ç”»åƒã‚’å‹•çš„ã«è¨­å®šï¼ˆVercelç”¨ãƒ‘ã‚¹èª¿æ•´ï¼‰
    const bgImage = asset("./assets/bg.png");
    stage.style.backgroundImage = `linear-gradient(rgba(7,10,20,.35), rgba(7,10,20,.55)), url("${bgImage}")`;
    // iOS Safari å¯¾ç­–ï¼šãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—æ‹¡å¤§/ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æŠ‘æ­¢è£œå¼·
    document.addEventListener("gesturestart", (e) => e.preventDefault(), { passive:false });

    // ===== ã‚²ãƒ¼ãƒ çŠ¶æ…‹ =====
    let running = false;
    let tLeft = GAME_SECONDS;
    let startAt = 0;
    let rafId = 0;

    let delivered = 0;
    let items = []; // {el, alive}

    // ãƒ‰ãƒ©ãƒƒã‚°çŠ¶æ…‹
    let drag = null; // {id, el, offsetX, offsetY}

    function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }

    function setHUD(){
      timeEl.textContent = tLeft.toFixed(1);
      scoreEl.textContent = String(delivered);
      // fill
      const pct = (delivered / TOTAL) * 100;
      fillEl.style.height = `${pct}%`;
    }

    function clearStageItems(){
      for(const it of items){
        it.el.remove();
      }
      items = [];
      drag = null;
    }

    // ãƒ©ãƒ³ãƒ€ãƒ é…ç½®ï¼ˆè»½ã‚ã®è¡çªå›é¿ï¼‰
    function spawnItems(){
      const stageRect = stage.getBoundingClientRect();
      const boxRect = boxEl.getBoundingClientRect();

      const safeTop = 56; // HUDé¿ã‘
      const safeBottom = Math.max(120, (window.innerHeight - boxRect.top) + 18); // ç®±ã‚¨ãƒªã‚¢é¿ã‘
      const W = stageRect.width;
      const H = stageRect.height;

      // ç”Ÿæˆã™ã‚‹ç”»åƒãƒªã‚¹ãƒˆï¼š10ç¨®Ã—PER_VARIANT
      const sources = [];
      for(let i=0;i<MATSU_VARIANTS.length;i++){
        for(let k=0;k<PER_VARIANT;k++) sources.push(MATSU_VARIANTS[i]);
      }
      // ã‚·ãƒ£ãƒƒãƒ•ãƒ«
      for(let i=sources.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [sources[i], sources[j]] = [sources[j], sources[i]];
      }

      // ã‚µã‚¤ã‚ºã¯CSSåŸºæº–ã®å®Ÿå¯¸ã«åˆã‚ã›ã‚‹
      const probe = document.createElement("div");
      probe.className = "matsu";
      probe.style.left = "-9999px";
      probe.style.top = "-9999px";
      stage.appendChild(probe);
      const itemSize = probe.getBoundingClientRect().width;
      probe.remove();

      const placed = []; // {x,y}

      for(let n=0;n<TOTAL;n++){
        const el = document.createElement("div");
        el.className = "matsu";
        el.setAttribute("role","button");
        el.setAttribute("aria-label","æ¾æ‘");
        el.dataset.id = String(n);

        const img = document.createElement("img");
        img.alt = "æ¾æ‘";
        img.src = asset(sources[n % sources.length]);
        el.appendChild(img);

        // ä½ç½®æ±ºã‚ï¼šç®±ã®ä¸Šå´ã«æ•£ã‚‰ã°ã‚‰ã›ã‚‹
        let x=0,y=0;
        let tries = 0;
        while(true){
          tries++;
          x = Math.random()*(W - itemSize - 16) + 8;
          y = Math.random()*(H - safeTop - safeBottom - itemSize - 16) + safeTop + 8;

          // è¿‘ã™ãå›é¿ï¼ˆé›‘ï¼‰
          let ok = true;
          for(const p of placed){
            const dx = (p.x - x);
            const dy = (p.y - y);
            if(dx*dx + dy*dy < (itemSize*0.78)*(itemSize*0.78)){
              ok = false; break;
            }
          }
          if(ok || tries > 40) break;
        }
        placed.push({x,y});

        el.style.left = `${x}px`;
        el.style.top  = `${y}px`;

        stage.appendChild(el);
        items.push({el, alive:true});
      }
    }

    function mouthRectTight(){
      const r = mouthEl.getBoundingClientRect();
      // å°‘ã—åˆ¤å®šã‚’çµã‚‹ï¼ˆå³ã—ã‚ï¼‰
      const cx = (r.left + r.right)/2;
      const cy = (r.top + r.bottom)/2;
      const w = (r.width * DROP_TIGHTNESS);
      const h = (r.height * DROP_TIGHTNESS);
      return {
        left: cx - w/2,
        right: cx + w/2,
        top: cy - h/2,
        bottom: cy + h/2,
        cx, cy
      };
    }

    function pointInRect(x,y, r){
      return (x>=r.left && x<=r.right && y>=r.top && y<=r.bottom);
    }

    function shakeBox(){
      // ç®±ãŒé‡ããªã‚‹æ„Ÿã˜ï¼ˆå°‘ã—æ²ˆã¾ã›ã‚‹ï¼‰
      boxEl.style.transform = "translateY(3px) scale(0.998)";
      setTimeout(()=> boxEl.style.transform = "translateY(0) scale(1)", 120);
    }

    function endGame(){
      running = false;
      cancelAnimationFrame(rafId);

      // çµæœæ–‡
      const card = overlay.querySelector(".card");
      const old = card.querySelector(".result.end");
      if(old) old.remove();

      const res = document.createElement("div");
      res.className = "result end";

      if(delivered >= TOTAL){
        res.innerHTML =
          `ä»Šå¹´ã®æ¾æ‘ã¯<br><b style="color:var(--good)">ãã‚Œã„ã«ç´ã¾ã‚Šã¾ã—ãŸã€‚</b><br>æœ¬æ—¥ã€ä»•äº‹ç´ã‚ã€‚`;
      } else {
        res.innerHTML =
          `<b>${delivered}</b>ä½“ã®æ¾æ‘ã‚’ç´ã‚ã¾ã—ãŸã€‚<br>æ®‹ã‚Šã¯æ¥å¹´ã«æŒã¡è¶Šã—ã§ã™ã€‚`;
      }

      card.appendChild(res);

      // ãƒœã‚¿ãƒ³ã‚’ã€Œã‚‚ã†ä¸€å›ã€ã«å¤‰æ›´
      startBtn.textContent = "ã‚‚ã†ä¸€å›";
      overlay.style.display = "flex";

      // BGMåœæ­¢ï¼ˆè‡ªç„¶çµ‚äº†ã§ã‚‚OKã ãŒå¿µã®ãŸã‚ï¼‰
      try{
        bgm.pause();
        bgm.currentTime = 0;
      }catch(_){}

      // ã‚¢ã‚¤ãƒ†ãƒ æ®‹ã‚Šã¯ãã®ã¾ã¾ã§ã‚‚ã„ã„ãŒã€å†ã‚¹ã‚¿ãƒ¼ãƒˆæ™‚ã«ç”Ÿæˆã—ç›´ã™
    }

    function tick(now){
      if(!running) return;
      const elapsed = (now - startAt) / 1000;
      tLeft = clamp(GAME_SECONDS - elapsed, 0, GAME_SECONDS);
      setHUD();

      if(delivered >= TOTAL){
        endGame();
        return;
      }
      if(tLeft <= 0){
        endGame();
        return;
      }
      rafId = requestAnimationFrame(tick);
    }

    function startGame(){
      // åˆæœŸåŒ–
      clearStageItems();
      delivered = 0;
      tLeft = GAME_SECONDS;
      setHUD();

      // ç”Ÿæˆ
      spawnItems();

      // é–‹å§‹
      overlay.style.display = "none";
      running = true;
      startAt = performance.now();
      rafId = requestAnimationFrame(tick);

      // BGMï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œèµ·ç‚¹ã§å†ç”Ÿï¼‰
      bgm.currentTime = 0;
      bgm.play().catch(()=>{ /* ã‚µã‚¤ãƒ¬ãƒ³ãƒˆ */ });
    }

    // ===== Pointer drag =====
    function onPointerDown(e){
      if(!running) return;

      const target = e.target.closest(".matsu");
      if(!target) return;

      // å³ã‚¯ãƒªãƒƒã‚¯ç­‰ã‚’æŠ‘æ­¢
      e.preventDefault();

      // ã‚­ãƒ£ãƒ—ãƒãƒ£
      target.setPointerCapture(e.pointerId);

      // ä¸€ç•ªä¸Šã¸
      target.style.zIndex = "80";

      const rect = target.getBoundingClientRect();
      const ox = e.clientX - rect.left;
      const oy = e.clientY - rect.top;

      drag = {
        pid: e.pointerId,
        el: target,
        offsetX: ox,
        offsetY: oy
      };

      target.classList.add("grab");
    }

    function onPointerMove(e){
      if(!running) return;
      if(!drag || drag.pid !== e.pointerId) return;

      e.preventDefault();

      const el = drag.el;
      const stageRect = stage.getBoundingClientRect();
      const r = el.getBoundingClientRect();

      let x = e.clientX - stageRect.left - drag.offsetX;
      let y = e.clientY - stageRect.top  - drag.offsetY;

      // ç”»é¢å¤–ã«å‡ºã—ã™ããªã„
      x = clamp(x, -10, stageRect.width - r.width + 10);
      y = clamp(y,  40, stageRect.height - r.height + 10);

      el.style.left = `${x}px`;
      el.style.top  = `${y}px`;
    }

    function deliver(el){
      // ã‚‚ã†æ“ä½œã§ããªã„
      el.style.pointerEvents = "none";
      el.classList.remove("grab");
      el.classList.add("snap");

      const mr = mouthRectTight();
      const stageRect = stage.getBoundingClientRect();
      const rect = el.getBoundingClientRect();

      // å£ã®ä¸­å¿ƒã¸å¸ã„è¾¼ã¿
      const centerX = mr.cx - stageRect.left - rect.width/2;
      const centerY = mr.cy - stageRect.top  - rect.height/2;

      el.style.left = `${centerX}px`;
      el.style.top  = `${centerY}px`;
      el.style.transform = "scale(0.35)";
      el.style.opacity = "0.0";

      delivered++;
      setHUD();
      shakeBox();

      // å°‘ã—å¾…ã£ã¦å‰Šé™¤
      setTimeout(()=> el.remove(), 160);
    }

    function onPointerUp(e){
      if(!running) return;
      if(!drag || drag.pid !== e.pointerId) return;

      e.preventDefault();

      const el = drag.el;
      drag = null;

      el.classList.remove("grab");
      el.releasePointerCapture?.(e.pointerId);

      // è½ã¨ã—åˆ¤å®šï¼šè¦ç´ ã®ä¸­å¿ƒç‚¹ãŒç®±å£ã«å…¥ã£ã¦ã„ãŸã‚‰ç´å“
      const rect = el.getBoundingClientRect();
      const cx = rect.left + rect.width/2;
      const cy = rect.top  + rect.height/2;
      const mr = mouthRectTight();

      if(pointInRect(cx, cy, mr)){
        deliver(el);
      } else {
        // æˆ»ã—æ¼”å‡ºï¼ˆè»½ãï¼‰
        el.classList.add("snap");
        el.style.transform = "scale(1)";
        el.style.opacity = "1";
        // ã—ã°ã‚‰ãã—ã¦ snap ã‚’å¤–ã™
        setTimeout(()=> el.classList.remove("snap"), 160);
        el.style.zIndex = "10";
      }
    }

    function onPointerCancel(e){
      if(!drag || drag.pid !== e.pointerId) return;
      drag.el.classList.remove("grab");
      drag = null;
    }

    stage.addEventListener("pointerdown", onPointerDown, { passive:false });
    stage.addEventListener("pointermove", onPointerMove, { passive:false });
    stage.addEventListener("pointerup", onPointerUp, { passive:false });
    stage.addEventListener("pointercancel", onPointerCancel, { passive:false });

    // ===== UI =====
    howBtn.addEventListener("click", ()=>{
      help.style.display = (help.style.display === "none") ? "block" : "none";
    });

    startBtn.addEventListener("click", ()=>{
      startGame();
    });

    // åˆæœŸHUD
    setHUD();

    // ç”»é¢å›è»¢/ãƒªã‚µã‚¤ã‚ºæ™‚ï¼šã‚²ãƒ¼ãƒ ä¸­ã¯ä¸åˆ©ãªã®ã§ã€å½“ãŸã‚Šåˆ¤å®šãŒã‚ºãƒ¬ãªã„ã‚ˆã†ã«çµ‚äº†æ‰±ã„ã«ã™ã‚‹
    let resizeTimer = 0;
    window.addEventListener("resize", ()=>{
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(()=>{
        if(running){
          endGame();
        }
      }, 120);
    }, { passive:true });
  </script>
</body>
</html>
